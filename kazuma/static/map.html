<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grid Siting - Map View</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <link href="/static/output.css" rel="stylesheet">
    
    <style>
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 360px; background: rgba(243, 231, 232, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 10; overflow-y: auto; box-shadow: 2px 0 12px rgba(0,0,0,0.4); border-right: 1px solid rgba(206, 152, 157, 0.2); }
        .map-container { position: absolute; left: 360px; top: 0; bottom: 0; right: 0; }
        .filter-group { padding: 16px; border-bottom: 1px solid rgba(206, 152, 157, 0.2); }
        .filter-checkbox { display: flex; align-items: center; padding: 8px 0; cursor: pointer; }
        .filter-checkbox input { margin-right: 10px; cursor: pointer; accent-color: #CE989D; }
        .legend-item { display: flex; align-items: center; padding: 6px 0; font-size: 13px; }
        .legend-color { width: 16px; height: 16px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .preview-box { position: absolute; top: 20px; right: 20px; background: rgba(243, 231, 232, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 5; max-width: 340px; display: none; border: 1px solid rgba(206, 152, 157, 0.3); }
        .stat-badge { display: inline-block; padding: 4px 12px; border-radius: 14px; font-size: 11px; font-weight: 600; }
    </style>
</head>
<body style="background-color: #0A0506;">
    <!-- Left Sidebar -->
    <div class="sidebar shadow-lg">
        <div class="p-6 border-b" style="background-color: #CE989D;">
            <h1 class="text-xl font-bold" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Smart Grid Siting</h1>
            <p class="text-sm mt-1" style="color: #1C0D0E; opacity: 0.85;">Interactive Map View</p>
        </div>
        
        <!-- Map Layers Control -->
        <div class="filter-group">
            <h3 class="font-semibold mb-3 text-sm" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Map Layers</h3>
            <label class="filter-checkbox">
                <input type="checkbox" id="toggle-grid-nodes" checked>
                <span class="text-sm" style="color: #2D1517;">Grid Nodes (40)</span>
            </label>
            <label class="filter-checkbox">
                <input type="checkbox" id="toggle-power-plants" checked>
                <span class="text-sm" style="color: #2D1517;">Power Plants (<span id="plant-count">0</span>)</span>
            </label>
        </div>
        
        <!-- Click-to-Evaluate Info -->
        <div class="filter-group" style="background-color: rgba(206, 152, 157, 0.15); border-left: 3px solid #CE989D;">
            <h3 class="font-semibold mb-2 text-sm" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Right-Click to Evaluate</h3>
            <p class="text-xs" style="color: #3D2224;">
                Right-click anywhere on the map to evaluate that location's siting potential
            </p>
        </div>
        
        <!-- Power Plants Filter -->
        <div class="filter-group">
            <h3 class="font-semibold mb-3 text-sm" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Power Plants Filter</h3>
            
            <label class="filter-checkbox">
                <input type="checkbox" id="filter-renewable" checked>
                <span class="text-sm" style="color: #2D1517;">Clean Energy Only</span>
            </label>
            
            <div class="mt-2 text-xs italic" style="color: #6D5557;">
                Only Wind, Solar, Hydro, and Geothermal count as clean
            </div>
        </div>
        
        <!-- Grid Nodes Legend -->
        <div class="filter-group">
            <h3 class="font-semibold mb-3 text-sm" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Grid Nodes (Clean Gen Score)</h3>
            <div class="space-y-1">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #A3D9A5;"></div>
                    <span style="color: #2D1517; font-size: 13px;">80-100: Excellent</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E8C4A8;"></div>
                    <span style="color: #2D1517; font-size: 13px;">60-79: Good</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #DBA895;"></div>
                    <span style="color: #2D1517; font-size: 13px;">40-59: Moderate</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #CE989D;"></div>
                    <span style="color: #2D1517; font-size: 13px;">0-39: Limited</span>
                </div>
            </div>
        </div>
        
        <!-- Power Plants Legend -->
        <div class="filter-group">
            <h3 class="font-semibold mb-3 text-sm" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Clean Energy Sources</h3>
            <div class="space-y-1 mb-2">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E8D4A8;"></div>
                    <span style="color: #2D1517; font-size: 13px;">Solar</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #A3D9C2;"></div>
                    <span style="color: #2D1517; font-size: 13px;">Wind</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9BC4E8;"></div>
                    <span style="color: #2D1517; font-size: 13px;">Hydro</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #B5A3D9;"></div>
                    <span style="color: #2D1517; font-size: 13px;">Geothermal</span>
                </div>
            </div>
            <div class="text-xs pt-2" style="border-top: 1px solid rgba(206, 152, 157, 0.2);">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #8D7E80;"></div>
                    <span style="color: #6D5557; font-size: 13px;">Non-clean (excluded)</span>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="filter-group" style="background-color: rgba(163, 217, 194, 0.15); border-left: 3px solid #A3D9C2;">
            <h3 class="font-semibold mb-3 text-sm" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Clean Energy Statistics</h3>
            <div class="space-y-2 text-xs">
                <div class="flex justify-between">
                    <span style="color: #3D2224;">Total Plants:</span>
                    <span id="stat-total" class="font-semibold" style="color: #2D1517;">-</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: #3D2224;">Clean Energy:</span>
                    <span id="stat-clean" class="font-semibold" style="color: #A3D9C2;">-</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: #3D2224;">Clean Capacity:</span>
                    <span id="stat-capacity" class="font-semibold" style="color: #A3D9C2;">-</span>
                </div>
            </div>
            <div class="mt-2 pt-2 text-xs italic" style="border-top: 1px solid rgba(206, 152, 157, 0.2); color: #6D5557;">
                Only Wind, Solar, Hydro, Geothermal sources
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="p-4 text-xs" style="background-color: rgba(206, 152, 157, 0.1); color: #2D1517;">
            <p class="font-semibold mb-2" style="font-family: 'Space Grotesk', sans-serif;">How to use:</p>
            <ol class="list-decimal list-inside space-y-1">
                <li>Enable "Right-Click to Evaluate" above</li>
                <li><strong>Right-click</strong> anywhere to evaluate location</li>
                <li><strong>Left-click</strong> nodes/plants for details</li>
                <li>View calculated siting scores instantly</li>
            </ol>
        </div>
    </div>
    
    <!-- Map Container -->
    <div class="map-container">
        <div id="map"></div>
        
        <!-- Preview Box (appears on click) -->
        <div id="preview-box" class="preview-box">
            <button id="close-preview" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-xl leading-none">&times;</button>
            <div id="preview-content">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>
    
    <script>
        let map;
        let mapboxToken = '';
        let currentFilters = {
            renewableOnly: true
        };
        let evaluationMarker = null;  // Track marker for clicked location
        
        // Initialize map
        async function initMap() {
            try {
                // Get config
                const response = await fetch('/api/config');
                const config = await response.json();
                mapboxToken = config.mapbox_token;
                
                // Check if Mapbox token is set
                if (!mapboxToken || mapboxToken === '') {
                    console.error('Mapbox token not configured');
                    document.getElementById('map').innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f3f4f6; padding: 40px; text-align: center;">
                            <div>
                                <h2 style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 16px;">Mapbox Token Required</h2>
                                <p style="color: #6b7280; margin-bottom: 8px;">Set the MAPBOX_TOKEN environment variable to display the map.</p>
                                <p style="color: #9ca3af; font-size: 14px;">Get a free token at <a href="https://mapbox.com" target="_blank" style="color: #3b82f6;">mapbox.com</a></p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                mapboxgl.accessToken = mapboxToken;
                
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: config.default_center,
                    zoom: config.default_zoom
                });
                
                map.on('load', async () => {
                    await loadPowerPlants();
                    await loadGridNodes();
                    await loadStats();
                    
                    // Add right-click handler for map (for location evaluation)
                    map.on('contextmenu', handleMapRightClick);
                });
                
            } catch (error) {
                console.error('Error initializing map:', error);
                document.getElementById('map').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #fef2f2; padding: 40px; text-align: center;">
                        <div>
                            <h2 style="font-size: 24px; font-weight: bold; color: #991b1b; margin-bottom: 16px;">Error Loading Map</h2>
                            <p style="color: #7f1d1d;">${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        
        // Load power plants
        async function loadPowerPlants() {
            try {
                const params = new URLSearchParams();
                if (currentFilters.renewableOnly) {
                    params.append('renewable_only', 'true');
                }
                
                const response = await fetch(`/api/power-plants/geojson?${params}`);
                const geojson = await response.json();
                
                console.log(`Loaded ${geojson.features.length} power plants (clean energy filter: ${currentFilters.renewableOnly})`);
                document.getElementById('plant-count').textContent = geojson.features.length.toLocaleString();
                
                // Update or add source - setData() triggers re-render automatically
                if (map.getSource('power-plants')) {
                    map.getSource('power-plants').setData(geojson);
                } else {
                    map.addSource('power-plants', {
                        type: 'geojson',
                        data: geojson,
                        cluster: true,
                        clusterMaxZoom: 10,
                        clusterRadius: 50
                    });
                    
                    addPowerPlantLayers();
                }
                
            } catch (error) {
                console.error('Error loading power plants:', error);
            }
        }
        
        // Add Mapbox layers for power plants
        function addPowerPlantLayers() {
            // Clusters
            map.addLayer({
                id: 'power-plants-clusters',
                type: 'circle',
                source: 'power-plants',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': '#6b7280',
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        15, 10,
                        20, 50,
                        25, 100,
                        30
                    ],
                    'circle-opacity': 0.7,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });
            
            // Cluster count
            map.addLayer({
                id: 'power-plants-cluster-count',
                type: 'symbol',
                source: 'power-plants',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-size': 12,
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold']
                },
                paint: {
                    'text-color': '#fff'
                }
            });
            
            // Individual plants
            map.addLayer({
                id: 'power-plants-points',
                type: 'circle',
                source: 'power-plants',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'nameplate_mw'],
                        0, 3,
                        10, 5,
                        100, 7,
                        500, 10
                    ],
                    'circle-color': ['get', 'fuel_color'],
                    'circle-opacity': 0.8,
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#fff'
                }
            });
            
            // Click handlers
            map.on('click', 'power-plants-points', handlePowerPlantClick);
            map.on('click', 'power-plants-clusters', handleClusterClick);
            
            // Hover cursor
            map.on('mouseenter', 'power-plants-points', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'power-plants-points', () => {
                map.getCanvas().style.cursor = '';
            });
        }
        
        // Load grid nodes
        async function loadGridNodes() {
            try {
                const response = await fetch('/api/grid/nodes/geojson');
                const geojson = await response.json();
                
                console.log(`Loaded ${geojson.features.length} grid nodes`);
                
                // Add source
                map.addSource('grid-nodes', {
                    type: 'geojson',
                    data: geojson
                });
                
                // Add layers
                map.addLayer({
                    id: 'grid-nodes-circle',
                    type: 'circle',
                    source: 'grid-nodes',
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['get', 'clean_gen'],
                            0, 10,
                            100, 20
                        ],
                        'circle-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'clean_gen'],
                            0, '#CE989D',
                            40, '#DBA895',
                            60, '#E8C4A8',
                            80, '#A3D9A5'
                        ],
                        'circle-opacity': 0.8,
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#fff'
                    }
                });
                
                map.addLayer({
                    id: 'grid-nodes-label',
                    type: 'symbol',
                    source: 'grid-nodes',
                    layout: {
                        'text-field': ['get', 'name'],
                        'text-size': 11,
                        'text-offset': [0, 2],
                        'text-anchor': 'top'
                    },
                    paint: {
                        'text-color': '#374151',
                        'text-halo-color': '#fff',
                        'text-halo-width': 2
                    }
                });
                
                map.on('click', 'grid-nodes-circle', handleGridNodeClick);
                map.on('mouseenter', 'grid-nodes-circle', () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                map.on('mouseleave', 'grid-nodes-circle', () => {
                    map.getCanvas().style.cursor = '';
                });
                
            } catch (error) {
                console.error('Error loading grid nodes:', error);
            }
        }
        
        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/power-plants/stats');
                const data = await response.json();
                
                document.getElementById('stat-total').textContent = data.total_plants.toLocaleString();
                document.getElementById('stat-clean').textContent = 
                    `${data.clean_count.toLocaleString()} (${data.clean_percentage}%)`;
                
                // Only count clean energy capacity
                const cleanCapacity = Object.entries(data.by_fuel_category)
                    .filter(([cat, info]) => info.is_clean)
                    .reduce((sum, [cat, info]) => sum + info.total_capacity_mw, 0);
                
                document.getElementById('stat-capacity').textContent = 
                    `${(cleanCapacity / 1000).toFixed(1)} GW`;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // Handle filter changes
        function handleFilterChange() {
            const renewableCheckbox = document.getElementById('filter-renewable');
            currentFilters.renewableOnly = renewableCheckbox.checked;
            
            console.log('Filters updated:', currentFilters);
            
            loadPowerPlants();
            loadStats();
        }
        
        // Handle cluster click (zoom in)
        function handleClusterClick(e) {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['power-plants-clusters']
            });
            const clusterId = features[0].properties.cluster_id;
            map.getSource('power-plants').getClusterExpansionZoom(
                clusterId,
                (err, zoom) => {
                    if (err) return;
                    map.easeTo({
                        center: features[0].geometry.coordinates,
                        zoom: zoom
                    });
                }
            );
        }
        
        // Handle power plant click
        function handlePowerPlantClick(e) {
            const props = e.features[0].properties;
            
            const content = `
                <div style="color: #1C0D0E;">
                    <div class="mb-3">
                        <h3 class="font-bold text-lg" style="font-family: 'Space Grotesk', sans-serif; color: #1C0D0E;">${props.plant_name}</h3>
                        <div class="text-xs" style="color: #6D5557; margin-top: 4px;">${props.primary_fuel_category}</div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span style="color: #6D5557;">Fuel Type:</span>
                            <span class="font-semibold" style="color: ${props.fuel_color}">
                                ${props.primary_fuel_category}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: #6D5557;">Capacity:</span>
                            <span class="font-semibold" style="color: #CE989D;">${props.nameplate_mw} MW</span>
                        </div>
                        <div class="flex justify-between">
                            <span style="color: #6D5557;">Annual Gen:</span>
                            <span class="font-semibold" style="color: #CE989D;">${(props.annual_net_gen_mwh / 1000).toFixed(1)} GWh</span>
                        </div>
                        ${props.is_clean ? 
                            '<div class="stat-badge mt-3" style="background-color: rgba(163, 217, 165, 0.3); color: #2D5F32;">Clean Energy</div>' : 
                            '<div class="stat-badge mt-3" style="background-color: rgba(141, 126, 128, 0.3); color: #3D2224;">Non-Clean</div>'}
                    </div>
                </div>
            `;
            
            showPreview(content);
        }
        
        // Handle grid node click
        function handleGridNodeClick(e) {
            const props = e.features[0].properties;
            
            const compositeScore = (
                props.clean_gen * 0.4 +
                props.transmission_headroom * 0.3 +
                props.reliability * 0.3
            ).toFixed(1);
            
            const content = `
                <div>
                    <h3 class="font-bold text-lg mb-2">${props.name}</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <div>
                            <div class="text-gray-500 text-xs">Clean Gen</div>
                            <div class="font-semibold text-green-600">${props.clean_gen}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Transmission</div>
                            <div class="font-semibold text-blue-600">${props.transmission_headroom}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Reliability</div>
                            <div class="font-semibold text-purple-600">${props.reliability}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Composite</div>
                            <div class="font-semibold text-gray-800">${compositeScore}</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 border-t pt-2">
                        <div>${props.region || 'N/A'}</div>
                        <div>${props.state || 'N/A'}</div>
                    </div>
                    <button onclick="window.location.href='/framework?site_id=${props.id}'" 
                            class="mt-3 w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-medium text-sm">
                        Evaluate Site →
                    </button>
                </div>
            `;
            
            showPreview(content);
        }
        
        // Show preview box
        function showPreview(content) {
            document.getElementById('preview-content').innerHTML = content;
            document.getElementById('preview-box').style.display = 'block';
        }
        
        // Handle map right-click for location evaluation
        async function handleMapRightClick(e) {
            // Prevent default context menu
            e.preventDefault();
            
            // Extract coordinates from Mapbox event
            // Mapbox returns lngLat object with lng and lat properties
            const lng = e.lngLat.lng;
            const lat = e.lngLat.lat;
            
            console.log(`Right-clicked at: lat=${lat}, lng=${lng}`);
            console.log('Full event:', e);
            
            // Validate coordinates
            if (isNaN(lat) || isNaN(lng)) {
                console.error('Invalid coordinates from Mapbox event:', e.lngLat);
                alert('Could not get valid coordinates from map click');
                return;
            }
            
            console.log(`Evaluating location: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            
            // Show loading indicator
            showPreview(`
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Evaluating location...</p>
                    <p class="text-xs text-gray-500 mt-2">Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</p>
                </div>
            `);
            
            try {
                // Call API to evaluate this location
                const requestBody = {
                    latitude: lat,
                    longitude: lng,
                    weight_clean: 0.4,
                    weight_transmission: 0.3,
                    weight_reliability: 0.3
                };
                
                console.log('Sending request:', requestBody);
                
                const response = await fetch('/api/siting/evaluate-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const evaluation = await response.json();
                console.log('Evaluation result:', evaluation);
                
                // Remove previous marker if exists
                if (evaluationMarker) {
                    evaluationMarker.remove();
                }
                
                // Add marker at clicked location
                evaluationMarker = new mapboxgl.Marker({
                    color: '#3b82f6',
                    scale: 0.8
                })
                    .setLngLat([lng, lat])
                    .addTo(map);
                
                // Display evaluation results
                displayLocationEvaluation(evaluation, lat, lng);
                
            } catch (error) {
                console.error('Error evaluating location:', error);
                showPreview(`
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">⚠️</div>
                        <h3 class="font-bold text-red-600 mb-2">Evaluation Failed</h3>
                        <p class="text-sm text-gray-600 mb-2">${error.message}</p>
                        <p class="text-xs text-gray-500">Check browser console for details</p>
                        <button onclick="document.getElementById('preview-box').style.display='none'" 
                                class="mt-4 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 text-sm">
                            Close
                        </button>
                    </div>
                `);
            }
        }
        
        // Display location evaluation results
        function displayLocationEvaluation(evaluation, lat, lng) {
            const scores = evaluation.score_breakdown;
            
            // Determine score color
            const getScoreColor = (score) => {
                if (score >= 80) return 'text-green-600';
                if (score >= 60) return 'text-yellow-600';
                if (score >= 40) return 'text-orange-600';
                return 'text-red-600';
            };
            
            const content = `
                <div style="color: #1C0D0E;">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-lg" style="font-family: 'Space Grotesk', sans-serif; color: #1C0D0E;">Location Evaluation</h3>
                        <span class="text-xs" style="color: #6D5557;">${lat.toFixed(4)}, ${lng.toFixed(4)}</span>
                    </div>
                    
                    <div class="mb-4 p-4 rounded" style="background-color: rgba(206, 152, 157, 0.15); border: 2px solid #CE989D;">
                        <div class="text-xs mb-1" style="color: #6D5557;">Composite Score</div>
                        <div class="text-3xl font-bold" style="color: #CE989D;">
                            ${scores.composite_score}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-sm mb-3">
                        <div class="text-center p-2 rounded" style="background-color: rgba(163, 217, 165, 0.15);">
                            <div class="text-xs" style="color: #6D5557;">Clean Gen</div>
                            <div class="font-semibold" style="color: #A3D9A5;">${scores.clean_gen_score}</div>
                        </div>
                        <div class="text-center p-2 rounded" style="background-color: rgba(155, 196, 232, 0.15);">
                            <div class="text-xs" style="color: #6D5557;">Transmission</div>
                            <div class="font-semibold" style="color: #9BC4E8;">${scores.transmission_score}</div>
                        </div>
                        <div class="text-center p-2 rounded" style="background-color: rgba(181, 163, 217, 0.15);">
                            <div class="text-xs" style="color: #6D5557;">Reliability</div>
                            <div class="font-semibold" style="color: #B5A3D9;">${scores.reliability_score}</div>
                        </div>
                    </div>
                    
                    <div class="text-xs pt-2 space-y-1" style="border-top: 1px solid rgba(206, 152, 157, 0.2); color: #3D2224;">
                        ${evaluation.evaluation_notes.map(note => `<div>• ${note}</div>`).join('')}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <button onclick="clearEvaluationMarker()" 
                                style="background-color: #8D7E80; color: #F3E7E8; padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 14px; border: none; cursor: pointer;"
                                onmouseover="this.style.backgroundColor='#6D5E60'"
                                onmouseout="this.style.backgroundColor='#8D7E80'">
                            Clear
                        </button>
                        <button onclick="evaluateInFramework(${lat}, ${lng})" 
                                style="background-color: #CE989D; color: #1C0D0E; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 14px; border: none; cursor: pointer;"
                                onmouseover="this.style.backgroundColor='#B87F84'"
                                onmouseout="this.style.backgroundColor='#CE989D'">
                            Evaluate Site →
                        </button>
                    </div>
                </div>
            `;
            
            showPreview(content);
        }
        
        // Navigate to framework page with coordinates
        function evaluateInFramework(lat, lng) {
            // Store coordinates in sessionStorage for framework page to pick up
            sessionStorage.setItem('customLocation', JSON.stringify({ latitude: lat, longitude: lng }));
            window.location.href = '/framework';
        }
        
        // Clear evaluation marker
        function clearEvaluationMarker() {
            if (evaluationMarker) {
                evaluationMarker.remove();
                evaluationMarker = null;
            }
            document.getElementById('preview-box').style.display = 'none';
        }
        
        // Layer toggles
        document.getElementById('toggle-grid-nodes').addEventListener('change', (e) => {
            const visibility = e.target.checked ? 'visible' : 'none';
            map.setLayoutProperty('grid-nodes-circle', 'visibility', visibility);
            map.setLayoutProperty('grid-nodes-label', 'visibility', visibility);
        });
        
        document.getElementById('toggle-power-plants').addEventListener('change', (e) => {
            const visibility = e.target.checked ? 'visible' : 'none';
            map.setLayoutProperty('power-plants-points', 'visibility', visibility);
            map.setLayoutProperty('power-plants-clusters', 'visibility', visibility);
            map.setLayoutProperty('power-plants-cluster-count', 'visibility', visibility);
        });
        
        document.getElementById('filter-renewable').addEventListener('change', handleFilterChange);
        
        document.getElementById('close-preview').addEventListener('click', () => {
            document.getElementById('preview-box').style.display = 'none';
        });
        
        // Initialize
        initMap();
    </script>
</body>
</html>

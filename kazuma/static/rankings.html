<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Emissions Policy Tool - Rankings & Tables</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/output.css" rel="stylesheet">
</head>
<body class="bg-background font-sans antialiased" data-page="rankings">
    <!-- Header Container (loaded dynamically) -->
    <div id="header-container"></div>

    <!-- Main Container -->
    <div class="flex flex-col h-[calc(100vh-130px)]">
        <!-- Content Area with 2-column layout -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Left Sidebar: Filters -->
            <aside class="w-80 border-r bg-card overflow-y-auto">
                <div class="p-6 space-y-6">
                    <!-- Filters Section -->
                    <div>
                        <h2 class="text-lg font-semibold text-foreground mb-4">Table Filters</h2>
                        
                        <!-- Industry Filter -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-foreground mb-2">Industry Type</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2 text-sm text-foreground">
                                    <input type="checkbox" name="industry" value="steel" checked class="rounded">
                                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                    Steel Manufacturing
                                </label>
                                <label class="flex items-center gap-2 text-sm text-foreground">
                                    <input type="checkbox" name="industry" value="cement" checked class="rounded">
                                    <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                                    Cement Production
                                </label>
                                <label class="flex items-center gap-2 text-sm text-foreground">
                                    <input type="checkbox" name="industry" value="chemicals" checked class="rounded">
                                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                    Chemical Manufacturing
                                </label>
                            </div>
                        </div>

                        <!-- State Filter -->
                        <div class="mb-4">
                            <label for="state-filter" class="block text-sm font-medium text-foreground mb-2">State</label>
                            <select id="state-filter" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                <option value="">All States</option>
                                <option value="TX">Texas</option>
                                <option value="CA">California</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="IN">Indiana</option>
                                <option value="OH">Ohio</option>
                                <option value="IL">Illinois</option>
                                <option value="MI">Michigan</option>
                                <option value="LA">Louisiana</option>
                                <option value="AL">Alabama</option>
                            </select>
                        </div>

                        <!-- Year Filter -->
                        <div class="mb-4">
                            <label for="year-filter" class="block text-sm font-medium text-foreground mb-2">Reporting Year</label>
                            <select id="year-filter" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                <option value="2023">2023</option>
                                <option value="2022" selected>2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                            </select>
                        </div>

                        <!-- Sort By -->
                        <div class="mb-4">
                            <label for="sort-by" class="block text-sm font-medium text-foreground mb-2">Sort By</label>
                            <select id="sort-by" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                <option value="emissions-desc" selected>Emissions (High to Low)</option>
                                <option value="emissions-asc">Emissions (Low to High)</option>
                                <option value="name-asc">Facility Name (A-Z)</option>
                                <option value="name-desc">Facility Name (Z-A)</option>
                                <option value="carbon-cost-desc">Carbon Cost (High to Low)</option>
                                <option value="carbon-cost-asc">Carbon Cost (Low to High)</option>
                            </select>
                        </div>

                        <!-- Results Per Page -->
                        <div class="mb-4">
                            <label for="results-per-page" class="block text-sm font-medium text-foreground mb-2">Results Per Page</label>
                            <select id="results-per-page" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="250">250</option>
                            </select>
                        </div>

                        <!-- Apply Filters Button -->
                        <button id="apply-filters-btn" class="w-full rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90">
                            Apply Filters
                        </button>
                    </div>

                    <!-- Policy Parameters (for calculating carbon cost) -->
                    <div>
                        <h2 class="text-lg font-semibold text-foreground mb-4">Policy Settings</h2>
                        
                        <!-- Carbon Tax Rate -->
                        <div class="mb-4">
                            <label for="tax-rate" class="block text-sm font-medium text-foreground mb-2">
                                Carbon Tax Rate: <span id="tax-rate-value" class="text-primary">$100</span>
                            </label>
                            <input type="range" id="tax-rate" min="0" max="200" value="100" step="10"
                                   class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-muted">
                        </div>

                        <!-- Abatement Rate -->
                        <div class="mb-4">
                            <label for="abatement-rate" class="block text-sm font-medium text-foreground mb-2">
                                Abatement Rate: <span id="abatement-rate-value" class="text-primary">20%</span>
                            </label>
                            <input type="range" id="abatement-rate" min="0" max="40" value="20" step="5"
                                   class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-muted">
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div>
                        <h2 class="text-lg font-semibold text-foreground mb-4">Export Data</h2>
                        <button id="export-csv-btn" class="w-full rounded-md border border-input bg-background px-4 py-2 text-sm font-medium hover:bg-accent">
                            Export as CSV
                        </button>
                    </div>
                </div>
                    <div>
                        <h2 class="text-lg font-semibold text-foreground mb-4">Energy Scenario Parameters</h2>
                    </div>

                    <!-- Electric Vehicles -->
                    <div class="space-y-2">
                        <label for="num-evs" class="text-sm font-medium text-foreground">Electric Vehicles (EVs)</label>
                        <input
                            type="range"
                            id="num-evs"
                            min="0"
                            max="10"
                            value="0"
                            step="1"
                            class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary"
                        >
                        <span class="text-sm text-muted-foreground" id="num-evs-value">0</span>
                    </div>

                    <!-- Solar PV Capacity -->
                    <div class="space-y-2">
                        <label for="pv-capacity" class="text-sm font-medium text-foreground">Solar PV Capacity (kW)</label>
                        <input
                            type="range"
                            id="pv-capacity"
                            min="0"
                            max="20"
                            value="0"
                            step="0.5"
                            class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary"
                        >
                        <span class="text-sm text-muted-foreground" id="pv-capacity-value">0</span>
                    </div>

                    <!-- Heat Pumps -->
                    <div class="space-y-2">
                        <label for="num-heat-pumps" class="text-sm font-medium text-foreground">Heat Pumps</label>
                        <input
                            type="range"
                            id="num-heat-pumps"
                            min="0"
                            max="5"
                            value="0"
                            step="1"
                            class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary"
                        >
                        <span class="text-sm text-muted-foreground" id="num-heat-pumps-value">0</span>
                    </div>

                    <!-- Insulation Level -->
                    <div class="space-y-2">
                        <label for="insulation-level" class="text-sm font-medium text-foreground">Insulation Level</label>
                        <select
                            id="insulation-level"
                            class="w-full px-3 py-2 text-sm bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                        >
                            <option value="standard">Standard</option>
                            <option value="improved">Improved</option>
                            <option value="high">High Performance</option>
                        </select>
                    </div>

                    <!-- Building Type -->
                    <div class="space-y-2">
                        <label for="building-type" class="text-sm font-medium text-foreground">Building Type</label>
                        <select
                            id="building-type"
                            class="w-full px-3 py-2 text-sm bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                        >
                            <option value="residential">Residential</option>
                            <option value="commercial">Commercial</option>
                        </select>
                    </div>

                    <!-- Square Footage -->
                    <div class="space-y-2">
                        <label for="square-footage" class="text-sm font-medium text-foreground">Square Footage</label>
                        <input
                            type="number"
                            id="square-footage"
                            value="2000"
                            min="500"
                            max="50000"
                            step="100"
                            class="w-full px-3 py-2 text-sm bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                        >
                    </div>

                    <!-- Calculate Button -->
                    <button
                        id="calculate-btn"
                        class="w-full px-4 py-2 text-sm font-medium text-primary-foreground bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Calculate Impact
                    </button>

                    <!-- Loading -->
                    <div id="loading" class="hidden text-center py-4">
                        <p class="text-sm text-muted-foreground">⏳ Calculating...</p>
                    </div>

                    <!-- Results -->
                    <div id="results" class="hidden space-y-4">
                        <h3 class="text-base font-semibold text-foreground">Results</h3>
                        <div class="rounded-lg border bg-card p-4 space-y-3">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-muted-foreground">Annual Energy Usage</span>
                                <span class="font-medium text-foreground" id="result-usage">-</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-t pt-3">
                                <span class="text-muted-foreground">Annual Cost</span>
                                <span class="font-medium text-foreground" id="result-cost">-</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-t pt-3">
                                <span class="text-muted-foreground">Annual Emissions</span>
                                <span class="font-medium text-foreground" id="result-emissions">-</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-t pt-3">
                                <span class="text-muted-foreground">Peak Demand</span>
                                <span class="font-medium text-foreground" id="result-peak">-</span>
                            </div>
                            <div class="flex justify-between items-center text-sm border-t pt-3">
                                <span class="text-muted-foreground">Renewable %</span>
                                <span class="font-medium text-foreground" id="result-renewable">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Debug panel (now inside scrollable area) -->
                    <div>
                        <div id="integration-panel" class="rounded-lg border p-3 bg-card">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-foreground">Integrations & Debug</h3>
                                <button
                                    id="integration-toggle"
                                    aria-expanded="false"
                                    class="text-xs text-muted-foreground px-2 py-1 rounded hover:bg-muted"
                                    title="Toggle"
                                >+</button>
                            </div>
                            <div id="integration-status" class="hidden text-sm text-muted-foreground mt-2 space-y-1">
                                <div>Mapbox Token: <span id="mapbox-token-status">checking…</span></div>
                                <div>Map Loaded: <span id="map-loaded-status">no</span></div>
                                <div>Palmetto API: <span id="palmetto-status">checking…</span></div>
                                <div>Server Health: <span id="server-health-status">checking…</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Right Content: Table -->
            <main class="flex-1 bg-muted overflow-auto">
                <div class="p-6">
                <!-- Header with summary stats -->
                <div class="bg-card rounded-lg border shadow-sm p-4 mb-4">
                    <div class="grid grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm text-muted-foreground">Total Facilities</div>
                            <div class="text-2xl font-semibold text-foreground" id="total-facilities">0</div>
                        </div>
                        <div>
                            <div class="text-sm text-muted-foreground">Total Emissions</div>
                            <div class="text-2xl font-semibold text-foreground" id="total-emissions">0 MT</div>
                        </div>
                        <div>
                            <div class="text-sm text-muted-foreground">Total Carbon Cost</div>
                            <div class="text-2xl font-semibold text-foreground" id="total-carbon-cost">$0</div>
                        </div>
                        <div>
                            <div class="text-sm text-muted-foreground">Page</div>
                            <div class="text-2xl font-semibold text-foreground">
                                <span id="current-page">1</span> of <span id="total-pages">1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-card rounded-lg border shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-muted border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider cursor-pointer hover:bg-accent" data-sort="rank">
                                        Rank
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider cursor-pointer hover:bg-accent" data-sort="name">
                                        Facility Name
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider cursor-pointer hover:bg-accent" data-sort="industry">
                                        Industry
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider cursor-pointer hover:bg-accent" data-sort="state">
                                        State
                                    </th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider cursor-pointer hover:bg-accent" data-sort="emissions">
                                        Emissions (MT CO₂e)
                                    </th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider cursor-pointer hover:bg-accent" data-sort="carbon-cost">
                                        Carbon Cost
                                    </th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider cursor-pointer hover:bg-accent" data-sort="reduced">
                                        Reduced Emissions
                                    </th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="facilities-table-body" class="divide-y divide-border">
                                <!-- Table rows will be inserted here by JavaScript -->
                                <tr>
                                    <td colspan="8" class="px-4 py-8 text-center text-sm text-muted-foreground">
                                        Click "Apply Filters" to load facility rankings
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div class="flex items-center justify-between mt-4">
                    <button id="prev-page-btn" class="px-4 py-2 text-sm font-medium text-foreground bg-card border rounded-md hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Previous
                    </button>
                    <div class="text-sm text-muted-foreground">
                        Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-results">0</span> facilities
                    </div>
                    <button id="next-page-btn" class="px-4 py-2 text-sm font-medium text-foreground bg-card border rounded-md hover:bg-accent disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Next
                    </button>
                </div>
            </div>
        </main>
        </div>
    </div>

    <script>
        // Load shared header with cache busting
        fetch('/static/header.html?' + Date.now())
            .then(response => response.text())
            .then(html => {
                document.getElementById('header-container').innerHTML = html;
                highlightActiveNav();
            })
            .catch(error => console.error('Error loading header:', error));

        // State management
        let currentPage = 1;
        let facilitiesData = [];
        let filteredData = [];

        // Industry color mapping
        const industryColors = {
            steel: '#ef4444',
            cement: '#6b7280',
            chemicals: '#3b82f6'
        };

        // Update slider value displays
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tax-rate').addEventListener('input', (e) => {
                document.getElementById('tax-rate-value').textContent = '$' + e.target.value;
            });

            document.getElementById('abatement-rate').addEventListener('input', (e) => {
                document.getElementById('abatement-rate-value').textContent = e.target.value + '%';
            });

            // Apply Filters button
            document.getElementById('apply-filters-btn').addEventListener('click', loadRankings);

            // Export CSV button
            document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

            // Pagination buttons
            document.getElementById('prev-page-btn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });

            document.getElementById('next-page-btn').addEventListener('click', () => {
                const resultsPerPage = parseInt(document.getElementById('results-per-page').value);
                const totalPages = Math.ceil(filteredData.length / resultsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
        });

        // Load rankings from API
        async function loadRankings() {
            try {
                // Get filter values
                const industries = Array.from(document.querySelectorAll('input[name="industry"]:checked'))
                    .map(cb => cb.value);
                const state = document.getElementById('state-filter').value;
                const year = parseInt(document.getElementById('year-filter').value);
                const taxRate = parseFloat(document.getElementById('tax-rate').value);
                const abatementRate = parseFloat(document.getElementById('abatement-rate').value) / 100;

                // Build query params
                const params = new URLSearchParams({
                    year: year,
                    tax: taxRate,
                    abatement: abatementRate
                });
                
                if (industries.length > 0) {
                    params.append('industries', industries.join(','));
                }
                if (state) {
                    params.append('state', state);
                }

                // Call API (using /api/rankings endpoint when available, for now use sample data)
                const response = await fetch(`/api/rankings?${params.toString()}`);
                
                if (!response.ok) {
                    // Fallback to sample data
                    console.warn('Rankings API not available, using sample data');
                    facilitiesData = generateSampleData(industries, state, year, taxRate, abatementRate);
                } else {
                    const data = await response.json();
                    facilitiesData = data.facilities || [];
                }

                // Apply sorting
                applySort();
                currentPage = 1;
                renderTable();
                
            } catch (error) {
                console.error('Error loading rankings:', error);
                // Use sample data as fallback
                const industries = Array.from(document.querySelectorAll('input[name="industry"]:checked'))
                    .map(cb => cb.value);
                const state = document.getElementById('state-filter').value;
                const year = parseInt(document.getElementById('year-filter').value);
                const taxRate = parseFloat(document.getElementById('tax-rate').value);
                const abatementRate = parseFloat(document.getElementById('abatement-rate').value) / 100;
                
                facilitiesData = generateSampleData(industries, state, year, taxRate, abatementRate);
                applySort();
                currentPage = 1;
                renderTable();
            }
        }

        // Generate sample data for demonstration
        function generateSampleData(industries, state, year, taxRate, abatementRate) {
            const facilityNames = [
                'ArcelorMittal Steel', 'Cleveland-Cliffs Inc', 'Nucor Corporation', 'US Steel Gary Works',
                'CEMEX Cement Plant', 'Lehigh Hanson Cement', 'Buzzi Unicem USA', 'Ash Grove Cement',
                'Dow Chemical Complex', 'DuPont Facility', 'BASF Chemical Plant', 'Eastman Chemical'
            ];
            
            const states = state ? [state] : ['TX', 'CA', 'PA', 'IN', 'OH'];
            const selectedIndustries = industries.length > 0 ? industries : ['steel', 'cement', 'chemicals'];
            
            const facilities = [];
            for (let i = 0; i < 50; i++) {
                const industry = selectedIndustries[i % selectedIndustries.length];
                const emissions = Math.random() * 4000000 + 100000; // 100k-4.1M MT
                const reducedEmissions = emissions * (1 - abatementRate);
                const carbonCost = emissions * taxRate;
                
                facilities.push({
                    id: 1000000 + i,
                    name: facilityNames[i % facilityNames.length] + ' ' + (Math.floor(i / facilityNames.length) + 1),
                    industry: industry,
                    state: states[i % states.length],
                    emissions: emissions,
                    carbonCost: carbonCost,
                    reducedEmissions: reducedEmissions,
                    year: year
                });
            }
            
            return facilities;
        }

        // Apply sorting based on dropdown
        function applySort() {
            const sortBy = document.getElementById('sort-by').value;
            
            filteredData = [...facilitiesData];
            
            switch(sortBy) {
                case 'emissions-desc':
                    filteredData.sort((a, b) => b.emissions - a.emissions);
                    break;
                case 'emissions-asc':
                    filteredData.sort((a, b) => a.emissions - b.emissions);
                    break;
                case 'name-asc':
                    filteredData.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    filteredData.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'carbon-cost-desc':
                    filteredData.sort((a, b) => b.carbonCost - a.carbonCost);
                    break;
                case 'carbon-cost-asc':
                    filteredData.sort((a, b) => a.carbonCost - b.carbonCost);
                    break;
            }
        }

        // Render table with current page data
        function renderTable() {
            const tbody = document.getElementById('facilities-table-body');
            const resultsPerPage = parseInt(document.getElementById('results-per-page').value);
            
            const startIdx = (currentPage - 1) * resultsPerPage;
            const endIdx = Math.min(startIdx + resultsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIdx, endIdx);
            
            if (pageData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-sm text-muted-foreground">
                            No facilities match your filter criteria
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = pageData.map((facility, idx) => `
                    <tr class="hover:bg-accent">
                        <td class="px-4 py-3 text-sm font-medium text-foreground">${startIdx + idx + 1}</td>
                        <td class="px-4 py-3 text-sm text-foreground">${facility.name}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full" style="background: ${industryColors[facility.industry]}"></div>
                                ${facility.industry.charAt(0).toUpperCase() + facility.industry.slice(1)}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-foreground">${facility.state}</td>
                        <td class="px-4 py-3 text-sm text-right font-mono">${facility.emissions.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="px-4 py-3 text-sm text-right font-mono">$${facility.carbonCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="px-4 py-3 text-sm text-right font-mono">${facility.reducedEmissions.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="px-4 py-3 text-center">
                            <button class="text-xs text-primary hover:underline" onclick="viewDetails(${facility.id})">View</button>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update summary stats
            const totalEmissions = filteredData.reduce((sum, f) => sum + f.emissions, 0);
            const totalCarbonCost = filteredData.reduce((sum, f) => sum + f.carbonCost, 0);
            
            document.getElementById('total-facilities').textContent = filteredData.length.toLocaleString();
            document.getElementById('total-emissions').textContent = (totalEmissions / 1000000).toFixed(2) + ' M MT';
            document.getElementById('total-carbon-cost').textContent = '$' + (totalCarbonCost / 1000000).toFixed(2) + ' M';
            
            // Update pagination
            const totalPages = Math.ceil(filteredData.length / resultsPerPage);
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('showing-start').textContent = startIdx + 1;
            document.getElementById('showing-end').textContent = endIdx;
            document.getElementById('total-results').textContent = filteredData.length;
            
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // View facility details (placeholder)
        function viewDetails(facilityId) {
            alert(`Facility detail page for ID ${facilityId} will be implemented next`);
            // Future: window.location.href = `/facility/${facilityId}`;
        }

        // Export to CSV
        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Rank', 'Facility Name', 'Industry', 'State', 'Emissions (MT CO2e)', 'Carbon Cost ($)', 'Reduced Emissions (MT CO2e)'];
            const rows = filteredData.map((facility, idx) => [
                idx + 1,
                facility.name,
                facility.industry,
                facility.state,
                facility.emissions.toFixed(0),
                facility.carbonCost.toFixed(0),
                facility.reducedEmissions.toFixed(0)
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `facility-rankings-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
                const response = await fetch('/api/config');
                const config = await response.json();
                mapboxToken = config.mapbox_token || 'pk.eyJ1IjoiZXhhbXBsZSIsImEiOiJjbGV4YW1wbGUifQ.example';

                mapboxgl.accessToken = mapboxToken;
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/light-v11',
                    center: config.default_center || [-80.8431, 35.2271],
                    zoom: config.default_zoom || 10
                });

                map.on('load', () => {
                    mapLoaded = true;
                    loadSampleData();
                    updateIntegrationStatus();
                    document.getElementById('map-loaded-status').textContent = 'yes';
                });
            } catch (error) {
                console.error('Error initializing:', error);
                // Fallback if API is unavailable
                mapboxgl.accessToken = 'pk.eyJ1IjoiZXhhbXBsZSIsImEiOiJjbGV4YW1wbGUifQ.example';
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/light-v11',
                    center: [-80.8431, 35.2271],
                    zoom: 10
                });
                map.on('load', () => {
                    mapLoaded = true;
                    updateIntegrationStatus();
                    document.getElementById('map-loaded-status').textContent = 'yes';
                });
            }
            // Initial integration status check even if map hasn't loaded yet
            updateIntegrationStatus();
        }

        // Load sample district data
        async function loadSampleData() {
            try {
                const response = await fetch('/api/sample-data');
                const data = await response.json();

                // Create GeoJSON features for districts
                const features = data.data.map((item, index) => ({
                    type: 'Feature',
                    properties: {
                        district: item.district.id,
                        name: item.district.name,
                        emissions: item.metrics.annual_emissions_kg_co2,
                        cost: item.metrics.annual_cost_usd,
                        usage: item.metrics.annual_kwh_usage
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: item.district.center
                    }
                }));

                // Add source
                if (!map.getSource('districts')) {
                    map.addSource('districts', {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: features
                        }
                    });

                    // Add circle layer with color based on emissions
                    map.addLayer({
                        id: 'district-circles',
                        type: 'circle',
                        source: 'districts',
                        paint: {
                            'circle-radius': 30,
                            'circle-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'emissions'],
                                0, '#22c55e',
                                5000, '#eab308',
                                10000, '#f97316',
                                15000, '#ef4444'
                            ],
                            'circle-opacity': 0.7,
                            'circle-stroke-width': 2,
                            'circle-stroke-color': '#ffffff'
                        }
                    });

                    // Add labels
                    map.addLayer({
                        id: 'district-labels',
                        type: 'symbol',
                        source: 'districts',
                        layout: {
                            'text-field': ['get', 'name'],
                            'text-size': 12,
                            'text-offset': [0, 2.5]
                        },
                        paint: {
                            'text-color': '#333',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2
                        }
                    });

                    // Add popup on click
                    map.on('click', 'district-circles', (e) => {
                        const props = e.features[0].properties;
                        new mapboxgl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(`
                                <h3>${props.name}</h3>
                                <p><strong>Emissions:</strong> ${props.emissions.toLocaleString()} kg CO₂/yr</p>
                                <p><strong>Cost:</strong> $${props.cost.toLocaleString()}/yr</p>
                                <p><strong>Usage:</strong> ${props.usage.toLocaleString()} kWh/yr</p>
                            `)
                            .addTo(map);
                    });

                    map.on('mouseenter', 'district-circles', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    map.on('mouseleave', 'district-circles', () => {
                        map.getCanvas().style.cursor = '';
                    });
                }
            } catch (error) {
                console.error('Error loading sample data:', error);
            }
        }

        // Fetch integration status from server and update UI
        async function updateIntegrationStatus() {
            try {
                const [intRes, healthRes] = await Promise.all([
                    fetch('/api/integration-status'),
                    fetch('/health')
                ]);

                if (intRes.ok) {
                    const intData = await intRes.json();
                    document.getElementById('mapbox-token-status').textContent =
                        intData.mapbox_configured ? 'present' : 'missing';
                    document.getElementById('palmetto-status').textContent =
                        intData.palmetto_base
                            ? (intData.palmetto_reachable
                                ? `reachable (${intData.palmetto_base})`
                                : `unreachable (${intData.palmetto_base})`)
                            : 'not configured';
                } else {
                    document.getElementById('mapbox-token-status').textContent = 'error';
                    document.getElementById('palmetto-status').textContent = 'error';
                }

                if (healthRes.ok) {
                    const health = await healthRes.json();
                    document.getElementById('server-health-status').textContent =
                        (health.status || 'unknown');
                } else {
                    document.getElementById('server-health-status').textContent = 'unhealthy';
                }

                // Map loaded status (client-side)
                document.getElementById('map-loaded-status').textContent = mapLoaded ? 'yes' : 'no';
            } catch (err) {
                console.error('Error fetching integration status:', err);
                document.getElementById('mapbox-token-status').textContent = 'error';
                document.getElementById('palmetto-status').textContent = 'error';
                document.getElementById('server-health-status').textContent = 'error';
            }
        }

        // Toggle bottom integration panel expansion
        function toggleIntegrationPanel() {
            const content = document.getElementById('integration-status');
            const btn = document.getElementById('integration-toggle');
            const isHidden = content.classList.contains('hidden');
            if (isHidden) {
                content.classList.remove('hidden');
                btn.textContent = '−';
                btn.setAttribute('aria-expanded', 'true');
                // Refresh status when opening
                updateIntegrationStatus();
            } else {
                content.classList.add('hidden');
                btn.textContent = '+';
                btn.setAttribute('aria-expanded', 'false');
            }
        }

        // Hook up toggle button & inputs after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const t = document.getElementById('integration-toggle');
            if (t) t.addEventListener('click', toggleIntegrationPanel);

            document.getElementById('num-evs').addEventListener('input', (e) => {
                document.getElementById('num-evs-value').textContent = e.target.value;
            });

            document.getElementById('pv-capacity').addEventListener('input', (e) => {
                document.getElementById('pv-capacity-value').textContent = e.target.value;
            });

            document.getElementById('num-heat-pumps').addEventListener('input', (e) => {
                document.getElementById('num-heat-pumps-value').textContent = e.target.value;
            });

            document.getElementById('calculate-btn').addEventListener('click', async () => {
                const loading = document.getElementById('loading');
                const results = document.getElementById('results');
                const button = document.getElementById('calculate-btn');

                // Show loading
                loading.classList.remove('hidden');
                results.classList.add('hidden');
                button.disabled = true;

                // Gather parameters
                const scenario = {
                    num_evs: parseInt(document.getElementById('num-evs').value),
                    pv_capacity_kw: parseFloat(document.getElementById('pv-capacity').value),
                    num_heat_pumps: parseInt(document.getElementById('num-heat-pumps').value),
                    insulation_level: document.getElementById('insulation-level').value,
                    building_type: document.getElementById('building-type').value,
                    square_footage: parseInt(document.getElementById('square-footage').value)
                };

                try {
                    const response = await fetch('/api/calculate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ scenario })
                    });

                    const result = await response.json();

                    // Display results
                    document.getElementById('result-usage').textContent =
                        `${result.annual_kwh_usage.toLocaleString()} kWh/yr`;
                    document.getElementById('result-cost').textContent =
                        `$${result.annual_cost_usd.toLocaleString()}/yr`;
                    document.getElementById('result-emissions').textContent =
                        `${result.annual_emissions_kg_co2.toLocaleString()} kg CO₂/yr`;
                    document.getElementById('result-peak').textContent =
                        `${result.peak_demand_kw.toLocaleString()} kW`;
                    document.getElementById('result-renewable').textContent =
                        `${result.renewable_percentage}%`;

                    results.classList.remove('hidden');
                } catch (error) {
                    console.error('Error calculating:', error);
                    alert('Error calculating scenario. Please try again.');
                } finally {
                    loading.classList.add('hidden');
                    button.disabled = false;
                }
            });

            // Initialize on load
            init();
        });

        // Highlight active navigation link
        function highlightActiveNav() {
            const currentPage = document.body.dataset.page;
            if (currentPage) {
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.dataset.page === currentPage) {
                        link.classList.remove('text-muted-foreground', 'border-transparent');
                        link.classList.add('text-foreground', 'border-primary', 'bg-background/50');
                    }
                });
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grid Siting - Map View</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    
    <!-- Tailwind CSS -->
    <link href="/static/output.css" rel="stylesheet">
    
    <style>
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .sidebar { position: absolute; left: 0; top: 0; bottom: 0; width: 320px; background: white; z-index: 10; overflow-y: auto; }
        .map-container { position: absolute; left: 320px; top: 0; bottom: 0; right: 0; }
        .layer-toggle { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #e5e7eb; }
        .layer-toggle input[type="checkbox"] { margin-right: 8px; }
        .legend-item { display: flex; align-items: center; padding: 4px 0; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; }
        .preview-box { position: absolute; top: 20px; right: 20px; background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 5; max-width: 300px; display: none; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Left Sidebar -->
    <div class="sidebar shadow-lg">
        <div class="p-4 border-b bg-gradient-to-r from-blue-600 to-blue-700">
            <h1 class="text-xl font-bold text-white">Smart Grid Siting</h1>
            <p class="text-blue-100 text-sm mt-1">Interactive Map View</p>
        </div>
        
        <!-- Legend -->
        <div class="p-4 border-b">
            <h2 class="font-semibold text-gray-700 mb-3">Grid Nodes</h2>
            
            <div class="space-y-2 text-sm">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #16a34a;"></div>
                    <span>80-100: Excellent</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #eab308;"></div>
                    <span>60-79: Good</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f97316;"></div>
                    <span>40-59: Moderate</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ef4444;"></div>
                    <span>0-39: Limited</span>
                </div>
            </div>
        </div>
        
        <!-- Energy Sources Legend -->
        <div class="p-4 border-b">
            <h2 class="font-semibold text-gray-700 mb-3">Energy Sources</h2>
            
            <div class="space-y-2 text-sm">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3b82f6;"></div>
                    <span>RWE Projects</span>
                </div>
            </div>
        </div>
        
        <!-- Site Summary (appears on hover) -->
        <div id="site-summary" class="p-4 hidden">
            <h2 class="font-semibold text-gray-700 mb-2">Site Preview</h2>
            <div id="summary-content" class="text-sm space-y-1 text-gray-600">
                <p>Hover over a site to see details</p>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="p-4 bg-blue-50 text-sm text-gray-700">
            <p class="font-semibold mb-2">How to use:</p>
            <ol class="list-decimal list-inside space-y-1">
                <li>Click on any grid node marker</li>
                <li>Review the site preview</li>
                <li>Send promising sites to the Siting Framework</li>
            </ol>
        </div>
    </div>
    
    <!-- Map Container -->
    <div class="map-container">
        <div id="map"></div>
        
        <!-- Preview Box (appears on click) -->
        <div id="preview-box" class="preview-box">
            <button id="close-preview" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">&times;</button>
            <h3 id="preview-name" class="font-bold text-lg mb-2"></h3>
            <div id="preview-details" class="space-y-2 text-sm">
                <!-- Populated by JavaScript -->
            </div>
            <button id="send-to-framework" class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 font-medium">
                Send to Siting Framework â†’
            </button>
        </div>
    </div>
    
    <script>
        let map;
        let mapboxToken = '';
        let currentNode = null;
        
        // Initialize map
        async function initMap() {
            try {
                // Get config
                const response = await fetch('/api/config');
                const config = await response.json();
                mapboxToken = config.mapbox_token;
                
                mapboxgl.accessToken = mapboxToken || 'pk.eyJ1IjoiZXhhbXBsZSIsImEiOiJjbGV4YW1wbGUifQ.example';
                
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/light-v11',
                    center: config.default_center,
                    zoom: config.default_zoom
                });
                
                map.on('load', () => {
                    loadGridNodes();
                    loadEnergySources();
                });
                
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }
        
        // Load energy sources
        async function loadEnergySources() {
            try {
                const response = await fetch('/api/energy-sources/geojson');
                
                if (!response.ok) {
                    console.warn('No energy sources available');
                    return;
                }
                
                const geojson = await response.json();
                console.log('Loaded energy sources:', geojson);
                
                // Add source
                map.addSource('energy-sources', {
                    type: 'geojson',
                    data: geojson
                });
                
                // Add layer for energy sources (blue circles)
                map.addLayer({
                    id: 'energy-sources-circle',
                    type: 'circle',
                    source: 'energy-sources',
                    paint: {
                        'circle-radius': 12,  // Increased from 10 to 12
                        'circle-color': '#3b82f6', // Blue color
                        'circle-opacity': 0.9,  // Increased opacity
                        'circle-stroke-width': 3,  // Thicker border
                        'circle-stroke-color': '#fff'
                    }
                });
                
                // Add labels for energy sources
                map.addLayer({
                    id: 'energy-sources-label',
                    type: 'symbol',
                    source: 'energy-sources',
                    layout: {
                        'text-field': ['get', 'name'],
                        'text-size': 10,
                        'text-offset': [0, 1.5],
                        'text-anchor': 'top'
                    },
                    paint: {
                        'text-color': '#1e40af',
                        'text-halo-color': '#fff',
                        'text-halo-width': 1.5
                    }
                });
                
                // Add popup on click
                map.on('click', 'energy-sources-circle', (e) => {
                    const props = e.features[0].properties;
                    new mapboxgl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <div class="p-2">
                                <h3 class="font-bold text-blue-600">${props.name}</h3>
                                <div class="text-sm mt-1">
                                    <div><strong>Type:</strong> ${props.energy_source}</div>
                                    <div><strong>Capacity:</strong> ${props.capacity_mw} MW</div>
                                    <div class="text-xs text-gray-600 mt-1">${props.address}</div>
                                </div>
                            </div>
                        `)
                        .addTo(map);
                });
                
                // Hover effect
                map.on('mouseenter', 'energy-sources-circle', () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                map.on('mouseleave', 'energy-sources-circle', () => {
                    map.getCanvas().style.cursor = '';
                });
                
            } catch (error) {
                console.error('Error loading energy sources:', error);
            }
        }
        
        // Load grid nodes
        async function loadGridNodes() {
            try {
                const response = await fetch('/api/grid/nodes/geojson');
                
                if (!response.ok) {
                    console.error('Failed to fetch grid nodes, using fallback data');
                    loadFallbackNodes();
                    return;
                }
                
                const geojson = await response.json();
                console.log('Loaded grid nodes:', geojson);
                
                // Add source
                map.addSource('grid-nodes', {
                    type: 'geojson',
                    data: geojson
                });
                
                // Add layers
                addMapLayers();
                
            } catch (error) {
                console.error('Error loading grid nodes:', error);
                loadFallbackNodes();
            }
        }
        
        // Fallback data if API fails
        function loadFallbackNodes() {
            const fallbackData = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "id": 1,
                        "properties": {
                            "id": 1,
                            "name": "Pacific Northwest Node A",
                            "clean_gen": 82,
                            "transmission_headroom": 74,
                            "reliability": 68,
                            "region": "Pacific Northwest",
                            "state": "OR"
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-122.676, 45.523]
                        }
                    },
                    {
                        "type": "Feature",
                        "id": 2,
                        "properties": {
                            "id": 2,
                            "name": "Northern California Node B",
                            "clean_gen": 91,
                            "transmission_headroom": 55,
                            "reliability": 58,
                            "region": "California",
                            "state": "CA"
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-122.39, 40.55]
                        }
                    },
                    {
                        "type": "Feature",
                        "id": 3,
                        "properties": {
                            "id": 3,
                            "name": "Texas Panhandle Node C",
                            "clean_gen": 75,
                            "transmission_headroom": 88,
                            "reliability": 72,
                            "region": "Texas",
                            "state": "TX"
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-101.83, 35.22]
                        }
                    },
                    {
                        "type": "Feature",
                        "id": 4,
                        "properties": {
                            "id": 4,
                            "name": "Midwest Corridor Node D",
                            "clean_gen": 72,
                            "transmission_headroom": 79,
                            "reliability": 81,
                            "region": "Midwest",
                            "state": "IA"
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-93.62, 41.6]
                        }
                    },
                    {
                        "type": "Feature",
                        "id": 5,
                        "properties": {
                            "id": 5,
                            "name": "Southeast Node E",
                            "clean_gen": 48,
                            "transmission_headroom": 62,
                            "reliability": 76,
                            "region": "Southeast",
                            "state": "GA"
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [-83.38, 33.95]
                        }
                    }
                ]
            };
            
            console.log('Using fallback grid nodes');
            
            // Add source with fallback data
            map.addSource('grid-nodes', {
                type: 'geojson',
                data: fallbackData
            });
            
            // Add layers (same as successful load)
            addMapLayers();
        }
        
        function addMapLayers() {
            // Add layer - composite score visualization
            map.addLayer({
                id: 'nodes-circle',
                type: 'circle',
                source: 'grid-nodes',
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'clean_gen'],
                        0, 8,
                        100, 20
                    ],
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'clean_gen'],
                        0, '#ef4444',
                        40, '#f97316',
                        60, '#eab308',
                        80, '#22c55e'
                    ],
                    'circle-opacity': 0.8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });
            
            // Add labels
            map.addLayer({
                id: 'nodes-label',
                type: 'symbol',
                source: 'grid-nodes',
                layout: {
                    'text-field': ['get', 'name'],
                    'text-size': 11,
                    'text-offset': [0, 2],
                    'text-anchor': 'top'
                },
                paint: {
                    'text-color': '#374151',
                    'text-halo-color': '#fff',
                    'text-halo-width': 2
                }
            });
            
            // Click handler
            map.on('click', 'nodes-circle', handleNodeClick);
            
            // Hover effect
            map.on('mouseenter', 'nodes-circle', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'nodes-circle', () => {
                map.getCanvas().style.cursor = '';
            });
        }
        
        // Handle node click
        function handleNodeClick(e) {
            const props = e.features[0].properties;
            currentNode = props;
            
            // Calculate composite score (default weights)
            const compositeScore = (
                props.clean_gen * 0.4 +
                props.transmission_headroom * 0.3 +
                props.reliability * 0.3
            ).toFixed(1);
            
            // Update preview box
            document.getElementById('preview-name').textContent = props.name;
            document.getElementById('preview-details').innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <div class="text-gray-500">Clean Gen</div>
                        <div class="font-semibold text-green-600">${props.clean_gen}</div>
                    </div>
                    <div>
                        <div class="text-gray-500">Transmission</div>
                        <div class="font-semibold text-blue-600">${props.transmission_headroom}</div>
                    </div>
                    <div>
                        <div class="text-gray-500">Reliability</div>
                        <div class="font-semibold text-purple-600">${props.reliability}</div>
                    </div>
                    <div>
                        <div class="text-gray-500">Composite</div>
                        <div class="font-semibold text-gray-800">${compositeScore}</div>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t text-xs text-gray-600">
                    <div>${props.region || 'N/A'}</div>
                    <div>${props.state || 'N/A'}</div>
                </div>
            `;
            
            // Show preview box
            document.getElementById('preview-box').style.display = 'block';
        }
        
        // Send to framework
        document.getElementById('send-to-framework').addEventListener('click', () => {
            if (currentNode) {
                window.location.href = `/framework?site_id=${currentNode.id}`;
            }
        });
        
        // Close preview
        document.getElementById('close-preview').addEventListener('click', () => {
            document.getElementById('preview-box').style.display = 'none';
        });
        
        // Initialize on page load
        initMap();
    </script>
</body>
</html>

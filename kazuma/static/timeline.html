<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline - Industrial Emissions Policy Tool</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/output.css" rel="stylesheet">
</head>
<body class="bg-background font-sans antialiased" data-page="timeline">
    <!-- Header -->
    <div id="header-container"></div>

    <!-- Main Container -->
    <div class="flex flex-col h-[calc(100vh-130px)]">
        <!-- Top Panel: Metrics & Controls -->
        <div class="border-b bg-card p-6">
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-background rounded-lg p-4 border">
                    <div class="text-xs text-muted-foreground mb-1">Total Emissions (Current Year)</div>
                    <div class="text-2xl font-semibold text-foreground" id="total-emissions">-</div>
                    <div class="text-xs text-muted-foreground mt-1" id="emissions-change">-</div>
                </div>
                <div class="bg-background rounded-lg p-4 border">
                    <div class="text-xs text-muted-foreground mb-1">Active Facilities</div>
                    <div class="text-2xl font-semibold text-foreground" id="facility-count">-</div>
                </div>
                <div class="bg-background rounded-lg p-4 border">
                    <div class="text-xs text-muted-foreground mb-1">Steel Sector</div>
                    <div class="text-2xl font-semibold text-foreground" id="steel-emissions">-</div>
                </div>
                <div class="bg-background rounded-lg p-4 border">
                    <div class="text-xs text-muted-foreground mb-1">Cement & Chemicals</div>
                    <div class="text-2xl font-semibold text-foreground" id="other-emissions">-</div>
                </div>
            </div>

            <!-- Year Slider -->
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <label class="text-sm font-semibold text-foreground">Year</label>
                    <span class="text-lg font-semibold text-primary" id="year-value">2022</span>
                </div>
                <input type="range" id="year-slider" min="2015" max="2023" value="2022" step="1" 
                       class="w-full h-3 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary">
                <div class="flex justify-between text-xs text-muted-foreground px-1">
                    <span>2015</span>
                    <span>2017</span>
                    <span>2019</span>
                    <span>2021</span>
                    <span>2023</span>
                </div>
            </div>

            <!-- Industry Filters -->
            <div class="mt-4 flex gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" class="industry-filter" value="steel" checked>
                    <span class="text-sm">Steel</span>
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" class="industry-filter" value="cement" checked>
                    <span class="text-sm">Cement</span>
                    <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                </label>
                <label class="flex items-center gap-2">
                    <input type="checkbox" class="industry-filter" value="chemicals" checked>
                    <span class="text-sm">Chemicals</span>
                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                </label>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Map -->
            <div class="flex-1 relative bg-muted">
                <div id="map" class="w-full h-full"></div>
                
                <!-- Loading overlay -->
                <div id="map-loading" class="hidden absolute inset-0 bg-background/80 flex items-center justify-center">
                    <p class="text-sm text-muted-foreground">⏳ Loading facilities...</p>
                </div>
            </div>

            <!-- Right Panel: Charts -->
            <div class="w-96 border-l bg-card p-6 flex flex-col gap-6 overflow-y-auto">
                <div>
                    <h3 class="text-sm font-semibold text-foreground mb-3">Emissions Trend (All Industries)</h3>
                    <canvas id="aggregate-trend-chart" height="200"></canvas>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-foreground mb-3">Emissions by Industry</h3>
                    <canvas id="industry-breakdown-chart" height="180"></canvas>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-foreground mb-3">Year-over-Year Change</h3>
                    <canvas id="yoy-change-chart" height="180"></canvas>
                </div>

                <div>
                    <h3 class="text-sm font-semibold text-foreground mb-3">Top Facilities (Current Year)</h3>
                    <div id="top-facilities-list" class="space-y-2 text-xs"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let map;
        let mapboxToken = '';
        let facilitiesData = [];
        let aggregateTrendChart = null;
        let industryBreakdownChart = null;
        let yoyChangeChart = null;
        let currentYear = 2022;

        // Initialize
        async function init() {
            // Load header with cache busting
            const headerResponse = await fetch('/static/header.html?' + Date.now());
            document.getElementById('header-container').innerHTML = await headerResponse.text();
            highlightActiveNav();

            // Initialize map
            const configResponse = await fetch('/api/config');
            const config = await configResponse.json();
            mapboxToken = config.mapbox_token;

            mapboxgl.accessToken = mapboxToken;
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [-95.7129, 37.0902],
                zoom: 4
            });

            map.on('load', () => {
                loadTimelineData();
            });

            // Setup event listeners
            document.getElementById('year-slider').addEventListener('input', (e) => {
                currentYear = parseInt(e.target.value);
                document.getElementById('year-value').textContent = currentYear;
                updateMapForYear(currentYear);
                updateMetrics(currentYear);
            });

            document.querySelectorAll('.industry-filter').forEach(cb => {
                cb.addEventListener('change', () => {
                    loadTimelineData();
                });
            });
        }

        // Load multi-year timeline data
        async function loadTimelineData() {
            document.getElementById('map-loading').classList.remove('hidden');

            const industries = Array.from(document.querySelectorAll('.industry-filter:checked')).map(cb => cb.value);
            
            // Fetch data for all years (2015-2023)
            const allData = [];
            
            for (const industry of industries) {
                for (let year = 2015; year <= 2023; year++) {
                    try {
                        const response = await fetch(`/api/facilities/geojson?industry_type=${industry}&year=${year}&limit=100`);
                        const data = await response.json();
                        if (data.features) {
                            allData.push(...data.features.map(f => ({
                                ...f,
                                properties: { ...f.properties, year }
                            })));
                        }
                    } catch (error) {
                        console.error(`Error loading ${industry} for ${year}:`, error);
                    }
                }
            }

            facilitiesData = allData;
            
            // Initial display for current year
            updateMapForYear(currentYear);
            updateMetrics(currentYear);
            updateCharts();
            
            document.getElementById('map-loading').classList.add('hidden');
        }

        // Update map to show facilities for specific year
        function updateMapForYear(year) {
            const yearData = facilitiesData.filter(f => f.properties.year === year);
            
            const geojson = {
                type: 'FeatureCollection',
                features: yearData
            };

            // Remove existing source/layers
            if (map.getSource('facilities')) {
                if (map.getLayer('facility-circles')) map.removeLayer('facility-circles');
                if (map.getLayer('clusters')) map.removeLayer('clusters');
                if (map.getLayer('cluster-count')) map.removeLayer('cluster-count');
                map.removeSource('facilities');
            }

            // Add source
            map.addSource('facilities', {
                type: 'geojson',
                data: geojson,
                cluster: true,
                clusterMaxZoom: 8,
                clusterRadius: 50
            });

            // Add cluster layer
            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'facilities',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': '#3b82f6',
                    'circle-radius': 20,
                    'circle-opacity': 0.7
                }
            });

            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'facilities',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-size': 12
                },
                paint: {
                    'text-color': '#ffffff'
                }
            });

            // Add facility circles
            map.addLayer({
                id: 'facility-circles',
                type: 'circle',
                source: 'facilities',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': [
                        'match',
                        ['get', 'industry'],
                        'steel', '#ef4444',
                        'cement', '#9ca3af',
                        'chemicals', '#3b82f6',
                        '#8b5cf6'
                    ],
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'total_emissions'],
                        0, 5,
                        500000, 10,
                        1000000, 15,
                        2000000, 20
                    ],
                    'circle-opacity': 0.8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });

            // Add popup with sparkline data
            map.on('click', 'facility-circles', (e) => {
                const props = e.features[0].properties;
                const facilityId = props.facility_id;
                
                // Get historical data for this facility
                const facilityHistory = facilitiesData
                    .filter(f => f.properties.facility_id === facilityId)
                    .map(f => ({ year: f.properties.year, emissions: f.properties.total_emissions }))
                    .sort((a, b) => a.year - b.year);

                const sparklineData = facilityHistory.map(h => h.emissions).join(',');
                
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(`
                        <div class="p-2">
                            <h3 class="font-semibold text-sm mb-2">${props.name}</h3>
                            <div class="text-xs space-y-1">
                                <div><strong>Industry:</strong> ${props.industry}</div>
                                <div><strong>Location:</strong> ${props.city}, ${props.state}</div>
                                <div><strong>Emissions (${year}):</strong> ${parseInt(props.total_emissions).toLocaleString()} MT CO₂e/yr</div>
                                <div class="mt-2 pt-2 border-t">
                                    <strong>Trend (${facilityHistory[0].year}-${facilityHistory[facilityHistory.length-1].year}):</strong>
                                    <div class="text-xs text-muted-foreground">${facilityHistory.map(h => `${h.year}: ${(h.emissions/1000).toFixed(0)}k`).join(', ')}</div>
                                </div>
                            </div>
                        </div>
                    `)
                    .addTo(map);
            });
        }

        // Update metrics cards
        function updateMetrics(year) {
            const yearData = facilitiesData.filter(f => f.properties.year === year);
            const prevYearData = facilitiesData.filter(f => f.properties.year === year - 1);

            const totalEmissions = yearData.reduce((sum, f) => sum + (f.properties.total_emissions || 0), 0);
            const prevTotalEmissions = prevYearData.reduce((sum, f) => sum + (f.properties.total_emissions || 0), 0);
            const change = prevTotalEmissions > 0 ? ((totalEmissions - prevTotalEmissions) / prevTotalEmissions * 100) : 0;

            document.getElementById('total-emissions').textContent = `${(totalEmissions / 1000000).toFixed(1)}M MT`;
            document.getElementById('emissions-change').textContent = `${change > 0 ? '+' : ''}${change.toFixed(1)}% vs ${year-1}`;
            document.getElementById('facility-count').textContent = yearData.length.toLocaleString();

            const steelEmissions = yearData.filter(f => f.properties.industry === 'steel')
                .reduce((sum, f) => sum + (f.properties.total_emissions || 0), 0);
            const otherEmissions = totalEmissions - steelEmissions;

            document.getElementById('steel-emissions').textContent = `${(steelEmissions / 1000000).toFixed(1)}M MT`;
            document.getElementById('other-emissions').textContent = `${(otherEmissions / 1000000).toFixed(1)}M MT`;

            // Update top facilities list
            const topFacilities = yearData
                .sort((a, b) => b.properties.total_emissions - a.properties.total_emissions)
                .slice(0, 10);

            document.getElementById('top-facilities-list').innerHTML = topFacilities.map((f, i) => `
                <div class="flex items-center gap-2 p-2 bg-background rounded border">
                    <div class="text-muted-foreground font-semibold">${i + 1}</div>
                    <div class="flex-1">
                        <div class="font-medium">${f.properties.name}</div>
                        <div class="text-muted-foreground">${f.properties.state}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${(f.properties.total_emissions / 1000).toFixed(0)}k</div>
                        <div class="text-muted-foreground">${f.properties.industry}</div>
                    </div>
                </div>
            `).join('');
        }

        // Update all charts
        function updateCharts() {
            // Aggregate by year
            const yearlyTotals = {};
            const industryYearly = { steel: {}, cement: {}, chemicals: {} };

            facilitiesData.forEach(f => {
                const year = f.properties.year;
                const emissions = f.properties.total_emissions || 0;
                const industry = f.properties.industry;

                yearlyTotals[year] = (yearlyTotals[year] || 0) + emissions;
                if (industryYearly[industry]) {
                    industryYearly[industry][year] = (industryYearly[industry][year] || 0) + emissions;
                }
            });

            const years = Object.keys(yearlyTotals).sort();

            // Aggregate Trend Chart
            const ctxTrend = document.getElementById('aggregate-trend-chart').getContext('2d');
            if (aggregateTrendChart) aggregateTrendChart.destroy();
            
            aggregateTrendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Total Emissions (M MT CO₂e)',
                        data: years.map(y => yearlyTotals[y] / 1000000),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } }
                }
            });

            // Industry Breakdown Chart
            const ctxIndustry = document.getElementById('industry-breakdown-chart').getContext('2d');
            if (industryBreakdownChart) industryBreakdownChart.destroy();

            industryBreakdownChart = new Chart(ctxIndustry, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Steel',
                            data: years.map(y => (industryYearly.steel[y] || 0) / 1000000),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)'
                        },
                        {
                            label: 'Cement',
                            data: years.map(y => (industryYearly.cement[y] || 0) / 1000000),
                            borderColor: '#9ca3af',
                            backgroundColor: 'rgba(156, 163, 175, 0.1)'
                        },
                        {
                            label: 'Chemicals',
                            data: years.map(y => (industryYearly.chemicals[y] || 0) / 1000000),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Year-over-Year Change Chart
            const yoyChanges = years.slice(1).map((y, i) => {
                const curr = yearlyTotals[y];
                const prev = yearlyTotals[years[i]];
                return prev > 0 ? ((curr - prev) / prev * 100) : 0;
            });

            const ctxYoy = document.getElementById('yoy-change-chart').getContext('2d');
            if (yoyChangeChart) yoyChangeChart.destroy();

            yoyChangeChart = new Chart(ctxYoy, {
                type: 'bar',
                data: {
                    labels: years.slice(1),
                    datasets: [{
                        label: 'YoY Change (%)',
                        data: yoyChanges,
                        backgroundColor: yoyChanges.map(v => v >= 0 ? '#ef4444' : '#22c55e')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Highlight active navigation link
        function highlightActiveNav() {
            const currentPage = document.body.dataset.page;
            if (currentPage) {
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.dataset.page === currentPage) {
                        link.classList.remove('text-muted-foreground', 'border-transparent');
                        link.classList.add('text-foreground', 'border-primary', 'bg-background/50');
                    }
                });
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

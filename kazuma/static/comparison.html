<!DOCTYPE html><!DOCTYPE html><!DOCTYPE html><!DOCTYPE html>

<html lang="en">

<head><html lang="en">

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0"><head><html lang="en"><html lang="en">

    <title>Scenario Comparison - Industrial Emissions Policy Tool</title>

    <link rel="stylesheet" href="/static/output.css">    <meta charset="UTF-8">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

</head>    <meta name="viewport" content="width=device-width, initial-scale=1.0"><head><head>

<body class="bg-background text-foreground">

    <div id="header-container"></div>    <title>Scenario Comparison - Industrial Emissions Policy Tool</title>



    <div class="flex flex-col" style="height: calc(100vh - 130px);">    <link rel="stylesheet" href="/static/output.css">    <meta charset="UTF-8">    <meta charset="UTF-8">

        <div class="flex flex-1 overflow-hidden">

            <!-- Main Content Area -->    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

            <div class="flex-1 overflow-y-auto">

                <div class="p-8 max-w-7xl mx-auto space-y-8"></head>    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <meta name="viewport" content="width=device-width, initial-scale=1.0">

                    

                    <!-- Page Header --><body class="bg-background text-foreground">

                    <div class="text-center">

                        <h1 class="text-4xl font-bold mb-2">Scenario Comparison</h1>    <div id="header-container"></div>    <title>Scenario Comparison - Industrial Emissions Policy Tool</title>    <title>Energize - Energy Policy Visualization</title>

                        <p class="text-muted-foreground text-lg">Compare policy impacts side-by-side</p>

                    </div>



                    <!-- Quick Scenario Builder -->    <div class="flex flex-col" style="height: calc(100vh - 130px);">    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

                    <div class="bg-card border rounded-lg p-6">

                        <h2 class="text-xl font-semibold mb-4">Quick Scenario Builder</h2>        <div class="flex flex-1 overflow-hidden">

                        <div class="grid grid-cols-[1fr_auto_1fr] gap-6 items-center">

                            <!-- Scenario A Summary -->            <!-- Main Content Area -->    <link rel="preconnect" href="https://fonts.googleapis.com">    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

                            <div class="bg-blue-50 dark:bg-blue-950 border-2 border-blue-300 dark:border-blue-700 rounded-lg p-4">

                                <div class="flex items-center gap-2 mb-3">            <div class="flex-1 overflow-y-auto">

                                    <span class="text-2xl">üîµ</span>

                                    <h3 class="font-bold text-lg">BASELINE</h3>                <div class="p-8 max-w-7xl mx-auto space-y-8">    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>    <link rel="preconnect" href="https://fonts.googleapis.com">

                                </div>

                                <div class="space-y-1 text-sm">                    

                                    <p><span class="font-medium">Carbon Tax:</span> <span id="scenarioA-tax-display">$0</span>/ton</p>

                                    <p><span class="font-medium">Abatement:</span> <span id="scenarioA-abate-display">0</span>%</p>                    <!-- Page Header -->    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

                                    <p><span class="font-medium">Industries:</span> <span id="scenarioA-industries-display">All</span></p>

                                </div>                    <div class="text-center">

                                <button onclick="openScenarioDrawer('A')" class="mt-3 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition">

                                    Edit Scenario A                        <h1 class="text-4xl font-bold mb-2">Scenario Comparison</h1>    <link href="/static/output.css" rel="stylesheet">    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

                                </button>

                            </div>                        <p class="text-muted-foreground text-lg">Compare policy impacts side-by-side</p>



                            <!-- VS Divider -->                    </div></head>    <link href="/static/output.css" rel="stylesheet">

                            <div class="text-3xl font-bold text-muted-foreground">VS</div>



                            <!-- Scenario B Summary -->

                            <div class="bg-green-50 dark:bg-green-950 border-2 border-green-300 dark:border-green-700 rounded-lg p-4">                    <!-- Quick Scenario Builder --><body class="bg-background font-sans antialiased" data-page="comparison"></head>

                                <div class="flex items-center gap-2 mb-3">

                                    <span class="text-2xl">üü¢</span>                    <div class="bg-card border rounded-lg p-6">

                                    <h3 class="font-bold text-lg">POLICY SCENARIO</h3>

                                </div>                        <h2 class="text-xl font-semibold mb-4">Quick Scenario Builder</h2>    <!-- Header Container (loaded dynamically) --><body class="bg-background font-sans antialiased">

                                <div class="space-y-1 text-sm">

                                    <p><span class="font-medium">Carbon Tax:</span> <span id="scenarioB-tax-display">$50</span>/ton</p>                        <div class="grid grid-cols-[1fr_auto_1fr] gap-6 items-center">

                                    <p><span class="font-medium">Abatement:</span> <span id="scenarioB-abate-display">20</span>%</p>

                                    <p><span class="font-medium">Industries:</span> <span id="scenarioB-industries-display">All</span></p>                            <!-- Scenario A Summary -->    <div id="header-container"></div>    <!-- Header -->

                                </div>

                                <button onclick="openScenarioDrawer('B')" class="mt-3 w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium transition">                            <div class="bg-blue-50 dark:bg-blue-950 border-2 border-blue-300 dark:border-blue-700 rounded-lg p-4">

                                    Edit Scenario B

                                </button>                                <div class="flex items-center gap-2 mb-3">    <header class="border-b bg-card">

                            </div>

                        </div>                                    <span class="text-2xl">üîµ</span>



                        <div class="mt-6 text-center">                                    <h3 class="font-bold text-lg">BASELINE</h3>    <!-- Main Container -->        <div class="px-6 py-4">

                            <button onclick="calculateComparison()" class="px-8 py-3 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg text-lg font-semibold transition shadow-lg">

                                ‚ö° Compare & Calculate Impact                                </div>

                            </button>

                        </div>                                <div class="space-y-1 text-sm">    <div class="flex flex-col h-[calc(100vh-130px)]">            <h1 class="text-2xl font-semibold text-foreground">Energize</h1>

                    </div>

                                    <p><span class="font-medium">Carbon Tax:</span> <span id="scenarioA-tax-display">$0</span>/ton</p>

                    <!-- Key Impacts Section -->

                    <div id="impacts-section" class="hidden">                                    <p><span class="font-medium">Abatement:</span> <span id="scenarioA-abate-display">0</span>%</p>        <!-- Page Title Bar -->            <p class="text-sm text-muted-foreground mt-1">

                        <div class="bg-card border rounded-lg p-6">

                            <h2 class="text-2xl font-bold mb-6">üìä Key Impacts at a Glance</h2>                                    <p><span class="font-medium">Industries:</span> <span id="scenarioA-industries-display">All</span></p>

                            

                            <!-- Emissions Reduction (Large Visual) -->                                </div>        <div class="border-b bg-card px-6 py-4">                Model building-level energy scenarios and visualize impacts by district

                            <div class="bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-950 dark:to-green-950 border-2 border-primary/20 rounded-lg p-6 mb-6">

                                <h3 class="text-lg font-semibold mb-4 text-center">EMISSIONS REDUCTION</h3>                                <button onclick="openScenarioDrawer('A')" class="mt-3 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition">

                                <div class="flex items-center justify-between mb-2">

                                    <div class="text-center">                                    Edit Scenario A            <h1 class="text-xl font-semibold text-foreground">Policy Scenario Comparison</h1>            </p>

                                        <div class="text-sm text-muted-foreground mb-1">BASE</div>

                                        <div class="text-2xl font-bold" id="impact-base-emissions">125.4 MT</div>                                </button>

                                    </div>

                                    <div class="flex-1 mx-8">                            </div>            <p class="text-sm text-muted-foreground mt-1">        </div>

                                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">

                                            <div id="reduction-bar" class="h-full bg-gradient-to-r from-blue-500 to-green-500 transition-all duration-500" style="width: 0%"></div>

                                        </div>

                                    </div>                            <!-- VS Divider -->                Compare emissions, costs, and impacts across two policy scenarios    </header>

                                    <div class="text-center">

                                        <div class="text-sm text-muted-foreground mb-1">POLICY</div>                            <div class="text-3xl font-bold text-muted-foreground">VS</div>

                                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="impact-policy-emissions">95.2 MT</div>

                                    </div>            </p>

                                </div>

                                <div class="text-center mt-4">                            <!-- Scenario B Summary -->

                                    <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="impact-reduction">

                                        ‚¨á 30.2 MT (24% reduction)                            <div class="bg-green-50 dark:bg-green-950 border-2 border-green-300 dark:border-green-700 rounded-lg p-4">        </div>    <!-- Main Container -->

                                    </div>

                                    <div class="mt-2 flex items-center justify-center gap-2">                                <div class="flex items-center gap-2 mb-3">

                                        <div class="text-sm text-muted-foreground">Progress:</div>

                                        <div id="reduction-percent" class="text-lg font-semibold">24%</div>                                    <span class="text-2xl">üü¢</span>    <div class="flex h-[calc(100vh-97px)]">

                                    </div>

                                </div>                                    <h3 class="font-bold text-lg">POLICY SCENARIO</h3>

                            </div>

                                </div>        <!-- Comparison Content -->        <!-- Sidebar -->

                            <!-- Secondary Metrics Grid -->

                            <div class="grid grid-cols-3 gap-4">                                <div class="space-y-1 text-sm">

                                <!-- Carbon Revenue -->

                                <div class="bg-card border rounded-lg p-4">                                    <p><span class="font-medium">Carbon Tax:</span> <span id="scenarioB-tax-display">$50</span>/ton</p>        <div class="flex-1 overflow-auto">        <aside class="w-80 border-r bg-card">

                                    <h4 class="font-semibold text-sm text-muted-foreground mb-3">CARBON REVENUE</h4>

                                    <div class="space-y-2">                                    <p><span class="font-medium">Abatement:</span> <span id="scenarioB-abate-display">20</span>%</p>

                                        <div class="flex justify-between items-baseline">

                                            <span class="text-xs text-muted-foreground">BASE:</span>                                    <p><span class="font-medium">Industries:</span> <span id="scenarioB-industries-display">All</span></p>            <div class="p-6 space-y-6">            <div class="p-6 flex flex-col h-full">

                                            <span class="font-mono" id="revenue-base">$0M</span>

                                        </div>                                </div>

                                        <div class="flex justify-between items-baseline">

                                            <span class="text-xs text-muted-foreground">POLICY:</span>                                <button onclick="openScenarioDrawer('B')" class="mt-3 w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium transition">                <!-- Two-Column Scenario Controls -->                <!-- Scrollable content -->

                                            <span class="font-mono font-semibold" id="revenue-policy">$4.8M</span>

                                        </div>                                    Edit Scenario B

                                        <div class="pt-2 border-t">

                                            <div class="text-center text-lg font-bold text-blue-600 dark:text-blue-400" id="revenue-diff">                                </button>                <div class="grid grid-cols-2 gap-6">                <div class="flex-1 overflow-y-auto space-y-6">

                                                ‚¨Ü +$4.8M

                                            </div>                            </div>

                                        </div>

                                    </div>                        </div>                    <!-- Scenario A (Baseline) -->                    <div>

                                </div>



                                <!-- Cost Efficiency -->

                                <div class="bg-card border rounded-lg p-4">                        <div class="mt-6 text-center">                    <div class="bg-card border rounded-lg p-6">                        <h2 class="text-lg font-semibold text-foreground mb-4">Energy Scenario Parameters</h2>

                                    <h4 class="font-semibold text-sm text-muted-foreground mb-3">COST PER TON REDUCED</h4>

                                    <div class="flex items-center justify-center h-24">                            <button onclick="calculateComparison()" class="px-8 py-3 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg text-lg font-semibold transition shadow-lg">

                                        <div class="text-center">

                                            <div class="text-3xl font-bold" id="cost-efficiency">$158</div>                                ‚ö° Compare & Calculate Impact                        <div class="flex items-center justify-between mb-4">                    </div>

                                            <div class="text-xs text-muted-foreground mt-1">per ton CO‚ÇÇe</div>

                                        </div>                            </button>

                                    </div>

                                    <div class="text-center text-sm text-muted-foreground">                        </div>                            <h2 class="text-lg font-semibold text-foreground">Scenario A: Baseline</h2>

                                        Cost efficiency metric

                                    </div>                    </div>

                                </div>

                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded">BASE</span>                    <!-- Electric Vehicles -->

                                <!-- Facilities Impacted -->

                                <div class="bg-card border rounded-lg p-4">                    <!-- Key Impacts Section -->

                                    <h4 class="font-semibold text-sm text-muted-foreground mb-3">FACILITIES IMPACTED</h4>

                                    <div class="flex items-center justify-center h-24">                    <div id="impacts-section" class="hidden">                        </div>                    <div class="space-y-2">

                                        <div class="text-center">

                                            <div class="text-3xl font-bold" id="facilities-count">89</div>                        <div class="bg-card border rounded-lg p-6">

                                            <div class="text-xs text-muted-foreground mt-1">facilities</div>

                                        </div>                            <h2 class="text-2xl font-bold mb-6">üìä Key Impacts at a Glance</h2>                        <label for="num-evs" class="text-sm font-medium text-foreground">Electric Vehicles (EVs)</label>

                                    </div>

                                    <div class="text-center text-sm text-muted-foreground" id="facilities-percent">                            

                                        62% of total

                                    </div>                            <!-- Emissions Reduction (Large Visual) -->                        <div class="space-y-4">                        <input

                                </div>

                            </div>                            <div class="bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-950 dark:to-green-950 border-2 border-primary/20 rounded-lg p-6 mb-6">

                        </div>

                    </div>                                <h3 class="text-lg font-semibold mb-4 text-center">EMISSIONS REDUCTION</h3>                            <!-- Industry Filter -->                            type="range"



                    <!-- Detailed Comparison Section -->                                <div class="flex items-center justify-between mb-2">

                    <div id="detailed-section" class="hidden">

                        <div class="bg-card border rounded-lg p-6">                                    <div class="text-center">                            <div>                            id="num-evs"

                            <h2 class="text-2xl font-bold mb-4">üìà Detailed Comparison</h2>

                                                                    <div class="text-sm text-muted-foreground mb-1">BASE</div>

                            <!-- Tabs -->

                            <div class="border-b mb-6">                                        <div class="text-2xl font-bold" id="impact-base-emissions">125.4 MT</div>                                <label class="block text-sm font-medium text-foreground mb-2">Industries</label>                            min="0"

                                <div class="flex gap-4">

                                    <button onclick="switchTab('industry')" class="tab-btn px-4 py-2 font-medium border-b-2 border-primary" data-tab="industry">                                    </div>

                                        Industry Breakdown

                                    </button>                                    <div class="flex-1 mx-8">                                <div class="space-y-2">                            max="10"

                                    <button onclick="switchTab('emitters')" class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-muted-foreground/30 transition" data-tab="emitters">

                                        Top Emitters                                        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">

                                    </button>

                                    <button onclick="switchTab('geographic')" class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-muted-foreground/30 transition" data-tab="geographic">                                            <div id="reduction-bar" class="h-full bg-gradient-to-r from-blue-500 to-green-500 transition-all duration-500" style="width: 0%"></div>                                    <label class="flex items-center gap-2 text-sm">                            value="0"

                                        Geographic

                                    </button>                                        </div>

                                </div>

                            </div>                                    </div>                                        <input type="checkbox" name="scenario-a-industry" value="steel" checked class="rounded">                            step="1"



                            <!-- Tab Content -->                                    <div class="text-center">

                            <div id="tab-industry" class="tab-content">

                                <div class="grid grid-cols-2 gap-8 mb-6">                                        <div class="text-sm text-muted-foreground mb-1">POLICY</div>                                        <div class="w-3 h-3 rounded-full bg-red-500"></div>                            class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary"

                                    <div>

                                        <h3 class="text-center font-semibold mb-3 text-blue-600 dark:text-blue-400">BASELINE (A)</h3>                                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="impact-policy-emissions">95.2 MT</div>

                                        <canvas id="chart-baseline-pie" height="250"></canvas>

                                    </div>                                    </div>                                        Steel                        >

                                    <div>

                                        <h3 class="text-center font-semibold mb-3 text-green-600 dark:text-green-400">POLICY (B)</h3>                                </div>

                                        <canvas id="chart-policy-pie" height="250"></canvas>

                                    </div>                                <div class="text-center mt-4">                                    </label>                        <span class="text-sm text-muted-foreground" id="num-evs-value">0</span>

                                </div>

                                <div class="mt-8">                                    <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="impact-reduction">

                                    <h3 class="text-center font-semibold mb-4">Side-by-Side Comparison</h3>

                                    <canvas id="chart-comparison-bar" height="120"></canvas>                                        ‚¨á 30.2 MT (24% reduction)                                    <label class="flex items-center gap-2 text-sm">                    </div>

                                </div>

                            </div>                                    </div>



                            <div id="tab-emitters" class="tab-content hidden">                                    <div class="mt-2 flex items-center justify-center gap-2">                                        <input type="checkbox" name="scenario-a-industry" value="cement" checked class="rounded">

                                <div class="bg-muted/30 rounded-lg p-4">

                                    <div class="flex justify-between items-center mb-4">                                        <div class="text-sm text-muted-foreground">Progress:</div>

                                        <h3 class="font-semibold">üè≠ Top 10 Most Impacted Facilities</h3>

                                        <select id="sort-select" onchange="sortFacilities()" class="px-3 py-1 border rounded bg-background">                                        <div id="reduction-percent" class="text-lg font-semibold">24%</div>                                        <div class="w-3 h-3 rounded-full bg-gray-500"></div>                    <!-- Solar PV Capacity -->

                                            <option value="absolute">Absolute Reduction</option>

                                            <option value="percent">% Reduction</option>                                    </div>

                                            <option value="cost">Cost Impact</option>

                                        </select>                                </div>                                        Cement                    <div class="space-y-2">

                                    </div>

                                    <div class="overflow-x-auto">                            </div>

                                        <table class="w-full text-sm">

                                            <thead class="bg-muted">                                    </label>                        <label for="pv-capacity" class="text-sm font-medium text-foreground">Solar PV Capacity (kW)</label>

                                                <tr>

                                                    <th class="px-4 py-2 text-left">#</th>                            <!-- Secondary Metrics Grid -->

                                                    <th class="px-4 py-2 text-left">Facility</th>

                                                    <th class="px-4 py-2 text-left">Industry</th>                            <div class="grid grid-cols-3 gap-4">                                    <label class="flex items-center gap-2 text-sm">                        <input

                                                    <th class="px-4 py-2 text-right">Baseline</th>

                                                    <th class="px-4 py-2 text-right">Policy</th>                                <!-- Carbon Revenue -->

                                                    <th class="px-4 py-2 text-right">Impact</th>

                                                    <th class="px-4 py-2 text-right">Cost</th>                                <div class="bg-card border rounded-lg p-4">                                        <input type="checkbox" name="scenario-a-industry" value="chemicals" checked class="rounded">                            type="range"

                                                    <th class="px-4 py-2 text-center">Status</th>

                                                </tr>                                    <h4 class="font-semibold text-sm text-muted-foreground mb-3">CARBON REVENUE</h4>

                                            </thead>

                                            <tbody id="facilities-table-body">                                    <div class="space-y-2">                                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>                            id="pv-capacity"

                                                <!-- Populated by JS -->

                                            </tbody>                                        <div class="flex justify-between items-baseline">

                                        </table>

                                    </div>                                            <span class="text-xs text-muted-foreground">BASE:</span>                                        Chemicals                            min="0"

                                </div>

                            </div>                                            <span class="font-mono" id="revenue-base">$0M</span>



                            <div id="tab-geographic" class="tab-content hidden">                                        </div>                                    </label>                            max="20"

                                <div class="text-center py-12 text-muted-foreground">

                                    <p class="text-lg">Geographic breakdown visualization coming soon</p>                                        <div class="flex justify-between items-baseline">

                                    <p class="text-sm mt-2">Will show state-by-state comparison on a map</p>

                                </div>                                            <span class="text-xs text-muted-foreground">POLICY:</span>                                </div>                            value="0"

                            </div>

                        </div>                                            <span class="font-mono font-semibold" id="revenue-policy">$4.8M</span>

                    </div>

                                        </div>                            </div>                            step="0.5"

                    <!-- Export Actions -->

                    <div id="export-section" class="hidden">                                        <div class="pt-2 border-t">

                        <div class="flex justify-center gap-4">

                            <button onclick="downloadCSV()" class="px-6 py-2 bg-card border hover:bg-muted/50 rounded-lg font-medium transition">                                            <div class="text-center text-lg font-bold text-blue-600 dark:text-blue-400" id="revenue-diff">                            class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary"

                                üì• Download Full Comparison Report CSV

                            </button>                                                ‚¨Ü +$4.8M

                            <button onclick="saveScenario()" class="px-6 py-2 bg-card border hover:bg-muted/50 rounded-lg font-medium transition">

                                üíæ Save Scenario                                            </div>                            <!-- State Filter -->                        >

                            </button>

                            <button onclick="shareLink()" class="px-6 py-2 bg-card border hover:bg-muted/50 rounded-lg font-medium transition">                                        </div>

                                üîó Share Link

                            </button>                                    </div>                            <div>                        <span class="text-sm text-muted-foreground" id="pv-capacity-value">0</span>

                        </div>

                    </div>                                </div>



                </div>                                <label class="block text-sm font-medium text-foreground mb-2">State</label>                    </div>

            </div>

        </div>                                <!-- Cost Efficiency -->

    </div>

                                <div class="bg-card border rounded-lg p-4">                                <select id="scenario-a-state" class="w-full px-3 py-2 bg-background border rounded-md text-sm">

    <!-- Scenario Controls Drawer (Modal Overlay) -->

    <div id="scenario-drawer" class="fixed inset-0 bg-black/50 hidden z-50" onclick="closeScenarioDrawer(event)">                                    <h4 class="font-semibold text-sm text-muted-foreground mb-3">COST PER TON REDUCED</h4>

        <div class="absolute bottom-0 left-0 right-0 bg-background border-t shadow-2xl" onclick="event.stopPropagation()">

            <div class="p-8 max-w-7xl mx-auto">                                    <div class="flex items-center justify-center h-24">                                    <option value="">All States</option>                    <!-- Heat Pumps -->

                <div class="flex justify-between items-center mb-6">

                    <h2 class="text-2xl font-bold">Scenario Controls</h2>                                        <div class="text-center">

                    <button onclick="closeScenarioDrawer()" class="px-4 py-2 hover:bg-muted rounded">‚úï Close</button>

                </div>                                            <div class="text-3xl font-bold" id="cost-efficiency">$158</div>                                    <option value="TX">Texas</option>                    <div class="space-y-2">



                <div class="grid grid-cols-2 gap-8">                                            <div class="text-xs text-muted-foreground mt-1">per ton CO‚ÇÇe</div>

                    <!-- Scenario A Controls -->

                    <div id="controls-A" class="bg-blue-50 dark:bg-blue-950 border-2 border-blue-300 dark:border-blue-700 rounded-lg p-6">                                        </div>                                    <option value="CA">California</option>                        <label for="num-heat-pumps" class="text-sm font-medium text-foreground">Heat Pumps</label>

                        <h3 class="text-xl font-bold mb-4">Scenario A (Baseline)</h3>

                                                            </div>

                        <div class="space-y-4">

                            <div>                                    <div class="text-center text-sm text-muted-foreground">                                    <option value="PA">Pennsylvania</option>                        <input

                                <label class="block text-sm font-medium mb-2">Industries</label>

                                <div class="space-y-2">                                        Cost efficiency metric

                                    <label class="flex items-center gap-2">

                                        <input type="checkbox" checked onchange="updateScenario('A')" class="industry-checkbox-A" value="Steel">                                    </div>                                    <option value="IN">Indiana</option>                            type="range"

                                        <span>Steel</span>

                                    </label>                                </div>

                                    <label class="flex items-center gap-2">

                                        <input type="checkbox" checked onchange="updateScenario('A')" class="industry-checkbox-A" value="Cement">                                    <option value="OH">Ohio</option>                            id="num-heat-pumps"

                                        <span>Cement</span>

                                    </label>                                <!-- Facilities Impacted -->

                                    <label class="flex items-center gap-2">

                                        <input type="checkbox" checked onchange="updateScenario('A')" class="industry-checkbox-A" value="Chemicals">                                <div class="bg-card border rounded-lg p-4">                                    <option value="IL">Illinois</option>                            min="0"

                                        <span>Chemicals</span>

                                    </label>                                    <h4 class="font-semibold text-sm text-muted-foreground mb-3">FACILITIES IMPACTED</h4>

                                </div>

                            </div>                                    <div class="flex items-center justify-center h-24">                                    <option value="LA">Louisiana</option>                            max="5"



                            <div>                                        <div class="text-center">

                                <label class="block text-sm font-medium mb-2">State</label>

                                <select id="state-A" onchange="updateScenario('A')" class="w-full px-3 py-2 border rounded bg-background">                                            <div class="text-3xl font-bold" id="facilities-count">89</div>                                    <option value="MI">Michigan</option>                            value="0"

                                    <option value="all">All States</option>

                                    <option value="CA">California</option>                                            <div class="text-xs text-muted-foreground mt-1">facilities</div>

                                    <option value="TX">Texas</option>

                                    <option value="IN">Indiana</option>                                        </div>                                    <option value="AL">Alabama</option>                            step="1"

                                    <option value="PA">Pennsylvania</option>

                                </select>                                    </div>

                            </div>

                                    <div class="text-center text-sm text-muted-foreground" id="facilities-percent">                                </select>                            class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary"

                            <div>

                                <label class="block text-sm font-medium mb-2">Year</label>                                        62% of total

                                <select id="year-A" onchange="updateScenario('A')" class="w-full px-3 py-2 border rounded bg-background">

                                    <option value="2023">2023</option>                                    </div>                            </div>                        >

                                    <option value="2022">2022</option>

                                    <option value="2021">2021</option>                                </div>

                                </select>

                            </div>                            </div>                        <span class="text-sm text-muted-foreground" id="num-heat-pumps-value">0</span>



                            <div>                        </div>

                                <label class="block text-sm font-medium mb-2">

                                    Carbon Tax: <span id="tax-value-A" class="font-bold">$0</span>/ton                    </div>                            <!-- Year -->                    </div>

                                </label>

                                <input type="range" id="tax-A" min="0" max="200" value="0" step="5" 

                                       oninput="updateSlider('A', 'tax')" onchange="updateScenario('A')"

                                       class="w-full">                    <!-- Detailed Comparison Section -->                            <div>

                            </div>

                    <div id="detailed-section" class="hidden">

                            <div>

                                <label class="block text-sm font-medium mb-2">                        <div class="bg-card border rounded-lg p-6">                                <label class="block text-sm font-medium text-foreground mb-2">Year</label>                    <!-- Insulation Level -->

                                    Abatement Required: <span id="abate-value-A" class="font-bold">0</span>%

                                </label>                            <h2 class="text-2xl font-bold mb-4">üìà Detailed Comparison</h2>

                                <input type="range" id="abate-A" min="0" max="50" value="0" step="5" 

                                       oninput="updateSlider('A', 'abate')" onchange="updateScenario('A')"                                                            <select id="scenario-a-year" class="w-full px-3 py-2 bg-background border rounded-md text-sm">                    <div class="space-y-2">

                                       class="w-full">

                            </div>                            <!-- Tabs -->



                            <button onclick="resetScenario('A')" class="w-full px-4 py-2 border hover:bg-muted/50 rounded transition">                            <div class="border-b mb-6">                                    <option value="2023" selected>2023</option>                        <label for="insulation-level" class="text-sm font-medium text-foreground">Insulation Level</label>

                                Reset to Default

                            </button>                                <div class="flex gap-4">

                        </div>

                    </div>                                    <button onclick="switchTab('industry')" class="tab-btn px-4 py-2 font-medium border-b-2 border-primary" data-tab="industry">                                    <option value="2022">2022</option>                        <select



                    <!-- Scenario B Controls -->                                        Industry Breakdown

                    <div id="controls-B" class="bg-green-50 dark:bg-green-950 border-2 border-green-300 dark:border-green-700 rounded-lg p-6">

                        <h3 class="text-xl font-bold mb-4">Scenario B (Policy)</h3>                                    </button>                                    <option value="2021">2021</option>                            id="insulation-level"

                        

                        <div class="space-y-4">                                    <button onclick="switchTab('emitters')" class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-muted-foreground/30 transition" data-tab="emitters">

                            <div>

                                <label class="block text-sm font-medium mb-2">Industries</label>                                        Top Emitters                                    <option value="2020">2020</option>                            class="w-full px-3 py-2 text-sm bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"

                                <div class="space-y-2">

                                    <label class="flex items-center gap-2">                                    </button>

                                        <input type="checkbox" checked onchange="updateScenario('B')" class="industry-checkbox-B" value="Steel">

                                        <span>Steel</span>                                    <button onclick="switchTab('geographic')" class="tab-btn px-4 py-2 font-medium border-b-2 border-transparent hover:border-muted-foreground/30 transition" data-tab="geographic">                                    <option value="2019">2019</option>                        >

                                    </label>

                                    <label class="flex items-center gap-2">                                        Geographic

                                        <input type="checkbox" checked onchange="updateScenario('B')" class="industry-checkbox-B" value="Cement">

                                        <span>Cement</span>                                    </button>                                </select>                            <option value="standard">Standard</option>

                                    </label>

                                    <label class="flex items-center gap-2">                                </div>

                                        <input type="checkbox" checked onchange="updateScenario('B')" class="industry-checkbox-B" value="Chemicals">

                                        <span>Chemicals</span>                            </div>                            </div>                            <option value="improved">Improved</option>

                                    </label>

                                </div>

                            </div>

                            <!-- Tab Content -->                            <option value="high">High Performance</option>

                            <div>

                                <label class="block text-sm font-medium mb-2">State</label>                            <div id="tab-industry" class="tab-content">

                                <select id="state-B" onchange="updateScenario('B')" class="w-full px-3 py-2 border rounded bg-background">

                                    <option value="all">All States</option>                                <div class="grid grid-cols-2 gap-8 mb-6">                            <!-- Carbon Tax -->                        </select>

                                    <option value="CA">California</option>

                                    <option value="TX">Texas</option>                                    <div>

                                    <option value="IN">Indiana</option>

                                    <option value="PA">Pennsylvania</option>                                        <h3 class="text-center font-semibold mb-3 text-blue-600 dark:text-blue-400">BASELINE (A)</h3>                            <div>                    </div>

                                </select>

                            </div>                                        <canvas id="chart-baseline-pie" height="250"></canvas>



                            <div>                                    </div>                                <label class="block text-sm font-medium text-foreground mb-2">

                                <label class="block text-sm font-medium mb-2">Year</label>

                                <select id="year-B" onchange="updateScenario('B')" class="w-full px-3 py-2 border rounded bg-background">                                    <div>

                                    <option value="2023">2023</option>

                                    <option value="2022">2022</option>                                        <h3 class="text-center font-semibold mb-3 text-green-600 dark:text-green-400">POLICY (B)</h3>                                    Carbon Tax: $<span id="scenario-a-tax-value">0</span>/ton                    <!-- Building Type -->

                                    <option value="2021">2021</option>

                                </select>                                        <canvas id="chart-policy-pie" height="250"></canvas>

                            </div>

                                    </div>                                </label>                    <div class="space-y-2">

                            <div>

                                <label class="block text-sm font-medium mb-2">                                </div>

                                    Carbon Tax: <span id="tax-value-B" class="font-bold">$50</span>/ton

                                </label>                                <div class="mt-8">                                <input type="range" id="scenario-a-tax" min="0" max="200" value="0" step="10"                        <label for="building-type" class="text-sm font-medium text-foreground">Building Type</label>

                                <input type="range" id="tax-B" min="0" max="200" value="50" step="5" 

                                       oninput="updateSlider('B', 'tax')" onchange="updateScenario('B')"                                    <h3 class="text-center font-semibold mb-4">Side-by-Side Comparison</h3>

                                       class="w-full">

                            </div>                                    <canvas id="chart-comparison-bar" height="120"></canvas>                                    class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary">                        <select



                            <div>                                </div>

                                <label class="block text-sm font-medium mb-2">

                                    Abatement Required: <span id="abate-value-B" class="font-bold">20</span>%                            </div>                            </div>                            id="building-type"

                                </label>

                                <input type="range" id="abate-B" min="0" max="50" value="20" step="5" 

                                       oninput="updateSlider('B', 'abate')" onchange="updateScenario('B')"

                                       class="w-full">                            <div id="tab-emitters" class="tab-content hidden">                            class="w-full px-3 py-2 text-sm bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"

                            </div>

                                <div class="bg-muted/30 rounded-lg p-4">

                            <button onclick="copyFromA()" class="w-full px-4 py-2 border hover:bg-muted/50 rounded transition">

                                Copy from Scenario A                                    <div class="flex justify-between items-center mb-4">                            <!-- Abatement -->                        >

                            </button>

                        </div>                                        <h3 class="font-semibold">üè≠ Top 10 Most Impacted Facilities</h3>

                    </div>

                </div>                                        <select id="sort-select" onchange="sortFacilities()" class="px-3 py-1 border rounded bg-background">                            <div>                            <option value="residential">Residential</option>



                <div class="mt-6 flex justify-center gap-4">                                            <option value="absolute">Absolute Reduction</option>

                    <button onclick="applyScenarioChanges()" class="px-8 py-3 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg font-semibold transition">

                        Update Comparison                                            <option value="percent">% Reduction</option>                                <label class="block text-sm font-medium text-foreground mb-2">                            <option value="commercial">Commercial</option>

                    </button>

                    <button onclick="closeScenarioDrawer()" class="px-8 py-3 border hover:bg-muted/50 rounded-lg font-semibold transition">                                            <option value="cost">Cost Impact</option>

                        Cancel

                    </button>                                        </select>                                    Abatement Rate: <span id="scenario-a-abatement-value">0</span>%                        </select>

                </div>

            </div>                                    </div>

        </div>

    </div>                                    <div class="overflow-x-auto">                                </label>                    </div>



    <script>                                        <table class="w-full text-sm">

        // Load header

        fetch('/static/header.html?' + Date.now())                                            <thead class="bg-muted">                                <input type="range" id="scenario-a-abatement" min="0" max="40" value="0" step="5"

            .then(response => response.text())

            .then(html => {                                                <tr>

                document.getElementById('header-container').innerHTML = html;

                highlightActiveNav();                                                    <th class="px-4 py-2 text-left">#</th>                                    class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary">                    <!-- Square Footage -->

            });

                                                    <th class="px-4 py-2 text-left">Facility</th>

        function highlightActiveNav() {

            const navLinks = document.querySelectorAll('nav a');                                                    <th class="px-4 py-2 text-left">Industry</th>                            </div>                    <div class="space-y-2">

            navLinks.forEach(link => {

                if (link.dataset.page === 'comparison') {                                                    <th class="px-4 py-2 text-right">Baseline</th>

                    link.classList.add('border-primary', 'text-foreground');

                    link.classList.remove('border-transparent', 'text-muted-foreground');                                                    <th class="px-4 py-2 text-right">Policy</th>                        </div>                        <label for="square-footage" class="text-sm font-medium text-foreground">Square Footage</label>

                }

            });                                                    <th class="px-4 py-2 text-right">Impact</th>

        }

                                                    <th class="px-4 py-2 text-right">Cost</th>                    </div>                        <input

        // Global state

        let scenarioA = {                                                    <th class="px-4 py-2 text-center">Status</th>

            industries: ['Steel', 'Cement', 'Chemicals'],

            state: 'all',                                                </tr>                            type="number"

            year: '2023',

            carbonTax: 0,                                            </thead>

            abatement: 0

        };                                            <tbody id="facilities-table-body">                    <!-- Scenario B (Alternative) -->                            id="square-footage"



        let scenarioB = {                                                <!-- Populated by JS -->

            industries: ['Steel', 'Cement', 'Chemicals'],

            state: 'all',                                            </tbody>                    <div class="bg-card border rounded-lg p-6">                            value="2000"

            year: '2023',

            carbonTax: 50,                                        </table>

            abatement: 20

        };                                    </div>                        <div class="flex items-center justify-between mb-4">                            min="500"



        let facilitiesData = [];                                </div>

        let charts = {};

                            </div>                            <h2 class="text-lg font-semibold text-foreground">Scenario B: Alternative</h2>                            max="50000"

        // Scenario drawer functions

        function openScenarioDrawer(scenario) {

            document.getElementById('scenario-drawer').classList.remove('hidden');

            if (scenario === 'A') {                            <div id="tab-geographic" class="tab-content hidden">                            <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded">ALT</span>                            step="100"

                document.getElementById('controls-A').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } else {                                <div class="text-center py-12 text-muted-foreground">

                document.getElementById('controls-B').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            }                                    <p class="text-lg">Geographic breakdown visualization coming soon</p>                        </div>                            class="w-full px-3 py-2 text-sm bg-background border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"

        }

                                    <p class="text-sm mt-2">Will show state-by-state comparison on a map</p>

        function closeScenarioDrawer(event) {

            if (!event || event.target.id === 'scenario-drawer') {                                </div>                        >

                document.getElementById('scenario-drawer').classList.add('hidden');

            }                            </div>

        }

                        </div>                        <div class="space-y-4">                    </div>

        function updateSlider(scenario, type) {

            const value = document.getElementById(`${type}-${scenario}`).value;                    </div>

            document.getElementById(`${type}-value-${scenario}`).textContent = 

                type === 'tax' ? `$${value}` : value;                            <!-- Industry Filter -->

        }

                    <!-- Export Actions -->

        function updateScenario(scenario) {

            const target = scenario === 'A' ? scenarioA : scenarioB;                    <div id="export-section" class="hidden">                            <div>                    <!-- Calculate Button -->

            

            // Update industries                        <div class="flex justify-center gap-4">

            const checkboxes = document.querySelectorAll(`.industry-checkbox-${scenario}:checked`);

            target.industries = Array.from(checkboxes).map(cb => cb.value);                            <button onclick="downloadCSV()" class="px-6 py-2 bg-card border hover:bg-muted/50 rounded-lg font-medium transition">                                <label class="block text-sm font-medium text-foreground mb-2">Industries</label>                    <button

            

            // Update other fields                                üì• Download Full Comparison Report CSV

            target.state = document.getElementById(`state-${scenario}`).value;

            target.year = document.getElementById(`year-${scenario}`).value;                            </button>                                <div class="space-y-2">                        id="calculate-btn"

            target.carbonTax = parseInt(document.getElementById(`tax-${scenario}`).value);

            target.abatement = parseInt(document.getElementById(`abate-${scenario}`).value);                            <button onclick="saveScenario()" class="px-6 py-2 bg-card border hover:bg-muted/50 rounded-lg font-medium transition">

            

            // Update display                                üíæ Save Scenario                                    <label class="flex items-center gap-2 text-sm">                        class="w-full px-4 py-2 text-sm font-medium text-primary-foreground bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"

            updateScenarioDisplay(scenario);

        }                            </button>



        function updateScenarioDisplay(scenario) {                            <button onclick="shareLink()" class="px-6 py-2 bg-card border hover:bg-muted/50 rounded-lg font-medium transition">                                        <input type="checkbox" name="scenario-b-industry" value="steel" checked class="rounded">                    >

            const data = scenario === 'A' ? scenarioA : scenarioB;

            document.getElementById(`scenario${scenario}-tax-display`).textContent = `$${data.carbonTax}`;                                üîó Share Link

            document.getElementById(`scenario${scenario}-abate-display`).textContent = data.abatement;

            document.getElementById(`scenario${scenario}-industries-display`).textContent =                             </button>                                        <div class="w-3 h-3 rounded-full bg-red-500"></div>                        Calculate Impact

                data.industries.length === 3 ? 'All' : data.industries.join(', ');

        }                        </div>



        function resetScenario(scenario) {                    </div>                                        Steel                    </button>

            if (scenario === 'A') {

                scenarioA = {

                    industries: ['Steel', 'Cement', 'Chemicals'],

                    state: 'all',                </div>                                    </label>

                    year: '2023',

                    carbonTax: 0,            </div>

                    abatement: 0

                };        </div>                                    <label class="flex items-center gap-2 text-sm">                    <!-- Loading -->

                document.getElementById('tax-A').value = 0;

                document.getElementById('abate-A').value = 0;    </div>

                document.getElementById('state-A').value = 'all';

                document.getElementById('year-A').value = '2023';                                        <input type="checkbox" name="scenario-b-industry" value="cement" checked class="rounded">                    <div id="loading" class="hidden text-center py-4">

                document.querySelectorAll('.industry-checkbox-A').forEach(cb => cb.checked = true);

            } else {    <!-- Scenario Controls Drawer (Modal Overlay) -->

                scenarioB = {

                    industries: ['Steel', 'Cement', 'Chemicals'],    <div id="scenario-drawer" class="fixed inset-0 bg-black/50 hidden z-50" onclick="closeScenarioDrawer(event)">                                        <div class="w-3 h-3 rounded-full bg-gray-500"></div>                        <p class="text-sm text-muted-foreground">‚è≥ Calculating...</p>

                    state: 'all',

                    year: '2023',        <div class="absolute bottom-0 left-0 right-0 bg-background border-t shadow-2xl" onclick="event.stopPropagation()">

                    carbonTax: 50,

                    abatement: 20            <div class="p-8 max-w-7xl mx-auto">                                        Cement                    </div>

                };

                document.getElementById('tax-B').value = 50;                <div class="flex justify-between items-center mb-6">

                document.getElementById('abate-B').value = 20;

                document.getElementById('state-B').value = 'all';                    <h2 class="text-2xl font-bold">Scenario Controls</h2>                                    </label>

                document.getElementById('year-B').value = '2023';

                document.querySelectorAll('.industry-checkbox-B').forEach(cb => cb.checked = true);                    <button onclick="closeScenarioDrawer()" class="px-4 py-2 hover:bg-muted rounded">‚úï Close</button>

            }

            updateSlider(scenario, 'tax');                </div>                                    <label class="flex items-center gap-2 text-sm">                    <!-- Results -->

            updateSlider(scenario, 'abate');

            updateScenarioDisplay(scenario);

        }

                <div class="grid grid-cols-2 gap-8">                                        <input type="checkbox" name="scenario-b-industry" value="chemicals" checked class="rounded">                    <div id="results" class="hidden space-y-4">

        function copyFromA() {

            scenarioB = JSON.parse(JSON.stringify(scenarioA));                    <!-- Scenario A Controls -->

            document.getElementById('tax-B').value = scenarioA.carbonTax;

            document.getElementById('abate-B').value = scenarioA.abatement;                    <div id="controls-A" class="bg-blue-50 dark:bg-blue-950 border-2 border-blue-300 dark:border-blue-700 rounded-lg p-6">                                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>                        <h3 class="text-base font-semibold text-foreground">Results</h3>

            document.getElementById('state-B').value = scenarioA.state;

            document.getElementById('year-B').value = scenarioA.year;                        <h3 class="text-xl font-bold mb-4">Scenario A (Baseline)</h3>

            document.querySelectorAll('.industry-checkbox-B').forEach(cb => {

                cb.checked = scenarioA.industries.includes(cb.value);                                                                Chemicals                        <div class="rounded-lg border bg-card p-4 space-y-3">

            });

            updateSlider('B', 'tax');                        <div class="space-y-4">

            updateSlider('B', 'abate');

            updateScenarioDisplay('B');                            <div>                                    </label>                            <div class="flex justify-between items-center text-sm">

        }

                                <label class="block text-sm font-medium mb-2">Industries</label>

        function applyScenarioChanges() {

            closeScenarioDrawer();                                <div class="space-y-2">                                </div>                                <span class="text-muted-foreground">Annual Energy Usage</span>

            calculateComparison();

        }                                    <label class="flex items-center gap-2">



        // Tab switching                                        <input type="checkbox" checked onchange="updateScenario('A')" class="industry-checkbox-A" value="Steel">                            </div>                                <span class="font-medium text-foreground" id="result-usage">-</span>

        function switchTab(tab) {

            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));                                        <span>Steel</span>

            document.querySelectorAll('.tab-btn').forEach(btn => {

                btn.classList.remove('border-primary');                                    </label>                            </div>

                btn.classList.add('border-transparent');

            });                                    <label class="flex items-center gap-2">

            

            document.getElementById(`tab-${tab}`).classList.remove('hidden');                                        <input type="checkbox" checked onchange="updateScenario('A')" class="industry-checkbox-A" value="Cement">                            <!-- State Filter -->                            <div class="flex justify-between items-center text-sm border-t pt-3">

            document.querySelector(`[data-tab="${tab}"]`).classList.add('border-primary');

            document.querySelector(`[data-tab="${tab}"]`).classList.remove('border-transparent');                                        <span>Cement</span>

        }

                                    </label>                            <div>                                <span class="text-muted-foreground">Annual Cost</span>

        // Main calculation function

        function calculateComparison() {                                    <label class="flex items-center gap-2">

            // Generate sample data

            generateSampleData();                                        <input type="checkbox" checked onchange="updateScenario('A')" class="industry-checkbox-A" value="Chemicals">                                <label class="block text-sm font-medium text-foreground mb-2">State</label>                                <span class="font-medium text-foreground" id="result-cost">-</span>

            

            // Calculate metrics                                        <span>Chemicals</span>

            const resultsA = calculateScenario(scenarioA);

            const resultsB = calculateScenario(scenarioB);                                    </label>                                <select id="scenario-b-state" class="w-full px-3 py-2 bg-background border rounded-md text-sm">                            </div>

            

            // Update impacts section                                </div>

            updateImpactsSection(resultsA, resultsB);

                                        </div>                                    <option value="">All States</option>                            <div class="flex justify-between items-center text-sm border-t pt-3">

            // Create charts

            createCharts(resultsA, resultsB);

            

            // Populate facilities table                            <div>                                    <option value="TX">Texas</option>                                <span class="text-muted-foreground">Annual Emissions</span>

            populateFacilitiesTable(resultsA, resultsB);

                                            <label class="block text-sm font-medium mb-2">State</label>

            // Show results sections

            document.getElementById('impacts-section').classList.remove('hidden');                                <select id="state-A" onchange="updateScenario('A')" class="w-full px-3 py-2 border rounded bg-background">                                    <option value="CA">California</option>                                <span class="font-medium text-foreground" id="result-emissions">-</span>

            document.getElementById('detailed-section').classList.remove('hidden');

            document.getElementById('export-section').classList.remove('hidden');                                    <option value="all">All States</option>

            

            // Smooth scroll to results                                    <option value="CA">California</option>                                    <option value="PA">Pennsylvania</option>                            </div>

            document.getElementById('impacts-section').scrollIntoView({ behavior: 'smooth' });

        }                                    <option value="TX">Texas</option>



        function generateSampleData() {                                    <option value="IN">Indiana</option>                                    <option value="IN">Indiana</option>                            <div class="flex justify-between items-center text-sm border-t pt-3">

            const industries = ['Steel', 'Cement', 'Chemicals'];

            const states = ['IN', 'TX', 'CA', 'PA', 'OH', 'IL', 'MI', 'AL'];                                    <option value="PA">Pennsylvania</option>

            const facilities = [

                'US Steel Gary Works', 'ArcelorMittal Burns Harbor', 'Cleveland-Cliffs Indiana Harbor',                                </select>                                    <option value="OH">Ohio</option>                                <span class="text-muted-foreground">Peak Demand</span>

                'Nucor Steel', 'Big River Steel', 'Cemex Cement Plant', 'LafargeHolcim Texas',

                'Heidelberg Cement', 'Dow Chemical Freeport', 'BASF Geismar', 'ExxonMobil Baytown',                            </div>

                'DuPont La Porte', 'Chevron Phillips Cedar Bayou', 'Shell Deer Park'

            ];                                    <option value="IL">Illinois</option>                                <span class="font-medium text-foreground" id="result-peak">-</span>

            

            facilitiesData = [];                            <div>

            for (let i = 0; i < 20; i++) {

                const industry = industries[Math.floor(Math.random() * industries.length)];                                <label class="block text-sm font-medium mb-2">Year</label>                                    <option value="LA">Louisiana</option>                            </div>

                const baseEmissions = Math.random() * 8 + 2; // 2-10 MT

                                                <select id="year-A" onchange="updateScenario('A')" class="w-full px-3 py-2 border rounded bg-background">

                facilitiesData.push({

                    id: i + 1,                                    <option value="2023">2023</option>                                    <option value="MI">Michigan</option>                            <div class="flex justify-between items-center text-sm border-t pt-3">

                    name: facilities[i % facilities.length],

                    city: ['Gary', 'Houston', 'Freeport', 'La Porte', 'Burns Harbor'][Math.floor(Math.random() * 5)],                                    <option value="2022">2022</option>

                    state: states[Math.floor(Math.random() * states.length)],

                    industry: industry,                                    <option value="2021">2021</option>                                    <option value="AL">Alabama</option>                                <span class="text-muted-foreground">Renewable %</span>

                    baseEmissions: baseEmissions

                });                                </select>

            }

        }                            </div>                                </select>                                <span class="font-medium text-foreground" id="result-renewable">-</span>



        function calculateScenario(scenario) {

            // Filter facilities by scenario parameters

            let filtered = facilitiesData.filter(f =>                             <div>                            </div>                            </div>

                scenario.industries.includes(f.industry) &&

                (scenario.state === 'all' || f.state === scenario.state)                                <label class="block text-sm font-medium mb-2">

            );

                                                Carbon Tax: <span id="tax-value-A" class="font-bold">$0</span>/ton                        </div>

            let totalEmissions = 0;

            let totalRevenue = 0;                                </label>

            let byIndustry = { Steel: 0, Cement: 0, Chemicals: 0 };

                                            <input type="range" id="tax-A" min="0" max="200" value="0" step="5"                             <!-- Year -->                    </div>

            filtered.forEach(f => {

                // Apply abatement                                       oninput="updateSlider('A', 'tax')" onchange="updateScenario('A')"

                const reducedEmissions = f.baseEmissions * (1 - scenario.abatement / 100);

                totalEmissions += reducedEmissions;                                       class="w-full">                            <div>

                

                // Calculate revenue                            </div>

                totalRevenue += reducedEmissions * scenario.carbonTax;

                                                <label class="block text-sm font-medium text-foreground mb-2">Year</label>                    <!-- Debug panel (now inside scrollable area) -->

                // By industry

                byIndustry[f.industry] += reducedEmissions;                            <div>

            });

                                            <label class="block text-sm font-medium mb-2">                                <select id="scenario-b-year" class="w-full px-3 py-2 bg-background border rounded-md text-sm">                    <div>

            return {

                totalEmissions,                                    Abatement Required: <span id="abate-value-A" class="font-bold">0</span>%

                totalRevenue,

                byIndustry,                                </label>                                    <option value="2023" selected>2023</option>                        <div id="integration-panel" class="rounded-lg border p-3 bg-card">

                facilitiesCount: filtered.length,

                facilities: filtered.map(f => ({                                <input type="range" id="abate-A" min="0" max="50" value="0" step="5" 

                    ...f,

                    reducedEmissions: f.baseEmissions * (1 - scenario.abatement / 100),                                       oninput="updateSlider('A', 'abate')" onchange="updateScenario('A')"                                    <option value="2022">2022</option>                            <div class="flex items-center justify-between">

                    cost: f.baseEmissions * (1 - scenario.abatement / 100) * scenario.carbonTax

                }))                                       class="w-full">

            };

        }                            </div>                                    <option value="2021">2021</option>                                <h3 class="text-sm font-semibold text-foreground">Integrations & Debug</h3>



        function updateImpactsSection(resultsA, resultsB) {

            const emissionsDiff = resultsA.totalEmissions - resultsB.totalEmissions;

            const reductionPercent = ((emissionsDiff / resultsA.totalEmissions) * 100).toFixed(1);                            <button onclick="resetScenario('A')" class="w-full px-4 py-2 border hover:bg-muted/50 rounded transition">                                    <option value="2020">2020</option>                                <button

            const revenueDiff = resultsB.totalRevenue - resultsA.totalRevenue;

            const costEfficiency = revenueDiff > 0 && emissionsDiff > 0                                 Reset to Default

                ? Math.round(revenueDiff / emissionsDiff * 1000000) 

                : 0;                            </button>                                    <option value="2019">2019</option>                                    id="integration-toggle"

            

            // Update emissions                        </div>

            document.getElementById('impact-base-emissions').textContent = resultsA.totalEmissions.toFixed(1) + ' MT';

            document.getElementById('impact-policy-emissions').textContent = resultsB.totalEmissions.toFixed(1) + ' MT';                    </div>                                </select>                                    aria-expanded="false"

            

            const arrow = emissionsDiff >= 0 ? '‚¨á' : '‚¨Ü';

            const sign = emissionsDiff >= 0 ? '' : '+';

            const color = emissionsDiff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';                    <!-- Scenario B Controls -->                            </div>                                    class="text-xs text-muted-foreground px-2 py-1 rounded hover:bg-muted"

            

            document.getElementById('impact-reduction').textContent =                     <div id="controls-B" class="bg-green-50 dark:bg-green-950 border-2 border-green-300 dark:border-green-700 rounded-lg p-6">

                `${arrow} ${sign}${Math.abs(emissionsDiff).toFixed(1)} MT (${Math.abs(reductionPercent)}% ${emissionsDiff >= 0 ? 'reduction' : 'increase'})`;

            document.getElementById('impact-reduction').className = `text-3xl font-bold ${color}`;                        <h3 class="text-xl font-bold mb-4">Scenario B (Policy)</h3>                                    title="Toggle"

            

            document.getElementById('reduction-percent').textContent = Math.abs(reductionPercent) + '%';                        

            document.getElementById('reduction-bar').style.width = Math.min(Math.abs(reductionPercent), 100) + '%';

                                    <div class="space-y-4">                            <!-- Carbon Tax -->                                >+</button>

            // Update revenue

            document.getElementById('revenue-base').textContent = '$' + (resultsA.totalRevenue / 1000000).toFixed(1) + 'M';                            <div>

            document.getElementById('revenue-policy').textContent = '$' + (resultsB.totalRevenue / 1000000).toFixed(1) + 'M';

                                            <label class="block text-sm font-medium mb-2">Industries</label>                            <div>                            </div>

            const revenueArrow = revenueDiff >= 0 ? '‚¨Ü' : '‚¨á';

            const revenueSign = revenueDiff >= 0 ? '+' : '';                                <div class="space-y-2">

            document.getElementById('revenue-diff').textContent = 

                `${revenueArrow} ${revenueSign}$${(revenueDiff / 1000000).toFixed(1)}M`;                                    <label class="flex items-center gap-2">                                <label class="block text-sm font-medium text-foreground mb-2">                            <div id="integration-status" class="hidden text-sm text-muted-foreground mt-2 space-y-1">

            

            // Update cost efficiency                                        <input type="checkbox" checked onchange="updateScenario('B')" class="industry-checkbox-B" value="Steel">

            document.getElementById('cost-efficiency').textContent = costEfficiency > 0 ? `$${costEfficiency}` : 'N/A';

                                                    <span>Steel</span>                                    Carbon Tax: $<span id="scenario-b-tax-value">50</span>/ton                                <div>Mapbox Token: <span id="mapbox-token-status">checking‚Ä¶</span></div>

            // Update facilities

            document.getElementById('facilities-count').textContent = resultsB.facilitiesCount;                                    </label>

            const totalFacilities = facilitiesData.length;

            const facilityPercent = ((resultsB.facilitiesCount / totalFacilities) * 100).toFixed(0);                                    <label class="flex items-center gap-2">                                </label>                                <div>Map Loaded: <span id="map-loaded-status">no</span></div>

            document.getElementById('facilities-percent').textContent = `${facilityPercent}% of total`;

        }                                        <input type="checkbox" checked onchange="updateScenario('B')" class="industry-checkbox-B" value="Cement">



        function createCharts(resultsA, resultsB) {                                        <span>Cement</span>                                <input type="range" id="scenario-b-tax" min="0" max="200" value="50" step="10"                                <div>Palmetto API: <span id="palmetto-status">checking‚Ä¶</span></div>

            // Destroy existing charts

            Object.values(charts).forEach(chart => chart.destroy());                                    </label>

            charts = {};

                                                <label class="flex items-center gap-2">                                    class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary">                                <div>Server Health: <span id="server-health-status">checking‚Ä¶</span></div>

            const industries = ['Steel', 'Cement', 'Chemicals'];

            const colors = {                                        <input type="checkbox" checked onchange="updateScenario('B')" class="industry-checkbox-B" value="Chemicals">

                Steel: '#ef4444',

                Cement: '#8b5cf6',                                        <span>Chemicals</span>                            </div>                            </div>

                Chemicals: '#f59e0b'

            };                                    </label>

            

            // Baseline Pie                                </div>                        </div>

            charts.baselinePie = new Chart(document.getElementById('chart-baseline-pie'), {

                type: 'doughnut',                            </div>

                data: {

                    labels: industries,                            <!-- Abatement -->                    </div>

                    datasets: [{

                        data: industries.map(ind => resultsA.byIndustry[ind].toFixed(1)),                            <div>

                        backgroundColor: industries.map(ind => colors[ind])

                    }]                                <label class="block text-sm font-medium mb-2">State</label>                            <div>                </div>

                },

                options: {                                <select id="state-B" onchange="updateScenario('B')" class="w-full px-3 py-2 border rounded bg-background">

                    responsive: true,

                    maintainAspectRatio: false,                                    <option value="all">All States</option>                                <label class="block text-sm font-medium text-foreground mb-2">            </div>

                    plugins: {

                        legend: { position: 'bottom' },                                    <option value="CA">California</option>

                        tooltip: {

                            callbacks: {                                    <option value="TX">Texas</option>                                    Abatement Rate: <span id="scenario-b-abatement-value">20</span>%        </aside>

                                label: (context) => `${context.label}: ${context.parsed} MT`

                            }                                    <option value="IN">Indiana</option>

                        }

                    }                                    <option value="PA">Pennsylvania</option>                                </label>

                }

            });                                </select>

            

            // Policy Pie                            </div>                                <input type="range" id="scenario-b-abatement" min="0" max="40" value="20" step="5"        <!-- Map Container -->

            charts.policyPie = new Chart(document.getElementById('chart-policy-pie'), {

                type: 'doughnut',

                data: {

                    labels: industries,                            <div>                                    class="w-full h-2 bg-secondary rounded-lg appearance-none cursor-pointer accent-primary">        <main class="flex-1 relative bg-muted">

                    datasets: [{

                        data: industries.map(ind => resultsB.byIndustry[ind].toFixed(1)),                                <label class="block text-sm font-medium mb-2">Year</label>

                        backgroundColor: industries.map(ind => colors[ind])

                    }]                                <select id="year-B" onchange="updateScenario('B')" class="w-full px-3 py-2 border rounded bg-background">                            </div>            <div id="map" class="w-full h-full"></div>

                },

                options: {                                    <option value="2023">2023</option>

                    responsive: true,

                    maintainAspectRatio: false,                                    <option value="2022">2022</option>                        </div>

                    plugins: {

                        legend: { position: 'bottom' },                                    <option value="2021">2021</option>

                        tooltip: {

                            callbacks: {                                </select>                    </div>            <!-- Legend -->

                                label: (context) => `${context.label}: ${context.parsed} MT`

                            }                            </div>

                        }

                    }                </div>            <div class="absolute bottom-4 right-4 rounded-lg border bg-card shadow-lg p-4">

                }

            });                            <div>

            

            // Comparison Bar                                <label class="block text-sm font-medium mb-2">                <h3 class="text-sm font-semibold text-foreground mb-3">Emissions by District</h3>

            charts.comparisonBar = new Chart(document.getElementById('chart-comparison-bar'), {

                type: 'bar',                                    Carbon Tax: <span id="tax-value-B" class="font-bold">$50</span>/ton

                data: {

                    labels: industries,                                </label>                <!-- Calculate Button -->                <div class="space-y-2">

                    datasets: [

                        {                                <input type="range" id="tax-B" min="0" max="200" value="50" step="5" 

                            label: 'Baseline',

                            data: industries.map(ind => resultsA.byIndustry[ind].toFixed(1)),                                       oninput="updateSlider('B', 'tax')" onchange="updateScenario('B')"                <div class="flex justify-center">                    <div class="flex items-center gap-2 text-xs">

                            backgroundColor: '#3b82f6'

                        },                                       class="w-full">

                        {

                            label: 'Policy',                            </div>                    <button id="compare-btn"                         <div class="w-4 h-4 rounded" style="background: #22c55e;"></div>

                            data: industries.map(ind => resultsB.byIndustry[ind].toFixed(1)),

                            backgroundColor: '#10b981'

                        }

                    ]                            <div>                        class="px-6 py-3 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 font-medium shadow-sm">                        <span class="text-muted-foreground">Low (&lt; 5,000 kg CO‚ÇÇ)</span>

                },

                options: {                                <label class="block text-sm font-medium mb-2">

                    responsive: true,

                    maintainAspectRatio: false,                                    Abatement Required: <span id="abate-value-B" class="font-bold">20</span>%                        Compare Scenarios                    </div>

                    plugins: {

                        legend: { position: 'top' }                                </label>

                    },

                    scales: {                                <input type="range" id="abate-B" min="0" max="50" value="20" step="5"                     </button>                    <div class="flex items-center gap-2 text-xs">

                        y: {

                            beginAtZero: true,                                       oninput="updateSlider('B', 'abate')" onchange="updateScenario('B')"

                            title: { display: true, text: 'Emissions (MT CO‚ÇÇe)' }

                        }                                       class="w-full">                </div>                        <div class="w-4 h-4 rounded" style="background: #eab308;"></div>

                    }

                }                            </div>

            });

        }                        <span class="text-muted-foreground">Medium (5,000-10,000)</span>



        function populateFacilitiesTable(resultsA, resultsB) {                            <button onclick="copyFromA()" class="w-full px-4 py-2 border hover:bg-muted/50 rounded transition">

            const tbody = document.getElementById('facilities-table-body');

                                            Copy from Scenario A                <!-- Comparison Summary Cards -->                    </div>

            // Merge results

            const merged = resultsA.facilities.map(fA => {                            </button>

                const fB = resultsB.facilities.find(f => f.id === fA.id);

                const diff = fA.reducedEmissions - (fB ? fB.reducedEmissions : fA.baseEmissions);                        </div>                <div class="grid grid-cols-3 gap-6">                    <div class="flex items-center gap-2 text-xs">

                const diffPercent = ((diff / fA.baseEmissions) * 100).toFixed(1);

                                    </div>

                return {

                    ...fA,                </div>                    <div class="bg-card border rounded-lg p-6">                        <div class="w-4 h-4 rounded" style="background: #f97316;"></div>

                    emissionsB: fB ? fB.reducedEmissions : fA.baseEmissions,

                    costB: fB ? fB.cost : 0,

                    diff: diff,

                    diffPercent: parseFloat(diffPercent),                <div class="mt-6 flex justify-center gap-4">                        <h3 class="text-sm font-medium text-muted-foreground mb-2">Total Emissions</h3>                        <span class="text-muted-foreground">High (10,000-15,000)</span>

                    diffAbs: Math.abs(diff)

                };                    <button onclick="applyScenarioChanges()" class="px-8 py-3 bg-primary hover:bg-primary/90 text-primary-foreground rounded-lg font-semibold transition">

            });

                                    Update Comparison                        <div class="flex items-baseline justify-between">                    </div>

            // Sort by absolute reduction (default)

            merged.sort((a, b) => b.diffAbs - a.diffAbs);                    </button>

            

            // Take top 10                    <button onclick="closeScenarioDrawer()" class="px-8 py-3 border hover:bg-muted/50 rounded-lg font-semibold transition">                            <div>                    <div class="flex items-center gap-2 text-xs">

            const top10 = merged.slice(0, 10);

                                    Cancel

            tbody.innerHTML = top10.map((f, idx) => {

                const arrow = f.diff >= 0 ? '‚¨á' : '‚¨Ü';                    </button>                                <div class="text-xs text-muted-foreground">Scenario A</div>                        <div class="w-4 h-4 rounded" style="background: #ef4444;"></div>

                const statusColor = f.diff >= 0 ? 'text-green-600' : 'text-red-600';

                                </div>

                return `

                    <tr class="border-b hover:bg-muted/30">            </div>                                <div class="text-2xl font-semibold text-blue-600" id="emissions-a">0 MT</div>                        <span class="text-muted-foreground">Very High (&gt; 15,000)</span>

                        <td class="px-4 py-3">${idx + 1}</td>

                        <td class="px-4 py-3">        </div>

                            <div class="font-medium">${f.name}</div>

                            <div class="text-xs text-muted-foreground">${f.city}, ${f.state}</div>    </div>                            </div>                    </div>

                        </td>

                        <td class="px-4 py-3">${f.industry}</td>

                        <td class="px-4 py-3 text-right font-mono">${f.reducedEmissions.toFixed(2)} MT</td>

                        <td class="px-4 py-3 text-right font-mono">${f.emissionsB.toFixed(2)} MT</td>    <script>                            <div class="text-right">                </div>

                        <td class="px-4 py-3 text-right font-mono">

                            <div class="${statusColor}">${arrow} ${f.diffAbs.toFixed(2)} MT</div>        // Load header

                            <div class="text-xs text-muted-foreground">${Math.abs(f.diffPercent)}%</div>

                        </td>        fetch('/static/header.html?' + Date.now())                                <div class="text-xs text-muted-foreground">Scenario B</div>            </div>

                        <td class="px-4 py-3 text-right font-mono">$${(f.costB / 1000).toFixed(0)}k</td>

                        <td class="px-4 py-3 text-center">            .then(response => response.text())

                            <span class="${statusColor}">‚úì</span>

                        </td>            .then(html => {                                <div class="text-2xl font-semibold text-green-600" id="emissions-b">0 MT</div>        </main>

                    </tr>

                `;                document.getElementById('header-container').innerHTML = html;

            }).join('');

        }                highlightActiveNav();                            </div>    </div>



        function sortFacilities() {            });

            // Re-run calculation with current sort

            calculateComparison();                        </div>

        }

        function highlightActiveNav() {

        // Export functions

        function downloadCSV() {            const navLinks = document.querySelectorAll('nav a');                        <div class="mt-2 pt-2 border-t">    <script>

            alert('CSV export functionality - would download full comparison data');

        }            navLinks.forEach(link => {



        function saveScenario() {                if (link.dataset.page === 'comparison') {                            <div class="text-sm font-medium" id="emissions-diff">Difference: 0 MT</div>        // Initialize map

            alert('Save scenario functionality - would save to backend');

        }                    link.classList.add('border-primary', 'text-foreground');



        function shareLink() {                    link.classList.remove('border-transparent', 'text-muted-foreground');                        </div>        let map;

            alert('Share link functionality - would generate shareable URL');

        }                }



        // Initialize displays            });                    </div>        let mapboxToken = '';

        updateScenarioDisplay('A');

        updateScenarioDisplay('B');        }

    </script>

</body>        let mapLoaded = false;

</html>

        // Global state

        let scenarioA = {                    <div class="bg-card border rounded-lg p-6">

            industries: ['Steel', 'Cement', 'Chemicals'],

            state: 'all',                        <h3 class="text-sm font-medium text-muted-foreground mb-2">Carbon Revenue</h3>        // Fetch config and initialize

            year: '2023',

            carbonTax: 0,                        <div class="flex items-baseline justify-between">        async function init() {

            abatement: 0

        };                            <div>            try {



        let scenarioB = {                                <div class="text-xs text-muted-foreground">Scenario A</div>                const response = await fetch('/api/config');

            industries: ['Steel', 'Cement', 'Chemicals'],

            state: 'all',                                <div class="text-2xl font-semibold text-blue-600" id="revenue-a">$0M</div>                const config = await response.json();

            year: '2023',

            carbonTax: 50,                            </div>                mapboxToken = config.mapbox_token || 'pk.eyJ1IjoiZXhhbXBsZSIsImEiOiJjbGV4YW1wbGUifQ.example';

            abatement: 20

        };                            <div class="text-right">



        let facilitiesData = [];                                <div class="text-xs text-muted-foreground">Scenario B</div>                mapboxgl.accessToken = mapboxToken;

        let charts = {};

                                <div class="text-2xl font-semibold text-green-600" id="revenue-b">$0M</div>                map = new mapboxgl.Map({

        // Scenario drawer functions

        function openScenarioDrawer(scenario) {                            </div>                    container: 'map',

            document.getElementById('scenario-drawer').classList.remove('hidden');

            if (scenario === 'A') {                        </div>                    style: 'mapbox://styles/mapbox/light-v11',

                document.getElementById('controls-A').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } else {                        <div class="mt-2 pt-2 border-t">                    center: config.default_center || [-80.8431, 35.2271],

                document.getElementById('controls-B').scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            }                            <div class="text-sm font-medium" id="revenue-diff">Difference: $0M</div>                    zoom: config.default_zoom || 10

        }

                        </div>                });

        function closeScenarioDrawer(event) {

            if (!event || event.target.id === 'scenario-drawer') {                    </div>

                document.getElementById('scenario-drawer').classList.add('hidden');

            }                map.on('load', () => {

        }

                    <div class="bg-card border rounded-lg p-6">                    mapLoaded = true;

        function updateSlider(scenario, type) {

            const value = document.getElementById(`${type}-${scenario}`).value;                        <h3 class="text-sm font-medium text-muted-foreground mb-2">Facilities Affected</h3>                    loadSampleData();

            document.getElementById(`${type}-value-${scenario}`).textContent = 

                type === 'tax' ? `$${value}` : value;                        <div class="flex items-baseline justify-between">                    updateIntegrationStatus();

        }

                            <div>                    document.getElementById('map-loaded-status').textContent = 'yes';

        function updateScenario(scenario) {

            const target = scenario === 'A' ? scenarioA : scenarioB;                                <div class="text-xs text-muted-foreground">Scenario A</div>                });

            

            // Update industries                                <div class="text-2xl font-semibold text-blue-600" id="facilities-a">0</div>            } catch (error) {

            const checkboxes = document.querySelectorAll(`.industry-checkbox-${scenario}:checked`);

            target.industries = Array.from(checkboxes).map(cb => cb.value);                            </div>                console.error('Error initializing:', error);

            

            // Update other fields                            <div class="text-right">                // Fallback if API is unavailable

            target.state = document.getElementById(`state-${scenario}`).value;

            target.year = document.getElementById(`year-${scenario}`).value;                                <div class="text-xs text-muted-foreground">Scenario B</div>                mapboxgl.accessToken = 'pk.eyJ1IjoiZXhhbXBsZSIsImEiOiJjbGV4YW1wbGUifQ.example';

            target.carbonTax = parseInt(document.getElementById(`tax-${scenario}`).value);

            target.abatement = parseInt(document.getElementById(`abate-${scenario}`).value);                                <div class="text-2xl font-semibold text-green-600" id="facilities-b">0</div>                map = new mapboxgl.Map({

            

            // Update display                            </div>                    container: 'map',

            updateScenarioDisplay(scenario);

        }                        </div>                    style: 'mapbox://styles/mapbox/light-v11',



        function updateScenarioDisplay(scenario) {                        <div class="mt-2 pt-2 border-t">                    center: [-80.8431, 35.2271],

            const data = scenario === 'A' ? scenarioA : scenarioB;

            document.getElementById(`scenario${scenario}-tax-display`).textContent = `$${data.carbonTax}`;                            <div class="text-sm font-medium" id="facilities-diff">Same facilities</div>                    zoom: 10

            document.getElementById(`scenario${scenario}-abate-display`).textContent = data.abatement;

            document.getElementById(`scenario${scenario}-industries-display`).textContent =                         </div>                });

                data.industries.length === 3 ? 'All' : data.industries.join(', ');

        }                    </div>                map.on('load', () => {



        function resetScenario(scenario) {                </div>                    mapLoaded = true;

            if (scenario === 'A') {

                scenarioA = {                    updateIntegrationStatus();

                    industries: ['Steel', 'Cement', 'Chemicals'],

                    state: 'all',                <!-- Charts Row -->                    document.getElementById('map-loaded-status').textContent = 'yes';

                    year: '2023',

                    carbonTax: 0,                <div class="grid grid-cols-2 gap-6">                });

                    abatement: 0

                };                    <!-- Emissions Comparison Chart -->            }

                document.getElementById('tax-A').value = 0;

                document.getElementById('abate-A').value = 0;                    <div class="bg-card border rounded-lg p-6">            // Initial integration status check even if map hasn't loaded yet

                document.getElementById('state-A').value = 'all';

                document.getElementById('year-A').value = '2023';                        <h3 class="text-sm font-semibold text-foreground mb-4">Emissions by Industry</h3>            updateIntegrationStatus();

                document.querySelectorAll('.industry-checkbox-A').forEach(cb => cb.checked = true);

            } else {                        <div class="h-64">        }

                scenarioB = {

                    industries: ['Steel', 'Cement', 'Chemicals'],                            <canvas id="emissions-chart"></canvas>

                    state: 'all',

                    year: '2023',                        </div>        // Load sample district data

                    carbonTax: 50,

                    abatement: 20                    </div>        async function loadSampleData() {

                };

                document.getElementById('tax-B').value = 50;            try {

                document.getElementById('abate-B').value = 20;

                document.getElementById('state-B').value = 'all';                    <!-- Revenue Comparison Chart -->                const response = await fetch('/api/sample-data');

                document.getElementById('year-B').value = '2023';

                document.querySelectorAll('.industry-checkbox-B').forEach(cb => cb.checked = true);                    <div class="bg-card border rounded-lg p-6">                const data = await response.json();

            }

            updateSlider(scenario, 'tax');                        <h3 class="text-sm font-semibold text-foreground mb-4">Carbon Revenue Comparison</h3>

            updateSlider(scenario, 'abate');

            updateScenarioDisplay(scenario);                        <div class="h-64">                // Create GeoJSON features for districts

        }

                            <canvas id="revenue-chart"></canvas>                const features = data.data.map((item, index) => ({

        function copyFromA() {

            scenarioB = JSON.parse(JSON.stringify(scenarioA));                        </div>                    type: 'Feature',

            document.getElementById('tax-B').value = scenarioA.carbonTax;

            document.getElementById('abate-B').value = scenarioA.abatement;                    </div>                    properties: {

            document.getElementById('state-B').value = scenarioA.state;

            document.getElementById('year-B').value = scenarioA.year;                </div>                        district: item.district.id,

            document.querySelectorAll('.industry-checkbox-B').forEach(cb => {

                cb.checked = scenarioA.industries.includes(cb.value);                        name: item.district.name,

            });

            updateSlider('B', 'tax');                <!-- Top 10 Facilities Comparison -->                        emissions: item.metrics.annual_emissions_kg_co2,

            updateSlider('B', 'abate');

            updateScenarioDisplay('B');                <div class="bg-card border rounded-lg p-6">                        cost: item.metrics.annual_cost_usd,

        }

                    <div class="flex items-center justify-between mb-4">                        usage: item.metrics.annual_kwh_usage

        function applyScenarioChanges() {

            closeScenarioDrawer();                        <h3 class="text-sm font-semibold text-foreground">Top 10 Facilities Impact</h3>                    },

            calculateComparison();

        }                        <button id="export-comparison-btn"                     geometry: {



        // Tab switching                            class="px-3 py-1 text-sm bg-secondary text-foreground rounded hover:bg-accent">                        type: 'Point',

        function switchTab(tab) {

            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));                            Export Comparison CSV                        coordinates: item.district.center

            document.querySelectorAll('.tab-btn').forEach(btn => {

                btn.classList.remove('border-primary');                        </button>                    }

                btn.classList.add('border-transparent');

            });                    </div>                }));

            

            document.getElementById(`tab-${tab}`).classList.remove('hidden');                    <div class="overflow-x-auto">

            document.querySelector(`[data-tab="${tab}"]`).classList.add('border-primary');

            document.querySelector(`[data-tab="${tab}"]`).classList.remove('border-transparent');                        <table class="w-full text-sm">                // Add source

        }

                            <thead class="bg-muted border-b">                if (!map.getSource('districts')) {

        // Main calculation function

        function calculateComparison() {                                <tr>                    map.addSource('districts', {

            // Generate sample data

            generateSampleData();                                    <th class="px-4 py-2 text-left text-xs font-medium text-muted-foreground uppercase">Facility</th>                        type: 'geojson',

            

            // Calculate metrics                                    <th class="px-4 py-2 text-left text-xs font-medium text-muted-foreground uppercase">Industry</th>                        data: {

            const resultsA = calculateScenario(scenarioA);

            const resultsB = calculateScenario(scenarioB);                                    <th class="px-4 py-2 text-right text-xs font-medium text-muted-foreground uppercase">Base Emissions</th>                            type: 'FeatureCollection',

            

            // Update impacts section                                    <th class="px-4 py-2 text-right text-xs font-medium text-muted-foreground uppercase">A: Cost</th>                            features: features

            updateImpactsSection(resultsA, resultsB);

                                                <th class="px-4 py-2 text-right text-xs font-medium text-muted-foreground uppercase">A: Reduced</th>                        }

            // Create charts

            createCharts(resultsA, resultsB);                                    <th class="px-4 py-2 text-right text-xs font-medium text-muted-foreground uppercase">B: Cost</th>                    });

            

            // Populate facilities table                                    <th class="px-4 py-2 text-right text-xs font-medium text-muted-foreground uppercase">B: Reduced</th>

            populateFacilitiesTable(resultsA, resultsB);

                                                <th class="px-4 py-2 text-right text-xs font-medium text-muted-foreground uppercase">Difference</th>                    // Add circle layer with color based on emissions

            // Show results sections

            document.getElementById('impacts-section').classList.remove('hidden');                                </tr>                    map.addLayer({

            document.getElementById('detailed-section').classList.remove('hidden');

            document.getElementById('export-section').classList.remove('hidden');                            </thead>                        id: 'district-circles',

            

            // Smooth scroll to results                            <tbody id="comparison-table-body" class="divide-y divide-border">                        type: 'circle',

            document.getElementById('impacts-section').scrollIntoView({ behavior: 'smooth' });

        }                                <tr>                        source: 'districts',



        function generateSampleData() {                                    <td colspan="8" class="px-4 py-8 text-center text-sm text-muted-foreground">                        paint: {

            const industries = ['Steel', 'Cement', 'Chemicals'];

            const states = ['IN', 'TX', 'CA', 'PA', 'OH', 'IL', 'MI', 'AL'];                                        Click "Compare Scenarios" to see results                            'circle-radius': 30,

            const facilities = [

                'US Steel Gary Works', 'ArcelorMittal Burns Harbor', 'Cleveland-Cliffs Indiana Harbor',                                    </td>                            'circle-color': [

                'Nucor Steel', 'Big River Steel', 'Cemex Cement Plant', 'LafargeHolcim Texas',

                'Heidelberg Cement', 'Dow Chemical Freeport', 'BASF Geismar', 'ExxonMobil Baytown',                                </tr>                                'interpolate',

                'DuPont La Porte', 'Chevron Phillips Cedar Bayou', 'Shell Deer Park'

            ];                            </tbody>                                ['linear'],

            

            facilitiesData = [];                        </table>                                ['get', 'emissions'],

            for (let i = 0; i < 20; i++) {

                const industry = industries[Math.floor(Math.random() * industries.length)];                    </div>                                0, '#22c55e',

                const baseEmissions = Math.random() * 8 + 2; // 2-10 MT

                                </div>                                5000, '#eab308',

                facilitiesData.push({

                    id: i + 1,            </div>                                10000, '#f97316',

                    name: facilities[i % facilities.length],

                    city: ['Gary', 'Houston', 'Freeport', 'La Porte', 'Burns Harbor'][Math.floor(Math.random() * 5)],        </div>                                15000, '#ef4444'

                    state: states[Math.floor(Math.random() * states.length)],

                    industry: industry,    </div>                            ],

                    baseEmissions: baseEmissions

                });                            'circle-opacity': 0.7,

            }

        }    <script>                            'circle-stroke-width': 2,



        function calculateScenario(scenario) {        // Load shared header with cache busting                            'circle-stroke-color': '#ffffff'

            // Filter facilities by scenario parameters

            let filtered = facilitiesData.filter(f =>         fetch('/static/header.html?' + Date.now())                        }

                scenario.industries.includes(f.industry) &&

                (scenario.state === 'all' || f.state === scenario.state)            .then(response => response.text())                    });

            );

                        .then(html => {

            let totalEmissions = 0;

            let totalRevenue = 0;                document.getElementById('header-container').innerHTML = html;                    // Add labels

            let byIndustry = { Steel: 0, Cement: 0, Chemicals: 0 };

                            highlightActiveNav();                    map.addLayer({

            filtered.forEach(f => {

                // Apply abatement            })                        id: 'district-labels',

                const reducedEmissions = f.baseEmissions * (1 - scenario.abatement / 100);

                totalEmissions += reducedEmissions;            .catch(error => console.error('Error loading header:', error));                        type: 'symbol',

                

                // Calculate revenue                        source: 'districts',

                totalRevenue += reducedEmissions * scenario.carbonTax;

                        // Highlight active navigation link                        layout: {

                // By industry

                byIndustry[f.industry] += reducedEmissions;        function highlightActiveNav() {                            'text-field': ['get', 'name'],

            });

                        const currentPage = document.body.dataset.page;                            'text-size': 12,

            return {

                totalEmissions,            if (currentPage) {                            'text-offset': [0, 2.5]

                totalRevenue,

                byIndustry,                document.querySelectorAll('.nav-link').forEach(link => {                        },

                facilitiesCount: filtered.length,

                facilities: filtered.map(f => ({                    if (link.dataset.page === currentPage) {                        paint: {

                    ...f,

                    reducedEmissions: f.baseEmissions * (1 - scenario.abatement / 100),                        link.classList.remove('text-muted-foreground', 'border-transparent');                            'text-color': '#333',

                    cost: f.baseEmissions * (1 - scenario.abatement / 100) * scenario.carbonTax

                }))                        link.classList.add('text-foreground', 'border-primary', 'bg-background/50');                            'text-halo-color': '#ffffff',

            };

        }                    }                            'text-halo-width': 2



        function updateImpactsSection(resultsA, resultsB) {                });                        }

            const emissionsDiff = resultsA.totalEmissions - resultsB.totalEmissions;

            const reductionPercent = ((emissionsDiff / resultsA.totalEmissions) * 100).toFixed(1);            }                    });

            const revenueDiff = resultsB.totalRevenue - resultsA.totalRevenue;

            const costEfficiency = revenueDiff > 0 && emissionsDiff > 0         }

                ? Math.round(revenueDiff / emissionsDiff * 1000000) 

                : 0;                    // Add popup on click

            

            // Update emissions        // Chart.js instances                    map.on('click', 'district-circles', (e) => {

            document.getElementById('impact-base-emissions').textContent = resultsA.totalEmissions.toFixed(1) + ' MT';

            document.getElementById('impact-policy-emissions').textContent = resultsB.totalEmissions.toFixed(1) + ' MT';        let emissionsChart = null;                        const props = e.features[0].properties;

            

            const arrow = emissionsDiff >= 0 ? '‚¨á' : '‚¨Ü';        let revenueChart = null;                        new mapboxgl.Popup()

            const sign = emissionsDiff >= 0 ? '' : '+';

            const color = emissionsDiff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';                            .setLngLat(e.lngLat)

            

            document.getElementById('impact-reduction').textContent =         // Industry colors                            .setHTML(`

                `${arrow} ${sign}${Math.abs(emissionsDiff).toFixed(1)} MT (${Math.abs(reductionPercent)}% ${emissionsDiff >= 0 ? 'reduction' : 'increase'})`;

            document.getElementById('impact-reduction').className = `text-3xl font-bold ${color}`;        const industryColors = {                                <h3>${props.name}</h3>

            

            document.getElementById('reduction-percent').textContent = Math.abs(reductionPercent) + '%';            steel: '#ef4444',                                <p><strong>Emissions:</strong> ${props.emissions.toLocaleString()} kg CO‚ÇÇ/yr</p>

            document.getElementById('reduction-bar').style.width = Math.min(Math.abs(reductionPercent), 100) + '%';

                        cement: '#6b7280',                                <p><strong>Cost:</strong> $${props.cost.toLocaleString()}/yr</p>

            // Update revenue

            document.getElementById('revenue-base').textContent = '$' + (resultsA.totalRevenue / 1000000).toFixed(1) + 'M';            chemicals: '#3b82f6'                                <p><strong>Usage:</strong> ${props.usage.toLocaleString()} kWh/yr</p>

            document.getElementById('revenue-policy').textContent = '$' + (resultsB.totalRevenue / 1000000).toFixed(1) + 'M';

                    };                            `)

            const revenueArrow = revenueDiff >= 0 ? '‚¨Ü' : '‚¨á';

            const revenueSign = revenueDiff >= 0 ? '+' : '';                            .addTo(map);

            document.getElementById('revenue-diff').textContent = 

                `${revenueArrow} ${revenueSign}$${(revenueDiff / 1000000).toFixed(1)}M`;        // Initialize sliders with value display                    });

            

            // Update cost efficiency        function initSliders() {

            document.getElementById('cost-efficiency').textContent = costEfficiency > 0 ? `$${costEfficiency}` : 'N/A';

                        // Scenario A                    map.on('mouseenter', 'district-circles', () => {

            // Update facilities

            document.getElementById('facilities-count').textContent = resultsB.facilitiesCount;            const scenarioATax = document.getElementById('scenario-a-tax');                        map.getCanvas().style.cursor = 'pointer';

            const totalFacilities = facilitiesData.length;

            const facilityPercent = ((resultsB.facilitiesCount / totalFacilities) * 100).toFixed(0);            const scenarioATaxValue = document.getElementById('scenario-a-tax-value');                    });

            document.getElementById('facilities-percent').textContent = `${facilityPercent}% of total`;

        }            scenarioATax.addEventListener('input', (e) => {



        function createCharts(resultsA, resultsB) {                scenarioATaxValue.textContent = e.target.value;                    map.on('mouseleave', 'district-circles', () => {

            // Destroy existing charts

            Object.values(charts).forEach(chart => chart.destroy());            });                        map.getCanvas().style.cursor = '';

            charts = {};

                                });

            const industries = ['Steel', 'Cement', 'Chemicals'];

            const colors = {            const scenarioAAbatement = document.getElementById('scenario-a-abatement');                }

                Steel: '#ef4444',

                Cement: '#8b5cf6',            const scenarioAAbatementValue = document.getElementById('scenario-a-abatement-value');            } catch (error) {

                Chemicals: '#f59e0b'

            };            scenarioAAbatement.addEventListener('input', (e) => {                console.error('Error loading sample data:', error);

            

            // Baseline Pie                scenarioAAbatementValue.textContent = e.target.value;            }

            charts.baselinePie = new Chart(document.getElementById('chart-baseline-pie'), {

                type: 'doughnut',            });        }

                data: {

                    labels: industries,

                    datasets: [{

                        data: industries.map(ind => resultsA.byIndustry[ind].toFixed(1)),            // Scenario B        // Fetch integration status from server and update UI

                        backgroundColor: industries.map(ind => colors[ind])

                    }]            const scenarioBTax = document.getElementById('scenario-b-tax');        async function updateIntegrationStatus() {

                },

                options: {            const scenarioBTaxValue = document.getElementById('scenario-b-tax-value');            try {

                    responsive: true,

                    maintainAspectRatio: false,            scenarioBTax.addEventListener('input', (e) => {                const [intRes, healthRes] = await Promise.all([

                    plugins: {

                        legend: { position: 'bottom' },                scenarioBTaxValue.textContent = e.target.value;                    fetch('/api/integration-status'),

                        tooltip: {

                            callbacks: {            });                    fetch('/health')

                                label: (context) => `${context.label}: ${context.parsed} MT`

                            }                ]);

                        }

                    }            const scenarioBAbatement = document.getElementById('scenario-b-abatement');

                }

            });            const scenarioBAbatementValue = document.getElementById('scenario-b-abatement-value');                if (intRes.ok) {

            

            // Policy Pie            scenarioBAbatement.addEventListener('input', (e) => {                    const intData = await intRes.json();

            charts.policyPie = new Chart(document.getElementById('chart-policy-pie'), {

                type: 'doughnut',                scenarioBAbatementValue.textContent = e.target.value;                    document.getElementById('mapbox-token-status').textContent =

                data: {

                    labels: industries,            });                        intData.mapbox_configured ? 'present' : 'missing';

                    datasets: [{

                        data: industries.map(ind => resultsB.byIndustry[ind].toFixed(1)),        }                    document.getElementById('palmetto-status').textContent =

                        backgroundColor: industries.map(ind => colors[ind])

                    }]                        intData.palmetto_base

                },

                options: {        // Generate sample data for comparison                            ? (intData.palmetto_reachable

                    responsive: true,

                    maintainAspectRatio: false,        function generateSampleData(scenario) {                                ? `reachable (${intData.palmetto_base})`

                    plugins: {

                        legend: { position: 'bottom' },            const industries = [];                                : `unreachable (${intData.palmetto_base})`)

                        tooltip: {

                            callbacks: {            document.querySelectorAll(`input[name="scenario-${scenario}-industry"]:checked`).forEach(cb => {                            : 'not configured';

                                label: (context) => `${context.label}: ${context.parsed} MT`

                            }                industries.push(cb.value);                } else {

                        }

                    }            });                    document.getElementById('mapbox-token-status').textContent = 'error';

                }

            });                    document.getElementById('palmetto-status').textContent = 'error';

            

            // Comparison Bar            const state = document.getElementById(`scenario-${scenario}-state`).value;                }

            charts.comparisonBar = new Chart(document.getElementById('chart-comparison-bar'), {

                type: 'bar',            const year = parseInt(document.getElementById(`scenario-${scenario}-year`).value);

                data: {

                    labels: industries,            const carbonTax = parseInt(document.getElementById(`scenario-${scenario}-tax`).value);                if (healthRes.ok) {

                    datasets: [

                        {            const abatement = parseInt(document.getElementById(`scenario-${scenario}-abatement`).value) / 100;                    const health = await healthRes.json();

                            label: 'Baseline',

                            data: industries.map(ind => resultsA.byIndustry[ind].toFixed(1)),                    document.getElementById('server-health-status').textContent =

                            backgroundColor: '#3b82f6'

                        },            // Generate sample facilities                        (health.status || 'unknown');

                        {

                            label: 'Policy',            const facilities = [];                } else {

                            data: industries.map(ind => resultsB.byIndustry[ind].toFixed(1)),

                            backgroundColor: '#10b981'            const facilityCount = Math.floor(Math.random() * 30) + 20; // 20-50 facilities                    document.getElementById('server-health-status').textContent = 'unhealthy';

                        }

                    ]                }

                },

                options: {            for (let i = 0; i < facilityCount; i++) {

                    responsive: true,

                    maintainAspectRatio: false,                const industry = industries[Math.floor(Math.random() * industries.length)];                // Map loaded status (client-side)

                    plugins: {

                        legend: { position: 'top' }                const baseEmissions = Math.random() * 3000000 + 500000; // 0.5-3.5M MT                document.getElementById('map-loaded-status').textContent = mapLoaded ? 'yes' : 'no';

                    },

                    scales: {                const reducedEmissions = baseEmissions * (1 - abatement);            } catch (err) {

                        y: {

                            beginAtZero: true,                const carbonCost = (reducedEmissions / 1000000) * carbonTax * 1000000; // Convert to dollars                console.error('Error fetching integration status:', err);

                            title: { display: true, text: 'Emissions (MT CO‚ÇÇe)' }

                        }                document.getElementById('mapbox-token-status').textContent = 'error';

                    }

                }                facilities.push({                document.getElementById('palmetto-status').textContent = 'error';

            });

        }                    name: `Facility ${i + 1}`,                document.getElementById('server-health-status').textContent = 'error';



        function populateFacilitiesTable(resultsA, resultsB) {                    industry: industry,            }

            const tbody = document.getElementById('facilities-table-body');

                                state: state || 'TX',        }

            // Merge results

            const merged = resultsA.facilities.map(fA => {                    baseEmissions: baseEmissions,

                const fB = resultsB.facilities.find(f => f.id === fA.id);

                const diff = fA.reducedEmissions - (fB ? fB.reducedEmissions : fA.baseEmissions);                    reducedEmissions: reducedEmissions,        // Toggle bottom integration panel expansion

                const diffPercent = ((diff / fA.baseEmissions) * 100).toFixed(1);

                                    carbonCost: carbonCost        function toggleIntegrationPanel() {

                return {

                    ...fA,                });            const content = document.getElementById('integration-status');

                    emissionsB: fB ? fB.reducedEmissions : fA.baseEmissions,

                    costB: fB ? fB.cost : 0,            }            const btn = document.getElementById('integration-toggle');

                    diff: diff,

                    diffPercent: parseFloat(diffPercent),            const isHidden = content.classList.contains('hidden');

                    diffAbs: Math.abs(diff)

                };            // Sort by base emissions            if (isHidden) {

            });

                        facilities.sort((a, b) => b.baseEmissions - a.baseEmissions);                content.classList.remove('hidden');

            // Sort by absolute reduction (default)

            merged.sort((a, b) => b.diffAbs - a.diffAbs);                btn.textContent = '‚àí';

            

            // Take top 10            // Calculate totals                btn.setAttribute('aria-expanded', 'true');

            const top10 = merged.slice(0, 10);

                        const totalEmissions = facilities.reduce((sum, f) => sum + f.reducedEmissions, 0);                // Refresh status when opening

            tbody.innerHTML = top10.map((f, idx) => {

                const arrow = f.diff >= 0 ? '‚¨á' : '‚¨Ü';            const totalRevenue = facilities.reduce((sum, f) => sum + f.carbonCost, 0);                updateIntegrationStatus();

                const statusColor = f.diff >= 0 ? 'text-green-600' : 'text-red-600';

                            } else {

                return `

                    <tr class="border-b hover:bg-muted/30">            // Emissions by industry                content.classList.add('hidden');

                        <td class="px-4 py-3">${idx + 1}</td>

                        <td class="px-4 py-3">            const emissionsByIndustry = {};                btn.textContent = '+';

                            <div class="font-medium">${f.name}</div>

                            <div class="text-xs text-muted-foreground">${f.city}, ${f.state}</div>            industries.forEach(ind => {                btn.setAttribute('aria-expanded', 'false');

                        </td>

                        <td class="px-4 py-3">${f.industry}</td>                emissionsByIndustry[ind] = facilities            }

                        <td class="px-4 py-3 text-right font-mono">${f.reducedEmissions.toFixed(2)} MT</td>

                        <td class="px-4 py-3 text-right font-mono">${f.emissionsB.toFixed(2)} MT</td>                    .filter(f => f.industry === ind)        }

                        <td class="px-4 py-3 text-right font-mono">

                            <div class="${statusColor}">${arrow} ${f.diffAbs.toFixed(2)} MT</div>                    .reduce((sum, f) => sum + f.reducedEmissions, 0);

                            <div class="text-xs text-muted-foreground">${Math.abs(f.diffPercent)}%</div>

                        </td>            });        // Hook up toggle button & inputs after DOM is ready

                        <td class="px-4 py-3 text-right font-mono">$${(f.costB / 1000).toFixed(0)}k</td>

                        <td class="px-4 py-3 text-center">        document.addEventListener('DOMContentLoaded', () => {

                            <span class="${statusColor}">‚úì</span>

                        </td>            return {            const t = document.getElementById('integration-toggle');

                    </tr>

                `;                facilities: facilities,            if (t) t.addEventListener('click', toggleIntegrationPanel);

            }).join('');

        }                totalEmissions: totalEmissions,



        function sortFacilities() {                totalRevenue: totalRevenue,            document.getElementById('num-evs').addEventListener('input', (e) => {

            // Re-run calculation with current sort

            calculateComparison();                emissionsByIndustry: emissionsByIndustry,                document.getElementById('num-evs-value').textContent = e.target.value;

        }

                facilityCount: facilities.length            });

        // Export functions

        function downloadCSV() {            };

            alert('CSV export functionality - would download full comparison data');

        }        }            document.getElementById('pv-capacity').addEventListener('input', (e) => {



        function saveScenario() {                document.getElementById('pv-capacity-value').textContent = e.target.value;

            alert('Save scenario functionality - would save to backend');

        }        // Compare scenarios            });



        function shareLink() {        function compareScenarios() {

            alert('Share link functionality - would generate shareable URL');

        }            const dataA = generateSampleData('a');            document.getElementById('num-heat-pumps').addEventListener('input', (e) => {



        // Initialize displays            const dataB = generateSampleData('b');                document.getElementById('num-heat-pumps-value').textContent = e.target.value;

        updateScenarioDisplay('A');

        updateScenarioDisplay('B');            });

    </script>

</body>            // Update summary cards

</html>

            document.getElementById('emissions-a').textContent = `${(dataA.totalEmissions / 1000000).toFixed(2)} MT`;            document.getElementById('calculate-btn').addEventListener('click', async () => {

            document.getElementById('emissions-b').textContent = `${(dataB.totalEmissions / 1000000).toFixed(2)} MT`;                const loading = document.getElementById('loading');

            const emissionsDiff = dataB.totalEmissions - dataA.totalEmissions;                const results = document.getElementById('results');

            const emissionsDiffText = emissionsDiff >= 0                 const button = document.getElementById('calculate-btn');

                ? `+${(emissionsDiff / 1000000).toFixed(2)} MT more` 

                : `${(emissionsDiff / 1000000).toFixed(2)} MT less`;                // Show loading

            document.getElementById('emissions-diff').textContent = `Difference: ${emissionsDiffText}`;                loading.classList.remove('hidden');

            document.getElementById('emissions-diff').className = emissionsDiff >= 0 ? 'text-sm font-medium text-red-600 mt-2 pt-2 border-t' : 'text-sm font-medium text-green-600 mt-2 pt-2 border-t';                results.classList.add('hidden');

                button.disabled = true;

            document.getElementById('revenue-a').textContent = `$${(dataA.totalRevenue / 1000000).toFixed(1)}M`;

            document.getElementById('revenue-b').textContent = `$${(dataB.totalRevenue / 1000000).toFixed(1)}M`;                // Gather parameters

            const revenueDiff = dataB.totalRevenue - dataA.totalRevenue;                const scenario = {

            const revenueDiffText = revenueDiff >= 0                     num_evs: parseInt(document.getElementById('num-evs').value),

                ? `+$${(revenueDiff / 1000000).toFixed(1)}M more`                     pv_capacity_kw: parseFloat(document.getElementById('pv-capacity').value),

                : `-$${Math.abs(revenueDiff / 1000000).toFixed(1)}M less`;                    num_heat_pumps: parseInt(document.getElementById('num-heat-pumps').value),

            document.getElementById('revenue-diff').textContent = `Difference: ${revenueDiffText}`;                    insulation_level: document.getElementById('insulation-level').value,

                    building_type: document.getElementById('building-type').value,

            document.getElementById('facilities-a').textContent = dataA.facilityCount;                    square_footage: parseInt(document.getElementById('square-footage').value)

            document.getElementById('facilities-b').textContent = dataB.facilityCount;                };

            const facilitiesDiff = dataB.facilityCount - dataA.facilityCount;

            document.getElementById('facilities-diff').textContent = facilitiesDiff === 0                 try {

                ? 'Same facilities'                     const response = await fetch('/api/calculate', {

                : `${facilitiesDiff > 0 ? '+' : ''}${facilitiesDiff} facilities`;                        method: 'POST',

                        headers: {

            // Update charts                            'Content-Type': 'application/json'

            updateEmissionsChart(dataA, dataB);                        },

            updateRevenueChart(dataA, dataB);                        body: JSON.stringify({ scenario })

                    });

            // Update comparison table (top 10)

            updateComparisonTable(dataA.facilities.slice(0, 10), dataB.facilities.slice(0, 10));                    const result = await response.json();

        }

                    // Display results

        // Update emissions chart                    document.getElementById('result-usage').textContent =

        function updateEmissionsChart(dataA, dataB) {                        `${result.annual_kwh_usage.toLocaleString()} kWh/yr`;

            const ctx = document.getElementById('emissions-chart').getContext('2d');                    document.getElementById('result-cost').textContent =

                                    `$${result.annual_cost_usd.toLocaleString()}/yr`;

            if (emissionsChart) emissionsChart.destroy();                    document.getElementById('result-emissions').textContent =

                        `${result.annual_emissions_kg_co2.toLocaleString()} kg CO‚ÇÇ/yr`;

            const industries = Object.keys(dataA.emissionsByIndustry);                    document.getElementById('result-peak').textContent =

                                    `${result.peak_demand_kw.toLocaleString()} kW`;

            emissionsChart = new Chart(ctx, {                    document.getElementById('result-renewable').textContent =

                type: 'bar',                        `${result.renewable_percentage}%`;

                data: {

                    labels: industries.map(i => i.charAt(0).toUpperCase() + i.slice(1)),                    results.classList.remove('hidden');

                    datasets: [                } catch (error) {

                        {                    console.error('Error calculating:', error);

                            label: 'Scenario A',                    alert('Error calculating scenario. Please try again.');

                            data: industries.map(i => (dataA.emissionsByIndustry[i] || 0) / 1000000),                } finally {

                            backgroundColor: '#3b82f6'                    loading.classList.add('hidden');

                        },                    button.disabled = false;

                        {                }

                            label: 'Scenario B',            });

                            data: industries.map(i => (dataB.emissionsByIndustry[i] || 0) / 1000000),

                            backgroundColor: '#22c55e'            // Initialize on load

                        }            init();

                    ]        });

                },    </script>

                options: {</body>

                    responsive: true,</html>

                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Emissions (MT CO‚ÇÇe)' }
                        }
                    }
                }
            });
        }

        // Update revenue chart
        function updateRevenueChart(dataA, dataB) {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Scenario A Revenue', 'Scenario B Revenue'],
                    datasets: [{
                        data: [
                            dataA.totalRevenue / 1000000,
                            dataB.totalRevenue / 1000000
                        ],
                        backgroundColor: ['#3b82f6', '#22c55e']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // Update comparison table
        function updateComparisonTable(facilitiesA, facilitiesB) {
            const tbody = document.getElementById('comparison-table-body');
            tbody.innerHTML = '';

            // Match facilities by name (simplified)
            facilitiesA.forEach((facA, idx) => {
                const facB = facilitiesB[idx] || facA; // Use same facility for comparison

                const row = document.createElement('tr');
                row.className = 'hover:bg-accent';
                
                const costDiff = facB.carbonCost - facA.carbonCost;
                const emissionsDiff = facA.reducedEmissions - facB.reducedEmissions;

                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${facA.name}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center gap-1">
                            <div class="w-2 h-2 rounded-full" style="background-color: ${industryColors[facA.industry]}"></div>
                            ${facA.industry.charAt(0).toUpperCase() + facA.industry.slice(1)}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right">${(facA.baseEmissions / 1000000).toFixed(2)} MT</td>
                    <td class="px-4 py-3 text-right">$${(facA.carbonCost / 1000000).toFixed(2)}M</td>
                    <td class="px-4 py-3 text-right">${(facA.reducedEmissions / 1000000).toFixed(2)} MT</td>
                    <td class="px-4 py-3 text-right">$${(facB.carbonCost / 1000000).toFixed(2)}M</td>
                    <td class="px-4 py-3 text-right">${(facB.reducedEmissions / 1000000).toFixed(2)} MT</td>
                    <td class="px-4 py-3 text-right font-medium ${emissionsDiff > 0 ? 'text-green-600' : 'text-red-600'}">
                        ${emissionsDiff > 0 ? '-' : '+'}${Math.abs(emissionsDiff / 1000000).toFixed(2)} MT
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Export comparison as CSV
        function exportComparison() {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `scenario_comparison_${timestamp}.csv`;

            // Get current comparison data
            const rows = [
                ['Scenario Comparison Export', new Date().toLocaleString()],
                [],
                ['Facility', 'Industry', 'Base Emissions (MT)', 'Scenario A Cost', 'Scenario A Reduced', 'Scenario B Cost', 'Scenario B Reduced', 'Difference']
            ];

            // Add table rows
            document.querySelectorAll('#comparison-table-body tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) {
                    rows.push(Array.from(cells).map(cell => cell.textContent.trim()));
                }
            });

            const csv = rows.map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('compare-btn').addEventListener('click', compareScenarios);
        document.getElementById('export-comparison-btn').addEventListener('click', exportComparison);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initSliders();
        });
    </script>
</body>
</html>

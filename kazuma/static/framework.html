<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Grid Siting - Framework</title>
    
    <!-- Chart.js for radar charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind CSS -->
    <link href="/static/output.css" rel="stylesheet">
    
    <style>
        .slider-container { margin: 16px 0; }
        .slider { width: 100%; accent-color: #CE989D; }
        .chart-container { position: relative; height: 300px; }
        body { background-color: #0A0506; }
    </style>
</head>
<body style="background-color: #0A0506;">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header style="background-color: #CE989D; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border-bottom: 1px solid rgba(28, 13, 14, 0.2);">
            <div class="px-6 py-4 flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Siting Framework</h1>
                    <p class="text-sm mt-1" style="color: #1C0D0E; opacity: 0.85;">Optimization Sandbox</p>
                </div>
                <a href="/" style="color: #1C0D0E; font-weight: 500; font-size: 14px; text-decoration: none;"
                   onmouseover="this.style.opacity='0.75'"
                   onmouseout="this.style.opacity='1'">
                    ← Back to Map View
                </a>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="flex-1 flex">
            <!-- Left Panel - Inputs -->
            <div class="w-96 overflow-y-auto" style="background-color: rgba(243, 231, 232, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-right: 1px solid rgba(206, 152, 157, 0.2); box-shadow: 2px 0 12px rgba(0,0,0,0.4);">
                <div class="p-6 space-y-6">
                    <!-- Selected Location -->
                    <div>
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Selected Location</h2>
                        <div id="selected-location" class="p-4 rounded-lg" style="background-color: rgba(206, 152, 157, 0.15); border: 1px solid rgba(206, 152, 157, 0.3);">
                            <div class="text-sm" style="color: #3D2224;">Loading...</div>
                        </div>
                        
                        <!-- Manual Input (always visible) -->
                        <div class="mt-3">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-medium" style="color: #2D1517;">Or enter coordinates:</label>
                                <button id="use-manual-coords" class="text-xs font-medium" style="color: #CE989D; cursor: pointer; background: none; border: none;"
                                        onmouseover="this.style.color='#B87F84'"
                                        onmouseout="this.style.color='#CE989D'">Use These</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="manual-lat" placeholder="Latitude" step="0.0001" 
                                       class="w-full px-3 py-2 rounded text-sm" style="border: 1px solid rgba(206, 152, 157, 0.3); background-color: rgba(255, 255, 255, 0.8); color: #1C0D0E;" min="-90" max="90">
                                <input type="number" id="manual-lon" placeholder="Longitude" step="0.0001" 
                                       class="w-full px-3 py-2 rounded text-sm" style="border: 1px solid rgba(206, 152, 157, 0.3); background-color: rgba(255, 255, 255, 0.8); color: #1C0D0E;" min="-180" max="180">
                            </div>
                            <p class="text-xs mt-1" style="color: #6D5557;">Click "Use These" to evaluate custom coordinates</p>
                        </div>
                    </div>
                    
                    <!-- Criteria Weights -->
                    <div>
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Criteria Weights</h2>
                        <p class="text-xs mb-4" style="color: #6D5557;">Adjust weights to match your priorities (must sum to 1.0)</p>
                        
                        <!-- Clean Generation Weight -->
                        <div class="slider-container">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-medium" style="color: #2D1517;">Clean Generation</label>
                                <span id="weight-clean-value" class="text-sm font-semibold" style="color: #A3D9A5;">0.40</span>
                            </div>
                            <input type="range" id="weight-clean" min="0" max="1" step="0.05" value="0.4" class="slider w-full">
                        </div>
                        
                        <!-- Transmission Weight -->
                        <div class="slider-container">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-medium" style="color: #2D1517;">Transmission Headroom</label>
                                <span id="weight-transmission-value" class="text-sm font-semibold" style="color: #9BC4E8;">0.30</span>
                            </div>
                            <input type="range" id="weight-transmission" min="0" max="1" step="0.05" value="0.3" class="slider w-full">
                        </div>
                        
                        <!-- Reliability Weight -->
                        <div class="slider-container">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-medium" style="color: #2D1517;">Grid Reliability</label>
                                <span id="weight-reliability-value" class="text-sm font-semibold" style="color: #B5A3D9;">0.30</span>
                            </div>
                            <input type="range" id="weight-reliability" min="0" max="1" step="0.05" value="0.3" class="slider w-full">
                        </div>
                        
                        <!-- Sum Validation -->
                        <div id="weight-sum-indicator" class="mt-3 p-2 rounded text-sm text-center">
                            Sum: <span id="weight-sum">1.00</span>
                        </div>
                    </div>
                    
                    <!-- Demand Size Selector -->
                    <div>
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Demand Profile</h2>
                        
                        <div class="space-y-2">
                            <label class="text-sm font-medium" style="color: #2D1517;">Load Type</label>
                            <select id="demand-type" class="w-full px-3 py-2 rounded" style="border: 1px solid rgba(206, 152, 157, 0.3); background-color: rgba(255, 255, 255, 0.8); color: #1C0D0E;">
                                <option value="data_center">Data Center</option>
                                <option value="electrolyzer">Electrolyzer</option>
                                <option value="ev_hub">EV Charging Hub</option>
                                <option value="hydrogen_plant">Hydrogen Plant</option>
                                <option value="ai_compute">AI Compute Hub</option>
                            </select>
                        </div>
                        
                        <div class="mt-3 space-y-2">
                            <label class="text-sm font-medium" style="color: #2D1517;">Load Size</label>
                            <select id="demand-size" class="w-full px-3 py-2 rounded" style="border: 1px solid rgba(206, 152, 157, 0.3); background-color: rgba(255, 255, 255, 0.8); color: #1C0D0E;">
                                <option value="10">10 MW (Test Load)</option>
                                <option value="50" selected>50 MW (Small Data Center)</option>
                                <option value="200">200 MW (Large Data Center)</option>
                                <option value="500">500 MW (AI Compute Hub)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Evaluate Button -->
                    <button id="evaluate-btn" class="w-full py-3 px-4 rounded-lg font-semibold" style="background-color: #CE989D; color: #1C0D0E; border: none; cursor: pointer; font-family: 'Space Grotesk', sans-serif;"
                            onmouseover="this.style.backgroundColor='#B87F84'"
                            onmouseout="this.style.backgroundColor='#CE989D'">
                        Evaluate Site
                    </button>
                </div>
            </div>
            
            <!-- Right Panel - Results -->
            <div class="flex-1 p-6 overflow-y-auto" style="background-color: #0A0506;">
                <div id="results-container" class="hidden">
                    <!-- Composite Score Display -->
                    <div class="rounded-lg p-6 mb-6" style="background-color: rgba(243, 231, 232, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid rgba(206, 152, 157, 0.2);">
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Composite Siting Score</h2>
                        <div class="text-center">
                            <div id="composite-score" class="text-6xl font-bold mb-2" style="color: #CE989D;">--</div>
                            <div id="percentile-rank" class="text-sm" style="color: #6D5557;">--</div>
                        </div>
                    </div>
                    
                    <!-- Category Breakdown -->
                    <div class="rounded-lg p-6 mb-6" style="background-color: rgba(243, 231, 232, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid rgba(206, 152, 157, 0.2);">
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Category Breakdown</h2>
                        <div class="space-y-4" id="breakdown-details">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Visualization Chart -->
                    <div class="rounded-lg p-6 mb-6" style="background-color: rgba(243, 231, 232, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid rgba(206, 152, 157, 0.2);">
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Siting Criteria Visualization</h2>
                        <div class="chart-container">
                            <canvas id="criteria-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Evaluation Notes -->
                    <div class="rounded-lg p-6 mb-6" style="background-color: rgba(243, 231, 232, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid rgba(206, 152, 157, 0.2);">
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Evaluation Notes</h2>
                        <ul id="evaluation-notes" class="space-y-2 text-sm" style="color: #2D1517;">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    
                    <!-- Alternative Sites -->
                    <div class="rounded-lg p-6 mb-6" style="background-color: rgba(243, 231, 232, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid rgba(206, 152, 157, 0.2);">
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Similar Alternative Sites</h2>
                        <div id="alternatives-list" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Nearby Power Plants -->
                    <div class="rounded-lg p-6 mb-6" style="background-color: rgba(243, 231, 232, 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 1px solid rgba(206, 152, 157, 0.2);">
                        <h2 class="text-lg font-semibold mb-4" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Nearby Power Plants</h2>
                        <p class="text-xs mb-3" style="color: #6D5557;">Plants within 200km that influence clean gen and transmission scores</p>
                        <div id="nearby-plants-list" class="space-y-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-4">
                        <button id="save-scenario-btn" class="flex-1 py-2 px-4 rounded font-semibold" style="background-color: #A3D9A5; color: #1C0D0E; border: none; cursor: pointer;"
                                onmouseover="this.style.backgroundColor='#8BC48D'"
                                onmouseout="this.style.backgroundColor='#A3D9A5'">
                            Save Scenario
                        </button>
                        <button id="compare-btn" class="flex-1 py-2 px-4 rounded font-semibold" style="background-color: #B5A3D9; color: #1C0D0E; border: none; cursor: pointer;"
                                onmouseover="this.style.backgroundColor='#9D8BC4'"
                                onmouseout="this.style.backgroundColor='#B5A3D9'">
                            Compare Scenarios
                        </button>
                    </div>
                </div>
                
                <!-- Initial State -->
                <div id="initial-state" class="text-center py-20">
                    <h3 class="mt-4 text-lg font-medium" style="color: #F3E7E8; font-family: 'Space Grotesk', sans-serif;">Ready to Evaluate</h3>
                    <p class="mt-2 text-sm" style="color: #CE989D;">Adjust criteria weights and click "Evaluate Site" to begin</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comparison Modal -->
    <div id="comparison-modal" class="fixed inset-0 hidden items-center justify-center z-50" style="background-color: rgba(10, 5, 6, 0.9);">
        <div class="rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" style="background-color: rgba(243, 231, 232, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(206, 152, 157, 0.3);">
            <div class="p-6" style="border-bottom: 1px solid rgba(206, 152, 157, 0.3);">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold" style="color: #1C0D0E; font-family: 'Space Grotesk', sans-serif;">Scenario Comparison</h2>
                    <button id="close-modal" class="text-2xl" style="color: #6D5557; background: none; border: none; cursor: pointer;"
                            onmouseover="this.style.color='#CE989D'"
                            onmouseout="this.style.color='#6D5557'">&times;</button>
                </div>
            </div>
            <div class="p-6">
                <div id="comparison-content">
                    <p style="color: #6D5557;">No scenarios saved yet. Evaluate some sites and save them for comparison.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentSiteId = null;
        let currentEvaluation = null;
        let criteriaChart = null;
        let isCustomLocation = false;  // Track if using custom coordinates
        let customCoordinates = null;  // Store custom lat/lon
        
        // Get site ID from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const siteIdParam = urlParams.get('site_id');
        
        // Check for custom location from sessionStorage (right-click on map)
        const customLocationData = sessionStorage.getItem('customLocation');
        if (customLocationData) {
            const coords = JSON.parse(customLocationData);
            isCustomLocation = true;
            customCoordinates = coords;
            
            // Clear from sessionStorage
            sessionStorage.removeItem('customLocation');
            
            // Populate manual input fields
            document.getElementById('manual-lat').value = coords.latitude.toFixed(4);
            document.getElementById('manual-lon').value = coords.longitude.toFixed(4);
            
            // Update display
            document.getElementById('selected-location').innerHTML = `
                <div class="font-semibold" style="color: #1C0D0E;">Custom Location (from map)</div>
                <div class="text-sm mt-1" style="color: #3D2224;">
                    <div>Lat: ${coords.latitude.toFixed(4)}, Lon: ${coords.longitude.toFixed(4)}</div>
                </div>
                <div class="mt-2 text-xs font-medium" style="color: #A3D9A5;">Ready to evaluate</div>
            `;
        } else if (siteIdParam) {
            currentSiteId = parseInt(siteIdParam);
            loadSiteInfo(currentSiteId);
        } else {
            // No site selected, show default state
            document.getElementById('selected-location').innerHTML = `
                <div class="text-sm" style="color: #3D2224;">No grid node selected.</div>
                <div class="text-xs mt-2" style="color: #6D5557;">Enter coordinates below to evaluate any location.</div>
            `;
        }
        
        // Use manual coordinates button
        document.getElementById('use-manual-coords').addEventListener('click', () => {
            const lat = parseFloat(document.getElementById('manual-lat').value);
            const lon = parseFloat(document.getElementById('manual-lon').value);
            
            if (isNaN(lat) || isNaN(lon)) {
                alert('Please enter valid latitude and longitude values');
                return;
            }
            
            if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                alert('Coordinates out of range. Lat: -90 to 90, Lon: -180 to 180');
                return;
            }
            
            // Set custom location mode
            isCustomLocation = true;
            customCoordinates = { latitude: lat, longitude: lon };
            currentSiteId = null;  // Clear grid node selection
            
            // Update display
            document.getElementById('selected-location').innerHTML = `
                <div class="font-semibold" style="color: #1C0D0E;">Custom Location</div>
                <div class="text-sm mt-1" style="color: #3D2224;">
                    <div>Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}</div>
                </div>
                <div class="mt-2 text-xs font-medium" style="color: #A3D9A5;">Ready to evaluate custom coordinates</div>
            `;
            
            console.log('Custom coordinates set:', customCoordinates);
        });
        
        // Load site info
        async function loadSiteInfo(siteId) {
            try {
                const response = await fetch(`/api/grid/nodes/${siteId}`);
                const data = await response.json();
                const node = data.node;
                
                document.getElementById('selected-location').innerHTML = `
                    <div class="font-semibold" style="color: #1C0D0E;">${node.name}</div>
                    <div class="text-sm mt-1" style="color: #3D2224;">
                        <div>Lat: ${node.coordinates.latitude.toFixed(3)}, Lon: ${node.coordinates.longitude.toFixed(3)}</div>
                        <div>${node.region} • ${node.state}</div>
                    </div>
                    <div class="mt-3 grid grid-cols-3 gap-2 text-xs">
                        <div>
                            <div style="color: #6D5557;">Clean Gen</div>
                            <div class="font-semibold" style="color: #A3D9A5;">${node.clean_gen}</div>
                        </div>
                        <div>
                            <div style="color: #6D5557;">Transmission</div>
                            <div class="font-semibold" style="color: #9BC4E8;">${node.transmission_headroom}</div>
                        </div>
                        <div>
                            <div style="color: #6D5557;">Reliability</div>
                            <div class="font-semibold" style="color: #B5A3D9;">${node.reliability}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading site info:', error);
            }
        }
        
        // Weight slider updates
        const weightClean = document.getElementById('weight-clean');
        const weightTransmission = document.getElementById('weight-transmission');
        const weightReliability = document.getElementById('weight-reliability');
        
        [weightClean, weightTransmission, weightReliability].forEach(slider => {
            slider.addEventListener('input', updateWeights);
        });
        
        function updateWeights() {
            const clean = parseFloat(weightClean.value);
            const trans = parseFloat(weightTransmission.value);
            const rel = parseFloat(weightReliability.value);
            
            document.getElementById('weight-clean-value').textContent = clean.toFixed(2);
            document.getElementById('weight-transmission-value').textContent = trans.toFixed(2);
            document.getElementById('weight-reliability-value').textContent = rel.toFixed(2);
            
            const sum = clean + trans + rel;
            document.getElementById('weight-sum').textContent = sum.toFixed(2);
            
            const indicator = document.getElementById('weight-sum-indicator');
            if (Math.abs(sum - 1.0) < 0.01) {
                indicator.className = 'mt-3 p-2 rounded text-sm text-center';
                indicator.style.backgroundColor = 'rgba(163, 217, 165, 0.2)';
                indicator.style.color = '#2D5F32';
            } else {
                indicator.className = 'mt-3 p-2 rounded text-sm text-center';
                indicator.style.backgroundColor = 'rgba(206, 152, 157, 0.3)';
                indicator.style.color = '#8B4A4F';
            }
        }
        
        // Evaluate button
        document.getElementById('evaluate-btn').addEventListener('click', evaluateSite);
        
        async function evaluateSite() {
            // Determine if evaluating grid node or custom coordinates
            if (!currentSiteId && !isCustomLocation) {
                alert('No location selected. Please select a site from the map or enter coordinates.');
                return;
            }
            
            // Build request based on location type
            let requestBody, endpoint;
            
            if (isCustomLocation && customCoordinates) {
                // Custom coordinates evaluation
                endpoint = '/api/siting/evaluate-location';
                requestBody = {
                    latitude: customCoordinates.latitude,
                    longitude: customCoordinates.longitude,
                    weight_clean: parseFloat(weightClean.value),
                    weight_transmission: parseFloat(weightTransmission.value),
                    weight_reliability: parseFloat(weightReliability.value),
                    demand_size_mw: parseInt(document.getElementById('demand-size').value),
                    demand_type: document.getElementById('demand-type').value,
                    location_name: `Custom (${customCoordinates.latitude.toFixed(3)}, ${customCoordinates.longitude.toFixed(3)})`
                };
            } else {
                // Grid node evaluation
                endpoint = '/api/siting/evaluate';
                requestBody = {
                    site_id: currentSiteId,
                    weight_clean: parseFloat(weightClean.value),
                    weight_transmission: parseFloat(weightTransmission.value),
                    weight_reliability: parseFloat(weightReliability.value),
                    demand_size_mw: parseInt(document.getElementById('demand-size').value),
                    demand_type: document.getElementById('demand-type').value
                };
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                    return;
                }
                
                currentEvaluation = await response.json();
                displayResults(currentEvaluation);
                
            } catch (error) {
                console.error('Error evaluating site:', error);
                alert('Failed to evaluate site. Please try again.');
            }
        }
        
        function displayResults(evaluation) {
            // Show results container
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('initial-state').classList.add('hidden');
            
            const breakdown = evaluation.score_breakdown;
            
            // Composite score
            document.getElementById('composite-score').textContent = breakdown.composite_score.toFixed(1);
            document.getElementById('percentile-rank').textContent = 
                evaluation.percentile_rank ? `${evaluation.percentile_rank.toFixed(0)}th percentile nationally` : '';
            
            // Breakdown details
            document.getElementById('breakdown-details').innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium" style="color: #2D1517;">Clean Generation</span>
                    <div class="flex items-center gap-2">
                        <span class="text-sm" style="color: #6D5557;">${breakdown.clean_gen_score} × ${breakdown.weights_used.weight_clean.toFixed(2)}</span>
                        <span class="text-lg font-semibold" style="color: #A3D9A5;">${breakdown.clean_gen_contribution.toFixed(1)}</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium" style="color: #2D1517;">Transmission Headroom</span>
                    <div class="flex items-center gap-2">
                        <span class="text-sm" style="color: #6D5557;">${breakdown.transmission_score} × ${breakdown.weights_used.weight_transmission.toFixed(2)}</span>
                        <span class="text-lg font-semibold" style="color: #9BC4E8;">${breakdown.transmission_contribution.toFixed(1)}</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium" style="color: #2D1517;">Grid Reliability</span>
                    <div class="flex items-center gap-2">
                        <span class="text-sm" style="color: #6D5557;">${breakdown.reliability_score} × ${breakdown.weights_used.weight_reliability.toFixed(2)}</span>
                        <span class="text-lg font-semibold" style="color: #B5A3D9;">${breakdown.reliability_contribution.toFixed(1)}</span>
                    </div>
                </div>
            `;
            
            // Chart
            updateChart(breakdown);
            
            // Evaluation notes
            const notesList = document.getElementById('evaluation-notes');
            notesList.innerHTML = evaluation.evaluation_notes.map(note => 
                `<li class="flex items-start"><span class="mr-2">•</span><span>${note}</span></li>`
            ).join('');
            
            // Alternatives
            const altList = document.getElementById('alternatives-list');
            if (evaluation.alternative_sites && evaluation.alternative_sites.length > 0) {
                altList.innerHTML = evaluation.alternative_sites.map(alt => `
                    <div class="p-3 rounded cursor-pointer" style="border: 1px solid rgba(206, 152, 157, 0.3); background-color: rgba(255, 255, 255, 0.5);" 
                         onclick="window.location.href='/framework?site_id=${alt.id}'"
                         onmouseover="this.style.backgroundColor='rgba(206, 152, 157, 0.1)'"
                         onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.5)'">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-medium" style="color: #1C0D0E;">${alt.name}</div>
                                <div class="text-xs" style="color: #6D5557;">${alt.region} • ${alt.state}</div>
                            </div>
                            <div class="text-lg font-semibold" style="color: #CE989D;">${alt.composite_score.toFixed(1)}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                altList.innerHTML = '<p class="text-sm" style="color: #6D5557;">No alternatives available</p>';
            }
            
            // Nearby Power Plants
            const plantsList = document.getElementById('nearby-plants-list');
            if (evaluation.nearby_power_plants && evaluation.nearby_power_plants.length > 0) {
                // Group plants by clean vs non-clean
                const cleanPlants = evaluation.nearby_power_plants.filter(p => p.is_clean);
                const otherPlants = evaluation.nearby_power_plants.filter(p => !p.is_clean);
                
                let plantsHTML = '';
                
                // Show clean plants first
                if (cleanPlants.length > 0) {
                    plantsHTML += '<div class="mb-3"><div class="text-xs font-semibold mb-2" style="color: #A3D9A5;">Clean Energy Plants</div>';
                    plantsHTML += cleanPlants.map(plant => `
                        <div class="p-2 rounded mb-1.5 text-xs" style="border: 1px solid rgba(163, 217, 165, 0.4); background-color: rgba(163, 217, 165, 0.1);">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium" style="color: #1C0D0E;">${plant.plant_name}</div>
                                    <div class="mt-0.5" style="color: #3D2224;">
                                        <span class="font-medium">${plant.primary_fuel_category}</span>
                                        <span class="mx-1">•</span>
                                        <span>${plant.nameplate_mw.toFixed(0)} MW</span>
                                        <span class="mx-1">•</span>
                                        <span>${plant.distance_km.toFixed(1)} km away</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    plantsHTML += '</div>';
                }
                
                // Show other plants (transmission infrastructure)
                if (otherPlants.length > 0) {
                    plantsHTML += '<div><div class="text-xs font-semibold mb-2" style="color: #9BC4E8;">Transmission Infrastructure</div>';
                    plantsHTML += otherPlants.slice(0, 10).map(plant => `
                        <div class="p-2 rounded mb-1.5 text-xs" style="border: 1px solid rgba(206, 152, 157, 0.3); background-color: rgba(141, 126, 128, 0.1);">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="font-medium" style="color: #1C0D0E;">${plant.plant_name}</div>
                                    <div class="mt-0.5" style="color: #3D2224;">
                                        <span class="font-medium">${plant.primary_fuel_category}</span>
                                        <span class="mx-1">•</span>
                                        <span>${plant.nameplate_mw.toFixed(0)} MW</span>
                                        <span class="mx-1">•</span>
                                        <span>${plant.distance_km.toFixed(1)} km away</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    if (otherPlants.length > 10) {
                        plantsHTML += `<div class="text-xs mt-2" style="color: #6D5557;">+ ${otherPlants.length - 10} more plants</div>`;
                    }
                    plantsHTML += '</div>';
                }
                
                plantsList.innerHTML = plantsHTML;
            } else {
                plantsList.innerHTML = '<p class="text-sm" style="color: #6D5557;">No power plants found within 200km</p>';
            }
        }
        
        function updateChart(breakdown) {
            const ctx = document.getElementById('criteria-chart');
            
            if (criteriaChart) {
                criteriaChart.destroy();
            }
            
            criteriaChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Clean Generation', 'Transmission Headroom', 'Grid Reliability'],
                    datasets: [{
                        label: 'Current Site',
                        data: [
                            breakdown.clean_gen_score,
                            breakdown.transmission_score,
                            breakdown.reliability_score
                        ],
                        fill: true,
                        backgroundColor: 'rgba(206, 152, 157, 0.2)',
                        borderColor: '#CE989D',
                        pointBackgroundColor: '#CE989D',
                        pointBorderColor: '#F3E7E8',
                        pointHoverBackgroundColor: '#F3E7E8',
                        pointHoverBorderColor: '#CE989D'
                    }]
                },
                options: {
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    },
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });
        }
        
        // Save scenario
        document.getElementById('save-scenario-btn').addEventListener('click', async () => {
            if (!currentEvaluation) {
                alert('No evaluation to save. Please evaluate a site first.');
                return;
            }
            
            try {
                const response = await fetch('/api/siting/scenarios/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentEvaluation)
                });
                
                const result = await response.json();
                alert(`Scenario saved! Total saved: ${result.total_saved}`);
            } catch (error) {
                console.error('Error saving scenario:', error);
                alert('Failed to save scenario.');
            }
        });
        
        // Compare scenarios
        document.getElementById('compare-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/siting/scenarios');
                const data = await response.json();
                
                if (data.scenarios.length === 0) {
                    alert('No scenarios saved yet. Evaluate and save some sites first.');
                    return;
                }
                
                showComparisonModal(data.scenarios);
            } catch (error) {
                console.error('Error loading scenarios:', error);
            }
        });
        
        function showComparisonModal(scenarios) {
            const modal = document.getElementById('comparison-modal');
            const content = document.getElementById('comparison-content');
            
            content.innerHTML = `
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Site Name</th>
                            <th class="px-4 py-2 text-center">Composite Score</th>
                            <th class="px-4 py-2 text-center">Clean Gen</th>
                            <th class="px-4 py-2 text-center">Transmission</th>
                            <th class="px-4 py-2 text-center">Reliability</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scenarios.map(s => `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2">${s.site.name}</td>
                                <td class="px-4 py-2 text-center font-semibold text-blue-600">${s.score_breakdown.composite_score.toFixed(1)}</td>
                                <td class="px-4 py-2 text-center">${s.score_breakdown.clean_gen_contribution.toFixed(1)}</td>
                                <td class="px-4 py-2 text-center">${s.score_breakdown.transmission_contribution.toFixed(1)}</td>
                                <td class="px-4 py-2 text-center">${s.score_breakdown.reliability_contribution.toFixed(1)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        document.getElementById('close-modal').addEventListener('click', () => {
            const modal = document.getElementById('comparison-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
        
        // Manual input toggle
        document.getElementById('manual-input-toggle').addEventListener('click', () => {
            const manualInput = document.getElementById('manual-input');
            manualInput.classList.toggle('hidden');
        });
    </script>
</body>
</html>
